<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crownex - Nạp Rút</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* CORE */
        html, body { touch-action: pan-x pan-y; overscroll-behavior: none; height: 100%; overflow: hidden; background-color: #0b0f19; }
        body { color: #d1d5db; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; }
        .font-mono { font-family: 'IBM Plex Mono', monospace; }

        /* SIDEBAR */
        #sidebar { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .menu-item { display: flex; items-center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: #9ca3af; font-weight: 500; font-size: 14px; transition: all 0.2s; }
        .menu-item:active { background: #1e232e; color: white; }
        .menu-item.active { background: #1e232e; color: #FCD535; border: 1px solid #2d3442; }
        .menu-item i { width: 20px; text-align: center; }

        /* TABS */
        .tab-btn { flex: 1; text-align: center; padding: 12px; font-size: 13px; font-weight: bold; color: #6b7280; border-bottom: 2px solid #2d3442; transition: 0.3s; }
        .tab-btn.active { color: #FCD535; border-bottom-color: #FCD535; background: rgba(252, 213, 53, 0.05); }

        /* UI ELEMENTS */
        .input-dark { width: 100%; background: #0b0f19; border: 1px solid #2d3442; color: #fff; padding: 12px; border-radius: 8px; font-size: 14px; transition: 0.2s; }
        .input-dark:focus { border-color: #FCD535; outline: none; }
        
        .btn-action { width: 100%; padding: 14px; border-radius: 10px; font-weight: bold; font-size: 14px; margin-top: 10px; transition: 0.2s; text-transform: uppercase; }
        .btn-deposit { background: #0ECB81; color: white; box-shadow: 0 4px 10px rgba(14, 203, 129, 0.2); }
        .btn-withdraw { background: #F6465D; color: white; box-shadow: 0 4px 10px rgba(246, 70, 93, 0.2); }
        .btn-action:active { transform: scale(0.98); }

        /* PROGRESS & FILTERS */
        .progress-bg { width: 100%; height: 6px; background: #2d3442; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #FCD535, #ff9f43); transition: width 0.5s ease; }
        
        .filter-chip { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; background: #1e232e; border: 1px solid #2d3442; color: #9ca3af; transition: 0.2s; cursor: pointer; white-space: nowrap; }
        .filter-chip.active { background: #FCD535; color: #111; border-color: #FCD535; }

        /* STATUS BADGE */
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: rgba(252, 213, 53, 0.15); color: #FCD535; }
        .badge-success { background: rgba(14, 203, 129, 0.15); color: #0ECB81; }
        .badge-reject { background: rgba(246, 70, 93, 0.15); color: #F6465D; }

        /* SKELETON */
        .skeleton { background: linear-gradient(90deg, #1e232e 25%, #2a303c 50%, #1e232e 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-item { height: 60px; margin-bottom: 12px; width: 100%; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* New Item Highlight */
        .new-item { animation: highlight 1s ease-out; }
        @keyframes highlight { 0% { background-color: rgba(252, 213, 53, 0.2); } 100% { background-color: #1e232e; } }
    </style>

    <!-- UI SCRIPTS -->
    <script>
        function toggleMenu() {
            const sb = document.getElementById('sidebar'); 
            const ov = document.getElementById('sidebarOverlay');
            if (sb.classList.contains('-translate-x-full')) { 
                sb.classList.remove('-translate-x-full'); 
                ov.classList.remove('hidden', 'opacity-0'); 
            } else { 
                sb.classList.add('-translate-x-full'); 
                ov.classList.add('opacity-0'); 
                setTimeout(()=>ov.classList.add('hidden'),300); 
            }
        }

        function switchTab(tab) {
            ['deposit', 'withdraw', 'history'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                const btn = document.querySelectorAll('.tab-btn')[['deposit', 'withdraw', 'history'].indexOf(t)];
                if(btn) btn.classList.remove('active');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            const targetBtn = document.querySelectorAll('.tab-btn')[['deposit', 'withdraw', 'history'].indexOf(tab)];
            if(targetBtn) targetBtn.classList.add('active');
        }

        function copyText(text) { 
            navigator.clipboard.writeText(text); 
            alert("Đã sao chép: " + text); 
        }
    </script>
</head>
<body>

    <!-- SIDEBAR -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/80 z-40 hidden opacity-0 transition-opacity duration-300" onclick="toggleMenu()"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-[80%] max-w-xs h-full bg-[#13161f] z-50 transform -translate-x-full shadow-2xl border-r border-[#232836] flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-[#232836] bg-[#171b26]">
            <div class="w-8 h-8 rounded bg-[#FCD535] flex items-center justify-center text-black font-bold text-xl rounded-bl-none mr-3">C</div>
            <span class="font-bold text-lg text-white">CROWNEX</span>
            <button onclick="toggleMenu()" class="ml-auto text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <a href="game.html" class="menu-item"><i class="fa-solid fa-chart-line"></i> Giao dịch</a>
            <a href="taikhoan.html" class="menu-item"><i class="fa-solid fa-user-gear"></i> Tài khoản</a>
            <a href="naprut.html" class="menu-item active"><i class="fa-solid fa-money-bill-transfer"></i> Nạp / Rút tiền</a>
            <a href="lichsu.html" class="menu-item"><i class="fa-solid fa-clock-rotate-left"></i> Lịch sử cược</a>
            <a href="khuyenmai.html" class="menu-item"><i class="fa-solid fa-gift"></i> Khuyến mãi</a>
            
            <div class="border-t border-[#232836] my-2 mx-2"></div>
            <!-- MỤC CSKH ĐẦY ĐỦ -->
            <a href="https://t.me/ad_crownex" target="_blank" class="menu-item text-blue-400"><i class="fa-brands fa-telegram text-lg"></i> CSKH (Telegram)</a>
            <a href="#" onclick="window.logoutModule()" class="menu-item text-red-400 mt-4"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a>
        </nav>
        <div class="p-4 border-t border-[#232836] bg-[#12141c]">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 flex items-center justify-center font-bold text-xs shadow-lg text-white">U</div>
                <div class="flex flex-col"><span class="text-xs font-bold text-white" id="sidebarUsername">Loading...</span><span class="text-[10px] text-green-500 flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Online</span></div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="flex items-center justify-between px-4 h-14 bg-[#13161f] border-b border-[#232836] sticky top-0 z-20">
        <div class="flex items-center gap-4">
            <button onclick="toggleMenu()" class="text-[#9ca3af] hover:text-white transition"><i class="fa-solid fa-bars-staggered text-xl"></i></button>
            <span class="text-white font-bold text-lg tracking-wide">VÍ TIỀN</span>
        </div>
        <div class="bg-[#1e232e] px-3 py-1.5 rounded-lg border border-[#2d3442] flex items-center gap-2">
            <i class="fa-solid fa-wallet text-[#FCD535] text-xs"></i>
            <span class="font-mono font-bold text-white text-sm" id="headerBalance">$0.00</span>
        </div>
    </header>

    <!-- TABS -->
    <div class="flex bg-[#13161f] border-b border-[#2d3442]">
        <div class="tab-btn active" onclick="switchTab('deposit')">NẠP TIỀN</div>
        <div class="tab-btn" onclick="switchTab('withdraw')">RÚT TIỀN</div>
        <div class="tab-btn" onclick="switchTab('history')">LỊCH SỬ</div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 pb-10">
        
        <!-- TAB 1: NẠP TIỀN -->
        <div id="tab-deposit" class="fade-in">
            <div class="bg-[#1e232e] p-5 rounded-xl border border-[#2d3442] flex flex-col items-center mb-6 shadow-lg">
                <div class="bg-white p-2 rounded-lg mb-4">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=00020101021238570010A0000007270127000697042201132026290121520208QRIBFTTA53037045802VN5913NGUYEN VAN A6005HANOI62110707TEST12363041234" alt="QR Code" class="w-32 h-32">
                </div>
                
                <div class="w-full space-y-2">
                    <div class="w-full bg-[#0b0f19] p-3 rounded border border-[#2d3442] flex justify-between items-center cursor-pointer" onclick="copyText('BVBank (Bản Việt)')">
                        <div class="flex flex-col"><span class="text-[10px] text-gray-500 uppercase">Ngân hàng</span><span class="text-sm text-white font-bold">BVBank (Bản Việt)</span></div>
                        <span class="text-xs text-[#FCD535] font-bold"><i class="fa-regular fa-copy mr-1"></i>Copy</span>
                    </div>
                    
                    <div class="w-full bg-[#0b0f19] p-3 rounded border border-[#2d3442] flex justify-between items-center cursor-pointer" onclick="copyText('99MM25740M76308618')">
                        <div class="flex flex-col"><span class="text-[10px] text-gray-500 uppercase">Số tài khoản</span><span class="text-sm text-white font-mono font-bold tracking-wider">99MM25740M76308618</span></div>
                        <span class="text-xs text-[#FCD535] font-bold"><i class="fa-regular fa-copy mr-1"></i>Copy</span>
                    </div>

                    <div class="w-full bg-[#2a2f3d] p-4 rounded-xl border-2 border-[#FCD535] flex justify-between items-center cursor-pointer relative overflow-hidden active:scale-95 transition-transform" onclick="copyText(document.getElementById('depositContent').innerText)">
                        <div class="absolute top-0 right-0 bg-[#FCD535] text-black text-[9px] font-bold px-2 py-0.5 rounded-bl">BẮT BUỘC</div>
                        <div class="flex flex-col z-10">
                            <span class="text-[10px] text-[#FCD535] uppercase font-bold mb-1">Nội dung chuyển khoản</span>
                            <span class="text-xl text-white font-mono font-black tracking-widest" id="depositContent">...</span>
                        </div>
                        <i class="fa-regular fa-copy text-[#FCD535] text-xl z-10"></i>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="text-xs text-gray-400 font-bold uppercase mb-1 block">Nhập số tiền đã chuyển ($)</label>
                <input type="number" id="depositAmount" class="input-dark font-mono font-bold text-[#FCD535]" placeholder="Ví dụ: 100">
            </div>
            
            <button onclick="window.createDeposit()" class="btn-action btn-deposit"><i class="fa-solid fa-paper-plane mr-2"></i> TẠO LỆNH NẠP</button>
            <p class="text-[10px] text-gray-500 mt-3 text-center italic">* Vui lòng chuyển khoản chính xác nội dung để được cộng tiền tự động.</p>
        </div>

        <!-- TAB 2: RÚT TIỀN -->
        <div id="tab-withdraw" class="hidden fade-in">
            <!-- Cảnh báo chưa liên kết -->
            <div id="noBankAlert" class="hidden bg-red-500/10 border border-red-500/50 p-4 rounded-xl mb-4 text-center">
                <i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl mb-2"></i>
                <div class="text-white font-bold text-sm mb-2">CHƯA LIÊN KẾT NGÂN HÀNG</div>
                <a href="taikhoan.html" class="inline-block bg-red-500 text-white text-xs font-bold px-4 py-2 rounded-lg">Cập nhật ngay</a>
            </div>

            <!-- Form Rút (Hiện khi đã liên kết) -->
            <div id="withdrawForm">
                <div class="bg-[#1e232e] p-4 rounded-xl border border-[#2d3442] mb-6">
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-xs text-gray-400 font-bold uppercase"><i class="fa-solid fa-rotate mr-1"></i> Vòng cược yêu cầu</span>
                        <span class="text-xs font-mono text-white"><span id="currentTurnover">0</span> / <span id="requiredTurnover">0</span></span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" style="width: 0%" id="turnoverBar"></div></div>
                    <p class="text-[10px] text-gray-500 mt-2 italic" id="turnoverNote">* Bạn cần hoàn thành vòng cược để rút tiền.</p>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">Ngân hàng</label><input type="text" id="wdBankName" class="input-dark bg-[#171b26] text-gray-400 cursor-not-allowed text-xs" readonly></div>
                        <div><label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">Chủ tài khoản</label><input type="text" id="wdBankOwner" class="input-dark bg-[#171b26] text-gray-400 cursor-not-allowed text-xs" readonly></div>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">Số tài khoản</label>
                        <input type="text" id="wdBankNumber" class="input-dark bg-[#171b26] font-mono text-[#FCD535] cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 font-bold uppercase mb-1 block">Số tiền rút ($)</label>
                        <div class="relative">
                            <input type="number" id="wdAmount" class="input-dark font-mono font-bold pr-16" placeholder="Tối thiểu $5">
                            <button onclick="window.setMaxWithdraw()" class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] bg-[#2d3442] text-[#FCD535] px-2 py-1 rounded font-bold hover:bg-[#374151]">MAX</button>
                        </div>
                    </div>
                </div>

                <button onclick="window.createWithdraw()" class="btn-action btn-withdraw mt-6"><i class="fa-solid fa-money-bill-transfer mr-2"></i> YÊU CẦU RÚT TIỀN</button>
            </div>
        </div>

        <!-- TAB 3: LỊCH SỬ -->
        <div id="tab-history" class="hidden fade-in">
            <!-- Filter Chips -->
            <div class="flex gap-2 mb-4 overflow-x-auto pb-1 no-scrollbar">
                <div class="filter-chip active" onclick="window.filterHistory('all', this)">Tất cả</div>
                <div class="filter-chip" onclick="window.filterHistory('deposit', this)">Nạp tiền</div>
                <div class="filter-chip" onclick="window.filterHistory('withdraw', this)">Rút tiền</div>
                <div class="filter-chip" onclick="window.filterHistory('other', this)">Khác</div>
            </div>

            <div id="historyList" class="space-y-3 pb-safe">
                <div class="skeleton skeleton-item"></div>
                <div class="skeleton skeleton-item"></div>
                <div class="skeleton skeleton-item"></div>
            </div>
            <div id="historyError" class="hidden text-center text-red-500 text-[10px] mt-4">Lỗi tải dữ liệu.</div>
        </div>

    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, addDoc, collection, query, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU",
            authDomain: "btccoinbig.firebaseapp.com",
            projectId: "btccoinbig",
            storageBucket: "btccoinbig.firebasestorage.app",
            messagingSenderId: "116892525933",
            appId: "1:116892525933:web:04b0da25f3f933ce162664"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let userData = null;
        let allHistory = []; // Cache toàn bộ lịch sử để filter
        let unsubscribeHistory = null;
        let realBankNumber = "";
        let SETTINGS = { minDeposit: 10, minWithdraw: 5 };

        // --- PUBLIC FUNCTIONS (Gắn vào window) ---
        window.logoutModule = () => { signOut(auth).then(() => window.location.href = "login.html"); };

        window.setMaxWithdraw = () => {
            if(userData) document.getElementById('wdAmount').value = Math.floor(userData.balance);
        };

        window.filterHistory = (type, el) => {
            // Update UI Chip
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            // Filter Data
            renderHistoryList(type);
        };

        window.createDeposit = async () => {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            if (!amount || amount < SETTINGS.minDeposit) return alert(`Tối thiểu nạp $${SETTINGS.minDeposit}`);
            
            const btn = document.querySelector('.btn-deposit');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const payload = {
                    type: 'deposit', amount: amount, status: 'pending',
                    userId: currentUser.uid, username: userData.username || 'Unknown',
                    content: userData.username ? userData.username.toUpperCase() : '',
                    timestamp: serverTimestamp()
                };
                await addDoc(collection(db, "users", currentUser.uid, "transactions"), payload);
                await addDoc(collection(db, "admin_requests"), payload);
                alert("Đã tạo lệnh nạp! Vui lòng chờ hệ thống xác nhận.");
                document.getElementById('depositAmount').value = "";
                switchTab('history');
            } catch (e) { alert("Lỗi: " + e.message); } 
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> TẠO LỆNH NẠP'; }
        };

        window.createWithdraw = async () => {
            const amount = parseFloat(document.getElementById('wdAmount').value);
            if (!realBankNumber) return alert("Vui lòng liên kết ngân hàng trước!");
            if (!amount || amount < SETTINGS.minWithdraw) return alert(`Tối thiểu rút $${SETTINGS.minWithdraw}`);
            if (amount > userData.balance) return alert("Số dư không đủ!");
            if ((userData.requiredTurnover || 0) > 0) return alert("Chưa đủ vòng cược!");

            const btn = document.querySelector('.btn-withdraw');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const payload = {
                    type: 'withdraw', amount: amount, status: 'pending',
                    bankInfo: `${userData.bankName} - ${realBankNumber} - ${userData.bankOwner}`,
                    userId: currentUser.uid, username: userData.username || 'Unknown',
                    timestamp: serverTimestamp()
                };
                await updateDoc(doc(db, "users", currentUser.uid), { balance: userData.balance - amount });
                await addDoc(collection(db, "users", currentUser.uid, "transactions"), payload);
                await addDoc(collection(db, "admin_requests"), payload);
                alert("Đã gửi yêu cầu rút tiền!");
                document.getElementById('wdAmount').value = "";
                switchTab('history');
            } catch (e) { alert("Lỗi: " + e.message); } 
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-money-bill-transfer mr-2"></i> YÊU CẦU RÚT TIỀN'; }
        };

        // --- AUTH & DATA LISTENER ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                
                // 1. Lấy Settings
                onSnapshot(doc(db, "settings", "global"), (doc) => {
                    if(doc.exists()) {
                        const d = doc.data();
                        if(d.minDeposit) SETTINGS.minDeposit = d.minDeposit;
                        if(d.minWithdraw) SETTINGS.minWithdraw = d.minWithdraw;
                        document.getElementById('depositAmount').placeholder = `Tối thiểu $${SETTINGS.minDeposit}`;
                        document.getElementById('wdAmount').placeholder = `Tối thiểu $${SETTINGS.minWithdraw}`;
                    }
                });

                // 2. Lấy User Data
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if(docSnap.exists()) {
                        userData = docSnap.data();
                        renderUserData(userData);
                        checkAutoResetTurnover(userData);
                    }
                });

                // 3. Lấy History (Chỉ gọi 1 lần khi load app)
                setupHistoryListener(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // --- LOGIC FUNCTIONS ---
        function checkAutoResetTurnover(data) {
            const cur = data.betTurnover || 0;
            const req = data.requiredTurnover || 0;
            if (req > 0 && cur >= req) {
                updateDoc(doc(db, "users", currentUser.uid), { betTurnover: 0, requiredTurnover: 0 });
            }
        }

        function renderUserData(data) {
            document.getElementById('sidebarUsername').innerText = data.fullName || data.username || "Thành viên";
            document.getElementById('headerBalance').innerText = "$" + (data.balance || 0).toLocaleString();
            document.getElementById('depositContent').innerText = data.username ? data.username.toUpperCase() : "...";
            
            if (data.bankNumber) {
                realBankNumber = data.bankNumber;
                document.getElementById('noBankAlert').classList.add('hidden');
                document.getElementById('withdrawForm').classList.remove('hidden');
                document.getElementById('wdBankName').value = data.bankName || "";
                document.getElementById('wdBankOwner').value = data.bankOwner || "";
                let maskedBn = data.bankNumber;
                if(maskedBn && maskedBn.length > 3) maskedBn = "******" + maskedBn.slice(-3);
                document.getElementById('wdBankNumber').value = maskedBn;
            } else {
                realBankNumber = "";
                document.getElementById('noBankAlert').classList.remove('hidden');
                document.getElementById('withdrawForm').classList.add('hidden');
            }

            const current = data.betTurnover || 0; 
            const required = data.requiredTurnover || 0; 
            document.getElementById('currentTurnover').innerText = current.toLocaleString();
            document.getElementById('requiredTurnover').innerText = required.toLocaleString();
            let percent = required > 0 ? (current / required) * 100 : 100;
            if(percent > 100) percent = 100;
            document.getElementById('turnoverBar').style.width = percent + "%";
            
            if (required === 0) {
                document.getElementById('turnoverBar').style.background = "#0ECB81"; 
                document.getElementById('turnoverNote').innerHTML = '<span class="text-[#0ECB81] font-bold"><i class="fa-solid fa-check-circle"></i> Đủ điều kiện rút tiền</span>';
            } else {
                document.getElementById('turnoverBar').style.background = "linear-gradient(90deg, #FCD535, #ff9f43)";
                document.getElementById('turnoverNote').innerText = "* Bạn cần hoàn thành vòng cược để rút tiền.";
            }
        }

        // --- HISTORY LISTENER (REALTIME FIX) ---
        function setupHistoryListener(uid) {
            if(unsubscribeHistory) unsubscribeHistory();
            
            // XÓA LIMIT ĐỂ ĐẢM BẢO LẤY HẾT DATA VÀ SORT ĐÚNG
            // THÊM includeMetadataChanges: true ĐỂ BẮT GIAO DỊCH LOCAL NGAY LẬP TỨC
            const q = collection(db, "users", uid, "transactions");

            unsubscribeHistory = onSnapshot(q, { includeMetadataChanges: true }, (snapshot) => {
                document.getElementById('historyError').classList.add('hidden');
                allHistory = [];
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    // Fix lỗi timestamp null của local cache
                    if (!d.timestamp) d.timestamp = { seconds: Date.now() / 1000 }; 
                    allHistory.push(d);
                });
                
                // Sort Client-side: Mới nhất lên đầu
                allHistory.sort((a, b) => {
                    const tA = a.timestamp?.seconds || 0;
                    const tB = b.timestamp?.seconds || 0;
                    return tB - tA;
                });

                // Render mặc định: All
                renderHistoryList('all');
            }, (error) => {
                console.error(error);
                document.getElementById('historyList').innerHTML = '';
                document.getElementById('historyError').classList.remove('hidden');
            });
        }

        function renderHistoryList(filterType) {
            const listEl = document.getElementById('historyList');
            const itemsToShow = allHistory.filter(item => {
                if (filterType === 'all') return true;
                if (filterType === 'deposit') return item.type === 'deposit';
                if (filterType === 'withdraw') return item.type === 'withdraw';
                if (filterType === 'other') return ['giftcode', 'attendance', 'refund', 'bonus', 'newbie'].includes(item.type);
                return true;
            });

            if (itemsToShow.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500 text-xs mt-10">Chưa có giao dịch nào</div>';
                return;
            }

            let html = '';
            // Chỉ hiện tối đa 50 giao dịch sau khi sort để tránh lag DOM
            itemsToShow.slice(0, 50).forEach(data => {
                let timeStr = "Vừa xong";
                if (data.timestamp && data.timestamp.seconds) {
                    timeStr = new Date(data.timestamp.seconds * 1000).toLocaleString('vi-VN');
                }
                
                let typeText = 'GIAO DỊCH'; let typeIcon = 'fa-circle'; let colorClass = 'text-white'; let amountSign = '+';
                
                switch(data.type) {
                    case 'deposit': typeText = 'NẠP TIỀN'; typeIcon = 'fa-arrow-down'; colorClass = 'text-[#0ECB81]'; break;
                    case 'withdraw': typeText = 'RÚT TIỀN'; typeIcon = 'fa-arrow-up'; colorClass = 'text-[#F6465D]'; amountSign = '-'; break;
                    case 'giftcode': typeText = 'GIFTCODE'; typeIcon = 'fa-ticket'; colorClass = 'text-[#FCD535]'; break;
                    case 'attendance': typeText = 'ĐIỂM DANH'; typeIcon = 'fa-calendar-check'; colorClass = 'text-blue-400'; break;
                    case 'refund': typeText = 'HOÀN TRẢ'; typeIcon = 'fa-rotate-left'; colorClass = 'text-purple-400'; break;
                    case 'bonus': case 'newbie': typeText = 'THƯỞNG'; typeIcon = 'fa-gift'; colorClass = 'text-pink-400'; break;
                }

                let badgeClass = 'badge-pending'; let statusText = 'ĐANG XỬ LÝ'; let statusIcon = 'fa-clock';
                if (data.status === 'success') { badgeClass = 'badge-success'; statusText = 'THÀNH CÔNG'; statusIcon = 'fa-check'; }
                else if (data.status === 'rejected' || data.status === 'failed') { badgeClass = 'badge-reject'; statusText = 'TỪ CHỐI'; statusIcon = 'fa-xmark'; }

                // Highlight item mới
                const isNew = (Date.now() / 1000 - data.timestamp.seconds) < 5 ? 'new-item' : '';

                html += `
                    <div class="bg-[#1e232e] p-3 rounded-lg border border-[#2d3442] flex justify-between items-center ${isNew} transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-[#232836] ${colorClass} bg-opacity-10 border border-white/5">
                                <i class="fa-solid ${typeIcon}"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm text-white uppercase">${typeText}</div>
                                <div class="text-[10px] text-gray-500 font-mono">${timeStr}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold text-sm ${colorClass}">
                                ${amountSign}$${parseFloat(data.amount).toLocaleString()}
                            </div>
                            <span class="badge ${badgeClass} mt-1 inline-block"><i class="fa-solid ${statusIcon} mr-1"></i>${statusText}</span>
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }
    </script>
</body>
</html>

