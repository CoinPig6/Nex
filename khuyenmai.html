<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crownex - Khuyến Mãi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* CSS CORE */
        html, body { touch-action: pan-x pan-y; overscroll-behavior: none; height: 100%; background-color: #0b0f19; }
        body { color: #d1d5db; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; }
        .font-mono { font-family: 'IBM Plex Mono', monospace; }

        /* SIDEBAR */
        #sidebar { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .menu-item { display: flex; items-center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: #9ca3af; font-weight: 500; font-size: 14px; transition: all 0.2s; }
        .menu-item:active { background: #1e232e; color: white; }
        .menu-item.active { background: #1e232e; color: #FCD535; border: 1px solid #2d3442; }
        .menu-item i { width: 20px; text-align: center; }

        /* PROMO CARDS */
        .promo-card { 
            background: linear-gradient(145deg, #13161f, #171b26); 
            border: 1px solid #2d3442; border-radius: 12px; 
            overflow: hidden; margin-bottom: 16px; position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .promo-tag {
            position: absolute; top: 0; right: 0;
            background: #F6465D; color: white;
            font-size: 9px; font-weight: bold;
            padding: 4px 8px; border-bottom-left-radius: 8px;
        }
        
        .btn-claim { 
            background: #0ECB81; color: white; border-radius: 6px; 
            padding: 8px 12px; font-size: 11px; font-weight: bold; 
            text-transform: uppercase; transition: 0.2s; min-width: 90px;
            text-align: center; display: inline-block;
        }
        .btn-claim.pending { background: #F59E0B; color: black; cursor: wait; }
        .btn-claim:active { transform: scale(0.95); }
        .btn-claim:disabled { background: #2d3442; color: #6b7280; cursor: not-allowed; transform: none; }

        /* GIFTCODE INPUT */
        .input-code { 
            width: 100%; background: #0b0f19; border: 1px solid #2d3442; color: #FCD535; 
            padding: 12px; border-radius: 8px; font-family: 'IBM Plex Mono', monospace; 
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold; text-align: center;
        }
        .input-code:focus { border-color: #FCD535; outline: none; box-shadow: 0 0 0 2px rgba(252, 213, 53, 0.2); }
        .btn-redeem { 
            width: 100%; background: #FCD535; color: #111; font-weight: bold; 
            padding: 12px; border-radius: 8px; margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(252, 213, 53, 0.2); transition: 0.2s; 
        }
        .btn-redeem:active { transform: scale(0.98); }

        /* ATTENDANCE 7 DAYS */
        .step-container { display: flex; justify-content: space-between; margin-top: 15px; position: relative; padding: 0 5px; }
        .step-line { position: absolute; top: 10px; left: 10px; right: 10px; height: 2px; background: #2d3442; z-index: 0; }
        .step-item { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; width: 14%; }
        .step-circle { width: 20px; height: 20px; border-radius: 50%; background: #1e232e; border: 2px solid #2d3442; color: #6b7280; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; }
        
        .step-item.active .step-circle { background: #FCD535; border-color: #FCD535; color: #111; box-shadow: 0 0 8px rgba(252, 213, 53, 0.4); transform: scale(1.2); }
        .step-item.checked .step-circle { background: #0ECB81; border-color: #0ECB81; color: white; }
        .reward-text { font-size: 9px; font-weight: bold; color: #6b7280; margin-top: 4px; font-family: 'IBM Plex Mono', monospace; }
        .step-item.active .reward-text { color: #FCD535; }
        .step-item.checked .reward-text { color: #0ECB81; }

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #1e232e; border: 1px solid #2d3442; padding: 10px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; opacity: 0; transition: all 0.4s; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #toast.error i { color: #F6465D; } #toast.success i { color: #0ECB81; }
    </style>
</head>
<body>

    <!-- TOAST -->
    <div id="toast"><i class="fa-solid fa-circle-check text-lg"></i><span class="text-sm font-bold text-white" id="toastMsg">...</span></div>

    <!-- SIDEBAR -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/80 z-40 hidden opacity-0 transition-opacity duration-300" onclick="toggleMenu()"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-[80%] max-w-xs h-full bg-[#13161f] z-50 transform -translate-x-full shadow-2xl border-r border-[#232836] flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-[#232836] bg-[#171b26]">
            <div class="w-8 h-8 rounded bg-[#FCD535] flex items-center justify-center text-black font-bold text-xl rounded-bl-none mr-3">C</div>
            <span class="font-bold text-lg text-white">CROWNEX</span>
            <button onclick="toggleMenu()" class="ml-auto text-gray-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <a href="game.html" class="menu-item"><i class="fa-solid fa-chart-line"></i> Giao dịch</a>
            <a href="taikhoan.html" class="menu-item"><i class="fa-solid fa-user-gear"></i> Tài khoản</a>
            <a href="naprut.html" class="menu-item"><i class="fa-solid fa-money-bill-transfer"></i> Nạp / Rút tiền</a>
            <a href="lichsu.html" class="menu-item"><i class="fa-solid fa-clock-rotate-left"></i> Lịch sử cược</a>
            <a href="khuyenmai.html" class="menu-item active"><i class="fa-solid fa-gift"></i> Khuyến mãi <span class="ml-auto bg-[#F6465D] text-white text-[10px] px-1.5 rounded font-bold">HOT</span></a>
            <div class="border-t border-[#232836] my-2 mx-2"></div>
            <a href="https://t.me/ad_crownex" target="_blank" class="menu-item text-blue-400"><i class="fa-brands fa-telegram text-lg"></i> CSKH (Telegram)</a>
            <a href="#" onclick="logout()" class="menu-item text-red-400 mt-4"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a>
        </nav>
        <div class="p-4 border-t border-[#232836] bg-[#12141c]">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 flex items-center justify-center font-bold text-xs shadow-lg text-white">U</div>
                <div class="flex flex-col"><span class="text-xs font-bold text-white" id="sidebarUsername">User...</span><span class="text-[10px] text-green-500 flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Online</span></div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="flex items-center px-4 h-14 bg-[#13161f] border-b border-[#232836] sticky top-0 z-20">
        <button onclick="toggleMenu()" class="mr-4"><i class="fa-solid fa-bars-staggered text-xl text-[#9ca3af]"></i></button>
        <h1 class="flex-1 text-center font-bold text-white text-lg tracking-wide">TRUNG TÂM SỰ KIỆN</h1>
        <div class="w-8"></div>
    </header>

    <div class="p-4 flex-1 overflow-y-auto pb-10">
        
        <!-- === 1. NHẬP GIFTCODE === -->
        <div class="bg-[#1e232e] p-5 rounded-xl border border-[#FCD535] border-dashed mb-6 relative overflow-hidden shadow-lg">
            <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FCD535] opacity-20 rounded-full blur-xl"></div>
            <h3 class="text-sm font-bold text-[#FCD535] mb-3 flex items-center gap-2">
                <i class="fa-solid fa-ticket"></i> NHẬP GIFTCODE
            </h3>
            <input type="text" id="giftcodeInput" class="input-code" placeholder="MÃ NHẬN THƯỞNG">
            <button onclick="redeemCode()" class="btn-redeem" id="btnRedeem">ĐỔI QUÀ NGAY</button>
        </div>

        <!-- === 2. ĐIỂM DANH 7 NGÀY === -->
        <div class="promo-card p-4">
            <div class="flex gap-3 mb-3">
                <div class="w-10 h-10 bg-[#0ECB81]/10 rounded-full flex items-center justify-center text-[#0ECB81] text-xl">
                    <i class="fa-solid fa-calendar-check"></i>
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm">Điểm Danh 7 Ngày ($25)</h3>
                    <p class="text-[10px] text-gray-400">00:00 Làm mới nhiệm vụ.</p>
                </div>
            </div>

            <!-- Steps 7 Days -->
            <div class="step-container mb-4" id="attendanceSteps">
                <div class="step-line"></div>
                <!-- Rendered by JS -->
            </div>

            <div class="flex justify-between text-[10px] text-gray-400 mb-2 px-2 border-t border-[#2d3442] pt-2">
                <span>Nạp hôm nay: <b id="progressDep" class="text-white">0</b>/20</span>
                <span>Cược hôm nay: <b id="progressBet" class="text-white">0</b>/200</span>
            </div>

            <button id="btnAttendance" onclick="claimAttendance()" class="w-full btn-claim py-3" disabled>ĐIỂM DANH</button>
        </div>

        <!-- === 3. HOÀN TRẢ VIP (MIN $1) === -->
        <div class="promo-card p-4">
            <div class="flex justify-between items-start mb-2">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-blue-500/10 rounded-full flex items-center justify-center text-blue-400 text-xl">
                        <i class="fa-solid fa-rotate-left"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Hoàn Trả Không Giới Hạn</h3>
                        <p class="text-[10px] text-gray-400">Tối thiểu <span class="text-white font-bold">$1</span> để nhận.</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-[#0b0f19] p-3 rounded-lg border border-[#2d3442] mb-3">
                <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                    <span>Tổng cược tích lũy</span>
                    <span class="text-white font-mono" id="refundTurnover">$0.00</span>
                </div>
                <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                    <span>Hoàn trả khả dụng</span>
                    <span class="text-[#0ECB81] font-mono font-bold" id="refundAmount">$0.00</span>
                </div>
            </div>
            
            <button id="btnRefund" onclick="claimRefund()" class="w-full btn-claim py-3" disabled>CHƯA ĐỦ MỐC $1</button>
        </div>

        <!-- === 4. QUÀ TÂN THỦ (ẨN NÚT KHI ĐÃ ẤN) === -->
        <div class="promo-card p-4 relative overflow-hidden" id="cardNewbie">
            <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FCD535] opacity-20 rounded-full blur-xl"></div>
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-[#FCD535]/10 rounded-full flex items-center justify-center text-[#FCD535] text-xl">
                        <i class="fa-solid fa-user-plus"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Quà Tân Thủ</h3>
                        <p class="text-[10px] text-gray-400">Chỉ nhận 1 lần duy nhất.</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-[#FCD535] font-black font-mono text-lg">FREE</span>
                    <button id="btnNewbie" onclick="requestPromo('newbie')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 5. KHUYẾN MÃI NẠP ĐẦU (MAX $1000 - MIN $200) === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="promo-tag">HOT</div>
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-purple-500/10 rounded-full flex items-center justify-center text-purple-400 text-xl">
                        <i class="fa-solid fa-1"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Nạp Đầu 100%</h3>
                        <p class="text-[10px] text-gray-400">Tối thiểu: $200 - Tối đa: $1,000</p>
                        <p class="text-[10px] text-gray-500">(Tiền nạp + KM) x3 Cược</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-purple-400 font-black font-mono text-lg">100%</span>
                    <button id="btnDep1" onclick="requestPromo('deposit_1')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 6. KHUYẾN MÃI NẠP LẦN 2 === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-indigo-500/10 rounded-full flex items-center justify-center text-indigo-400 text-xl">
                        <i class="fa-solid fa-2"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Nạp Lần 2</h3>
                        <p class="text-[10px] text-gray-400">Ưu đãi đặc biệt cho lần 2.</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-indigo-400 font-black font-mono text-lg">BONUS</span>
                    <button id="btnDep2" onclick="requestPromo('deposit_2')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 7. NẠP HÀNG NGÀY (10% x2 VC) === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-teal-500/10 rounded-full flex items-center justify-center text-teal-400 text-xl">
                        <i class="fa-solid fa-repeat"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Nạp Mỗi Ngày</h3>
                        <p class="text-[10px] text-gray-400">Thưởng 10% - x2 Vòng cược.</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-teal-400 font-black font-mono text-lg">10%</span>
                    <button id="btnDaily" onclick="requestPromo('daily_10')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 8. CUỐI TUẦN T7-CN (50% x5 VC) === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="promo-tag bg-red-600">T7 - CN</div>
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-red-500/10 rounded-full flex items-center justify-center text-red-400 text-xl">
                        <i class="fa-solid fa-calendar-week"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Siêu Deal Cuối Tuần</h3>
                        <p class="text-[10px] text-gray-400">Max $1,000 - x5 Vòng cược.</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-red-400 font-black font-mono text-lg">50%</span>
                    <button id="btnWeekend" onclick="requestPromo('weekend_50')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, addDoc, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU",
            authDomain: "btccoinbig.firebaseapp.com",
            projectId: "btccoinbig",
            storageBucket: "btccoinbig.firebasestorage.app",
            messagingSenderId: "116892525933",
            appId: "1:116892525933:web:04b0da25f3f933ce162664"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let userData = null;

        // --- Sidebar ---
        window.toggleMenu = () => {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebarOverlay');
            if (sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden', 'opacity-0'); } 
            else { sb.classList.add('-translate-x-full'); ov.classList.add('opacity-0'); setTimeout(()=>ov.classList.add('hidden'),300); }
        };
        window.logout = () => { signOut(auth).then(() => { localStorage.removeItem('crownex_user_info'); window.location.href = "login.html"; }); };

        // --- Auth & Data ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const localData = JSON.parse(localStorage.getItem('crownex_user_info'));
                if(localData) document.getElementById('sidebarUsername').innerText = localData.fullName || localData.username;

                // Listen to User Data
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        renderAll(userData);
                    }
                });

                // Check pending requests status
                checkPendingRequests(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        function renderAll(data) {
            renderRefund(data);
            renderAttendance(data);
            checkWeekend(); // Kiểm tra có phải T7 CN không để hiện nút
        }

        // --- 1. GIFTCODE ---
        window.redeemCode = async () => {
            if (!currentUser) return;
            const codeInput = document.getElementById('giftcodeInput');
            const code = codeInput.value.trim().toUpperCase();
            const btn = document.getElementById('btnRedeem');

            if (!code) return showToast("Vui lòng nhập mã!", "error");
            btn.disabled = true; btn.innerText = "ĐANG XỬ LÝ...";

            try {
                await runTransaction(db, async (transaction) => {
                    const codeRef = doc(db, "giftcodes", code);
                    const codeSnap = await transaction.get(codeRef);
                    if (!codeSnap.exists()) throw "Mã Code không tồn tại!";

                    const k = codeSnap.data();
                    if (k.usedCount >= k.limit) throw "Mã Code đã hết lượt!";
                    if (k.usersClaimed && k.usersClaimed.includes(currentUser.uid)) throw "Bạn đã sử dụng mã này!";

                    const userRef = doc(db, "users", currentUser.uid);
                    const userSnap = await transaction.get(userRef);

                    transaction.update(codeRef, { 
                        usedCount: (k.usedCount || 0) + 1,
                        usersClaimed: [...(k.usersClaimed || []), currentUser.uid]
                    });

                    transaction.update(userRef, {
                        balance: (userSnap.data().balance || 0) + k.amount,
                        requiredTurnover: (userSnap.data().requiredTurnover || 0) + (k.turnoverReq || 0)
                    });
                });

                await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
                    type: 'giftcode', amount: 0, code: code, status: 'success', timestamp: new Date()
                });
                showToast("Đổi mã thành công!", "success");
                codeInput.value = "";
            } catch (e) { showToast(typeof e === 'string' ? e : e.message, "error"); } 
            finally { btn.disabled = false; btn.innerText = "ĐỔI QUÀ NGAY"; }
        };

        // --- 2. HOÀN TRẢ (Min $1) ---
        function renderRefund(data) {
            const currentTurnover = data.betTurnover || 0;
            const lastTurnover = data.lastRefundTurnover || 0;
            const pendingTurnover = Math.max(0, currentTurnover - lastTurnover);
            const refundAmt = pendingTurnover * 0.0015;

            document.getElementById('refundTurnover').innerText = "$" + currentTurnover.toLocaleString();
            document.getElementById('refundAmount').innerText = "$" + refundAmt.toFixed(4);

            const btnRefund = document.getElementById('btnRefund');
            if (refundAmt >= 1.0) {
                btnRefund.disabled = false;
                btnRefund.innerText = `RÚT NGAY $${refundAmt.toFixed(2)}`;
                btnRefund.classList.remove('opacity-50');
            } else {
                btnRefund.disabled = true;
                btnRefund.innerText = "CHƯA ĐỦ MỐC $1";
                btnRefund.classList.add('opacity-50');
            }
        }

        window.claimRefund = async () => {
            if (!currentUser || !userData) return;
            const btn = document.getElementById('btnRefund');
            btn.disabled = true;
            try {
                const currentTurnover = userData.betTurnover || 0;
                const lastTurnover = userData.lastRefundTurnover || 0;
                const pendingTurnover = Math.max(0, currentTurnover - lastTurnover);
                const refundAmt = pendingTurnover * 0.0015;

                if (refundAmt < 1.0) return showToast("Số dư hoàn trả chưa đủ $1", "error");

                await updateDoc(doc(db, "users", currentUser.uid), {
                    balance: (userData.balance || 0) + refundAmt,
                    lastRefundTurnover: currentTurnover
                });
                await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
                    type: 'refund', amount: refundAmt, note: 'Hoàn trả 0.15%', status: 'success', timestamp: new Date()
                });
                showToast(`Đã nhận hoàn trả $${refundAmt.toFixed(2)}`, "success");
            } catch (e) { console.error(e); }
        };

        // --- 3. ĐIỂM DANH (Reset 00h) ---
        const REWARDS_7_DAYS = [1, 1, 2, 3, 4, 5, 9];

        function renderAttendance(data) {
            // Kiểm tra ngày hôm nay
            const todayStr = new Date().toDateString();
            const lastDepDate = data.lastDepositDate ? new Date(data.lastDepositDate).toDateString() : "";
            const lastBetDate = data.lastBetDate ? new Date(data.lastBetDate).toDateString() : "";
            
            // Logic: Nếu ngày nạp/cược không phải hôm nay, coi như = 0
            const depToday = (lastDepDate === todayStr) ? (data.depositToday || 0) : 0;
            const betToday = (lastBetDate === todayStr) ? (data.betToday || 0) : 0;

            document.getElementById('progressDep').innerText = depToday;
            document.getElementById('progressDep').className = depToday >= 20 ? "text-[#0ECB81]" : "text-white";
            document.getElementById('progressBet').innerText = betToday;
            document.getElementById('progressBet').className = betToday >= 200 ? "text-[#0ECB81]" : "text-white";

            const streak = data.attendanceStreak || 0;
            let html = '<div class="step-line"></div>';
            
            for(let i=0; i<7; i++) {
                let statusClass = '';
                if (i < streak) statusClass = 'checked';
                else if (i === streak) statusClass = 'active';

                html += `
                    <div class="step-item ${statusClass}">
                        <div class="step-circle">${i+1}</div>
                        <span class="reward-text">$${REWARDS_7_DAYS[i]}</span>
                    </div>
                `;
            }
            document.getElementById('attendanceSteps').innerHTML = html;

            const btnAtt = document.getElementById('btnAttendance');
            const lastAttDate = data.lastAttendance ? new Date(data.lastAttendance).toDateString() : "";

            if (lastAttDate === todayStr) {
                btnAtt.disabled = true;
                btnAtt.innerText = "ĐÃ ĐIỂM DANH HÔM NAY";
            } else {
                if (depToday >= 20 && betToday >= 200) {
                    btnAtt.disabled = false;
                    btnAtt.innerText = `NHẬN NGAY $${REWARDS_7_DAYS[streak] || 1}`;
                } else {
                    btnAtt.disabled = true;
                    btnAtt.innerText = "CHƯA ĐỦ ĐIỀU KIỆN";
                }
            }
        }

        window.claimAttendance = async () => {
            if (!currentUser) return;
            try {
                const btn = document.getElementById('btnAttendance');
                btn.disabled = true;
                const streak = userData.attendanceStreak || 0;
                let reward = REWARDS_7_DAYS[streak] || 1;
                
                let nextStreak = streak + 1;
                if (nextStreak >= 7) nextStreak = 0;

                await updateDoc(doc(db, "users", currentUser.uid), {
                    balance: (userData.balance || 0) + reward,
                    attendanceStreak: nextStreak,
                    lastAttendance: Date.now()
                });

                await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
                    type: 'attendance', amount: reward, note: `Điểm danh ngày ${streak + 1}`, status: 'success', timestamp: new Date()
                });
                showToast(`Điểm danh thành công! Nhận $${reward}`, "success");
            } catch (e) { showToast("Lỗi kết nối", "error"); }
        };

        // --- 4. KHUYẾN MÃI BUTTONS LOGIC ---
        function checkWeekend() {
            const today = new Date().getDay(); // 0 is Sunday, 6 is Saturday
            const btn = document.getElementById('btnWeekend');
            if (today !== 0 && today !== 6) {
                btn.disabled = true;
                btn.innerText = "CHỈ MỞ T7 - CN";
                btn.classList.add('opacity-50');
            }
        }

        async function checkPendingRequests(uid) {
            const q = query(collection(db, "promotion_requests"), where("userId", "==", uid));
            onSnapshot(q, (snap) => {
                let statusMap = {};
                snap.forEach(d => {
                    const r = d.data();
                    statusMap[r.type] = r.status;
                });
                
                // Newbie: Nếu đã có bất kỳ trạng thái nào (pending/approved/rejected) -> Ẩn hoặc disable vĩnh viễn
                updateNewbieButton(statusMap['newbie']);
                
                // Các gói khác: Chỉ chặn khi đang pending
                updatePromoBtn('btnDep1', statusMap['deposit_1']);
                updatePromoBtn('btnDep2', statusMap['deposit_2']);
                updatePromoBtn('btnDaily', statusMap['daily_10']);
                updatePromoBtn('btnWeekend', statusMap['weekend_50']);
            });
        }

        function updateNewbieButton(status) {
            const btn = document.getElementById('btnNewbie');
            if (!btn) return;
            
            if (status) {
                // Đã có record -> Không cho ấn nữa (Ẩn nút hoặc đổi trạng thái)
                btn.disabled = true;
                if (status === 'pending') {
                    btn.innerText = "CHỜ DUYỆT";
                    btn.className = "btn-claim pending";
                } else if (status === 'success') {
                    btn.innerText = "ĐÃ NHẬN";
                    btn.className = "btn-claim bg-gray-600";
                } else {
                    btn.innerText = "ĐÃ TỪ CHỐI"; // Hoặc ẩn luôn theo yêu cầu
                    btn.style.display = 'none'; // Ẩn luôn nếu cần
                }
            } else {
                btn.innerText = "ĐĂNG KÝ";
                btn.disabled = false;
            }
        }

        function updatePromoBtn(btnId, status) {
            const btn = document.getElementById(btnId);
            if (!btn) return;

            if (status === 'pending') {
                btn.innerText = "ĐANG XÉT DUYỆT";
                btn.disabled = true;
                btn.classList.add('pending');
            } else {
                // Nếu là weekend, check ngày lại lần nữa để không ghi đè
                if (btnId === 'btnWeekend') {
                     const today = new Date().getDay();
                     if (today !== 0 && today !== 6) return; // Giữ nguyên trạng thái disable do ngày
                }
                btn.innerText = "ĐĂNG KÝ";
                btn.disabled = false;
                btn.classList.remove('pending');
            }
        }

        window.requestPromo = async (type) => {
            if (!currentUser) return;
            const btnIdMap = {
                'newbie': 'btnNewbie', 'deposit_1': 'btnDep1', 
                'deposit_2': 'btnDep2', 'daily_10': 'btnDaily', 
                'weekend_50': 'btnWeekend'
            };
            const btn = document.getElementById(btnIdMap[type]);
            if(btn) { btn.disabled = true; btn.innerText = "ĐANG GỬI..."; }

            try {
                // Check quy tắc cụ thể
                if (type === 'deposit_1') {
                    // Có thể check thêm balance >= 200 ở đây nếu muốn
                }

                await addDoc(collection(db, "promotion_requests"), {
                    userId: currentUser.uid,
                    username: userData.username || 'Unknown',
                    type: type,
                    status: 'pending',
                    timestamp: new Date()
                });
                showToast("Đã gửi yêu cầu! Vui lòng chờ Admin duyệt.", "success");
            } catch (e) {
                showToast("Lỗi gửi yêu cầu", "error");
                if(btn) { btn.disabled = false; btn.innerText = "ĐĂNG KÝ"; }
            }
        };

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            const i = t.querySelector('i');
            if(type === 'error') { i.className = 'fa-solid fa-circle-exclamation text-lg text-[#F6465D]'; t.style.borderColor = '#F6465D'; }
            else { i.className = 'fa-solid fa-circle-check text-lg text-[#0ECB81]'; t.style.borderColor = '#0ECB81'; }
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>

