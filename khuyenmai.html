<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crownex - Khuyến Mãi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* CSS CORE */
        html, body { touch-action: pan-x pan-y; overscroll-behavior: none; height: 100%; background-color: #0b0f19; }
        body { color: #d1d5db; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; }
        .font-mono { font-family: 'IBM Plex Mono', monospace; }

        /* SIDEBAR */
        #sidebar { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .menu-item { display: flex; items-center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: #9ca3af; font-weight: 500; font-size: 14px; transition: all 0.2s; }
        .menu-item:active { background: #1e232e; color: white; }
        .menu-item.active { background: #1e232e; color: #FCD535; border: 1px solid #2d3442; }
        .menu-item i { width: 20px; text-align: center; }

        /* PROMO CARDS */
        .promo-card { 
            background: linear-gradient(145deg, #13161f, #171b26); 
            border: 1px solid #2d3442; border-radius: 12px; 
            overflow: hidden; margin-bottom: 16px; position: relative; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .promo-tag {
            position: absolute; top: 0; right: 0;
            background: #F6465D; color: white;
            font-size: 9px; font-weight: bold;
            padding: 4px 8px; border-bottom-left-radius: 8px;
        }
        
        .btn-claim { 
            background: #0ECB81; color: white; border-radius: 6px; 
            padding: 8px 12px; font-size: 11px; font-weight: bold; 
            text-transform: uppercase; transition: 0.2s; min-width: 90px;
            text-align: center; display: inline-block;
        }
        .btn-claim.pending { background: #F59E0B; color: black; cursor: wait; opacity: 1 !important; }
        .btn-claim.received { background: #374151; color: #9CA3AF; cursor: not-allowed; opacity: 0.8; }
        .btn-claim:active:not(:disabled) { transform: scale(0.95); }
        .btn-claim:disabled { cursor: not-allowed; }

        /* GIFTCODE INPUT */
        .input-code { 
            width: 100%; background: #0b0f19; border: 1px solid #2d3442; color: #FCD535; 
            padding: 12px; border-radius: 8px; font-family: 'IBM Plex Mono', monospace; 
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold; text-align: center;
        }
        .input-code:focus { border-color: #FCD535; outline: none; box-shadow: 0 0 0 2px rgba(252, 213, 53, 0.2); }
        .btn-redeem { 
            width: 100%; background: #FCD535; color: #111; font-weight: bold; 
            padding: 12px; border-radius: 8px; margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(252, 213, 53, 0.2); transition: 0.2s; 
        }
        .btn-redeem:active { transform: scale(0.98); }

        /* ATTENDANCE 7 DAYS */
        .step-container { display: flex; justify-content: space-between; margin-top: 15px; position: relative; padding: 0 5px; }
        .step-line { position: absolute; top: 10px; left: 10px; right: 10px; height: 2px; background: #2d3442; z-index: 0; }
        .step-item { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; width: 14%; }
        .step-circle { width: 20px; height: 20px; border-radius: 50%; background: #1e232e; border: 2px solid #2d3442; color: #6b7280; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; }
        
        .step-item.active .step-circle { background: #FCD535; border-color: #FCD535; color: #111; box-shadow: 0 0 8px rgba(252, 213, 53, 0.4); transform: scale(1.2); }
        .step-item.checked .step-circle { background: #0ECB81; border-color: #0ECB81; color: white; }
        .reward-text { font-size: 9px; font-weight: bold; color: #6b7280; margin-top: 4px; font-family: 'IBM Plex Mono', monospace; }
        .step-item.active .reward-text { color: #FCD535; }
        .step-item.checked .reward-text { color: #0ECB81; }

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #1e232e; border: 1px solid #2d3442; padding: 10px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; opacity: 0; transition: all 0.4s; pointer-events: none;}
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #toast.error i { color: #F6465D; } #toast.success i { color: #0ECB81; }
    </style>
</head>
<body>

    <!-- TOAST -->
    <div id="toast"><i class="fa-solid fa-circle-check text-lg"></i><span class="text-sm font-bold text-white" id="toastMsg">...</span></div>

    <!-- SIDEBAR -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/80 z-40 hidden opacity-0 transition-opacity duration-300" onclick="toggleMenu()"></div>
    <div id="sidebar" class="fixed top-0 left-0 w-[80%] max-w-xs h-full bg-[#13161f] z-50 transform -translate-x-full shadow-2xl border-r border-[#232836] flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-[#232836] bg-[#171b26]">
            <div class="w-8 h-8 rounded bg-[#FCD535] flex items-center justify-center text-black font-bold text-xl rounded-bl-none mr-3">C</div>
            <span class="font-bold text-lg text-white">CROWNEX</span>
            <button onclick="toggleMenu()" class="ml-auto text-gray-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <a href="game.html" class="menu-item"><i class="fa-solid fa-chart-line"></i> Giao dịch</a>
            <a href="taikhoan.html" class="menu-item"><i class="fa-solid fa-user-gear"></i> Tài khoản</a>
            <a href="naprut.html" class="menu-item"><i class="fa-solid fa-money-bill-transfer"></i> Nạp / Rút tiền</a>
            <a href="lichsu.html" class="menu-item"><i class="fa-solid fa-clock-rotate-left"></i> Lịch sử cược</a>
            <a href="khuyenmai.html" class="menu-item active"><i class="fa-solid fa-gift"></i> Khuyến mãi <span class="ml-auto bg-[#F6465D] text-white text-[10px] px-1.5 rounded font-bold">HOT</span></a>
            <div class="border-t border-[#232836] my-2 mx-2"></div>
            <a href="https://t.me/ad_crownex" target="_blank" class="menu-item text-blue-400"><i class="fa-brands fa-telegram text-lg"></i> CSKH (Telegram)</a>
            <a href="#" onclick="logout()" class="menu-item text-red-400 mt-4"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a>
        </nav>
        <div class="p-4 border-t border-[#232836] bg-[#12141c]">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 flex items-center justify-center font-bold text-xs shadow-lg text-white">U</div>
                <div class="flex flex-col"><span class="text-xs font-bold text-white" id="sidebarUsername">User...</span><span class="text-[10px] text-green-500 flex items-center gap-1"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Online</span></div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="flex items-center px-4 h-14 bg-[#13161f] border-b border-[#232836] sticky top-0 z-20">
        <button onclick="toggleMenu()" class="mr-4"><i class="fa-solid fa-bars-staggered text-xl text-[#9ca3af]"></i></button>
        <h1 class="flex-1 text-center font-bold text-white text-lg tracking-wide">TRUNG TÂM SỰ KIỆN</h1>
        <div class="w-8"></div>
    </header>

    <div class="p-4 flex-1 overflow-y-auto pb-10">
        
        <!-- === 1. NHẬP GIFTCODE === -->
        <div class="bg-[#1e232e] p-5 rounded-xl border border-[#FCD535] border-dashed mb-6 relative overflow-hidden shadow-lg">
            <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FCD535] opacity-20 rounded-full blur-xl"></div>
            <h3 class="text-sm font-bold text-[#FCD535] mb-3 flex items-center gap-2">
                <i class="fa-solid fa-ticket"></i> NHẬP GIFTCODE
            </h3>
            <input type="text" id="giftcodeInput" class="input-code" placeholder="NHẬP MÃ CODE TẠI ĐÂY">
            <button onclick="redeemCode()" class="btn-redeem" id="btnRedeem">KÍCH HOẠT MÃ</button>
            <p class="text-[10px] text-center text-gray-500 mt-2 italic">*Yêu cầu sẽ được gửi đến Admin để duyệt</p>
        </div>

        <!-- === 2. ĐIỂM DANH 7 NGÀY (UPDATED LOGIC) === -->
        <div class="promo-card p-4">
            <div class="flex gap-3 mb-3">
                <div class="w-10 h-10 bg-[#0ECB81]/10 rounded-full flex items-center justify-center text-[#0ECB81] text-xl">
                    <i class="fa-solid fa-calendar-check"></i>
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm">Điểm Danh 7 Ngày</h3>
                    <p class="text-[10px] text-gray-400">Yêu cầu: Nạp $20 & Cược $200 mỗi ngày.</p>
                    <p class="text-[10px] text-[#F6465D]">Lưu ý: Bỏ lỡ 1 ngày sẽ quay lại Mốc 1.</p>
                </div>
            </div>

            <!-- Steps 7 Days -->
            <div class="step-container mb-4" id="attendanceSteps">
                <!-- Rendered by JS -->
            </div>

            <div class="flex justify-between text-[10px] text-gray-400 mb-2 px-2 border-t border-[#2d3442] pt-2">
                <span>Nạp hôm nay: <b id="progressDep" class="text-white">0</b>/20</span>
                <span>Cược hôm nay: <b id="progressBet" class="text-white">0</b>/200</span>
            </div>

            <button id="btnAttendance" onclick="claimAttendance()" class="w-full btn-claim py-3" disabled>ĐANG TẢI...</button>
        </div>

        <!-- === 3. HOÀN TRẢ VIP (MIN $1) === -->
        <div class="promo-card p-4">
            <div class="flex justify-between items-start mb-2">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-blue-500/10 rounded-full flex items-center justify-center text-blue-400 text-xl">
                        <i class="fa-solid fa-rotate-left"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Hoàn Trả Không Giới Hạn</h3>
                        <p class="text-[10px] text-gray-400">Tỷ lệ 1.5% - Tự động cộng mỗi ngày.</p>
                        <p class="text-[10px] text-gray-400">Rút tối thiểu: <span class="text-white font-bold">$1</span></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-[#0b0f19] p-3 rounded-lg border border-[#2d3442] mb-3">
                <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                    <span>Tổng cược tích lũy</span>
                    <span class="text-white font-mono" id="refundTurnover">$0.00</span>
                </div>
                <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                    <span>Hoàn trả khả dụng</span>
                    <span class="text-[#0ECB81] font-mono font-bold" id="refundAmount">$0.00</span>
                </div>
            </div>
            
            <button id="btnRefund" onclick="claimRefund()" class="w-full btn-claim py-3" disabled>CHƯA ĐỦ MỐC $1</button>
        </div>

        <!-- === 4. QUÀ TÂN THỦ === -->
        <div class="promo-card p-4 relative overflow-hidden" id="cardNewbie">
            <div class="absolute -right-4 -top-4 w-16 h-16 bg-[#FCD535] opacity-20 rounded-full blur-xl"></div>
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-[#FCD535]/10 rounded-full flex items-center justify-center text-[#FCD535] text-xl">
                        <i class="fa-solid fa-user-plus"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Tặng Thưởng Tân Thủ</h3>
                        <p class="text-[10px] text-gray-400">Dành cho tài khoản mới đăng ký.</p>
                        <p class="text-[10px] text-gray-500">Hoàn thành KYC + Liên kết ngân hàng.</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-[#FCD535] font-black font-mono text-lg">FREE</span>
                    <button id="btnNewbie" onclick="requestPromo('newbie')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 5. KHUYẾN MÃI NẠP ĐẦU === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="promo-tag">HOT</div>
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-purple-500/10 rounded-full flex items-center justify-center text-purple-400 text-xl">
                        <i class="fa-solid fa-gem"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Thưởng Nạp Đầu 100%</h3>
                        <p class="text-[10px] text-gray-400">Nạp tối đa: $5</p>
                        <p class="text-[10px] text-gray-500">Yêu cầu doanh thu: x3 Vòng cược</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-purple-400 font-black font-mono text-lg">100%</span>
                    <button id="btnDep1" onclick="requestPromo('deposit_1')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 6. KHUYẾN MÃI NẠP LẦN 2 === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-indigo-500/10 rounded-full flex items-center justify-center text-indigo-400 text-xl">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Thưởng Nạp Lại (Lần 2)</h3>
                        <p class="text-[10px] text-gray-400">Thưởng 50% giá trị nạp.</p>
                        <p class="text-[10px] text-gray-500">Yêu cầu doanh thu: x5 Vòng cược</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-indigo-400 font-black font-mono text-lg">50%</span>
                    <button id="btnDep2" onclick="requestPromo('deposit_2')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 7. NẠP HÀNG NGÀY === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-teal-500/10 rounded-full flex items-center justify-center text-teal-400 text-xl">
                        <i class="fa-solid fa-calendar-day"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Nạp Mỗi Ngày</h3>
                        <p class="text-[10px] text-gray-400">Nhận thêm 10% mỗi lần nạp.</p>
                        <p class="text-[10px] text-gray-500">Không giới hạn số lần nhận.</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-teal-400 font-black font-mono text-lg">10%</span>
                    <button id="btnDaily" onclick="requestPromo('daily_10')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

        <!-- === 8. CUỐI TUẦN T7-CN === -->
        <div class="promo-card p-4 relative overflow-hidden">
            <div class="promo-tag bg-red-600">T7 & CN</div>
            <div class="flex justify-between items-center">
                <div class="flex gap-3">
                    <div class="w-10 h-10 bg-red-500/10 rounded-full flex items-center justify-center text-red-400 text-xl">
                        <i class="fa-solid fa-fire"></i>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Siêu Deal Cuối Tuần</h3>
                        <p class="text-[10px] text-gray-400">Thưởng 50% cho giao dịch đầu tiên.</p>
                        <p class="text-[10px] text-gray-500">Áp dụng: Thứ 7 & Chủ Nhật.</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-red-400 font-black font-mono text-lg">50%</span>
                    <button id="btnWeekend" onclick="requestPromo('weekend_50')" class="btn-claim mt-1">ĐĂNG KÝ</button>
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, onSnapshot, addDoc, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU",
            authDomain: "btccoinbig.firebaseapp.com",
            projectId: "btccoinbig",
            storageBucket: "btccoinbig.firebasestorage.app",
            messagingSenderId: "116892525933",
            appId: "1:116892525933:web:04b0da25f3f933ce162664"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let userData = null;

        // --- MAP: Type to Button ID ---
        const BTN_MAP = {
            'newbie': 'btnNewbie',
            'deposit_1': 'btnDep1',
            'deposit_2': 'btnDep2',
            'daily_10': 'btnDaily',
            'weekend_50': 'btnWeekend'
        };

        // --- Utils ---
        function getTodayString() { return new Date().toDateString(); }
        
        // --- Helper: Check Days Diff ---
        function checkDayDiff(lastDateMs) {
            if (!lastDateMs) return { claimedToday: false, isConsecutive: false };
            
            const now = new Date();
            const last = new Date(lastDateMs);
            
            // Xóa phần giờ phút giây để so sánh ngày chuẩn
            const todayZero = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const lastZero = new Date(last.getFullYear(), last.getMonth(), last.getDate()).getTime();
            
            const diffMs = todayZero - lastZero;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);

            if (diffDays === 0) return { claimedToday: true, isConsecutive: true }; // Cùng ngày
            if (diffDays === 1) return { claimedToday: false, isConsecutive: true }; // Liên tiếp (hôm qua)
            return { claimedToday: false, isConsecutive: false }; // Đứt quãng (hôm kia hoặc lâu hơn)
        }

        // --- Sidebar ---
        window.toggleMenu = () => {
            const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebarOverlay');
            if (sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden', 'opacity-0'); } 
            else { sb.classList.add('-translate-x-full'); ov.classList.add('opacity-0'); setTimeout(()=>ov.classList.add('hidden'),300); }
        };
        window.logout = () => { signOut(auth).then(() => { localStorage.removeItem('crownex_user_info'); window.location.href = "login.html"; }); };

        // --- Auth & Data ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const localData = JSON.parse(localStorage.getItem('crownex_user_info'));
                if(localData) document.getElementById('sidebarUsername').innerText = localData.fullName || localData.username;

                // FIX 1: TẠO USER DOC NẾU CHƯA CÓ (ĐỂ TRÁNH LỖI KHI GHI TRANSACTIONS)
                // Dùng getDoc check trước, nếu chưa có mới setDoc (tránh reset balance về 0)
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        uid: user.uid,
                        username: user.email,
                        balance: 0,
                        attendanceStreak: 0,
                        betTurnover: 0,
                        createdAt: Date.now()
                    });
                }

                // Listen to User Data
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        renderAll(userData);
                    }
                });

                // Check pending requests status
                checkPromoRequests(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        function renderAll(data) {
            renderRefund(data);
            renderAttendance(data);
        }

        // --- 1. GIFTCODE (FIXED RULES: GỬI REQUEST CHO ADMIN) ---
        window.redeemCode = async () => {
            if (!currentUser) return;
            const codeInput = document.getElementById('giftcodeInput');
            const code = codeInput.value.trim().toUpperCase();
            const btn = document.getElementById('btnRedeem');

            if (!code) return showToast("Vui lòng nhập mã!", "error");
            btn.disabled = true; btn.innerText = "ĐANG GỬI...";

            try {
                // THAY VÌ UPDATE GIFTCODE (BỊ CHẶN BỞI RULE), TA TẠO REQUEST CHO ADMIN
                await addDoc(collection(db, "admin_requests"), {
                    type: "giftcode",
                    uid: currentUser.uid,
                    username: userData?.username || currentUser.email,
                    code: code,
                    timestamp: Date.now(),
                    status: "pending"
                });

                showToast("Đã gửi mã! Chờ Admin duyệt.", "success");
                codeInput.value = "";
            } catch (e) { 
                showToast("Lỗi: " + e.message, "error"); 
                console.error(e);
            } 
            finally { btn.disabled = false; btn.innerText = "KÍCH HOẠT MÃ"; }
        };

        // --- 2. HOÀN TRẢ ---
        function renderRefund(data) {
            const currentTurnover = data.betTurnover || 0;
            const lastTurnover = data.lastRefundTurnover || 0;
            const pendingTurnover = Math.max(0, currentTurnover - lastTurnover);
            const refundAmt = pendingTurnover * 0.0015;

            document.getElementById('refundTurnover').innerText = "$" + currentTurnover.toLocaleString();
            document.getElementById('refundAmount').innerText = "$" + refundAmt.toFixed(4);

            const btnRefund = document.getElementById('btnRefund');
            if (refundAmt >= 1.0) {
                btnRefund.disabled = false;
                btnRefund.innerText = `RÚT NGAY $${refundAmt.toFixed(2)}`;
                btnRefund.classList.remove('opacity-50');
            } else {
                btnRefund.disabled = true;
                btnRefund.innerText = "CHƯA ĐỦ MỐC $1";
                btnRefund.classList.add('opacity-50');
            }
        }

        window.claimRefund = async () => {
            if (!currentUser || !userData) return;
            const btn = document.getElementById('btnRefund');
            btn.disabled = true;
            try {
                const currentTurnover = userData.betTurnover || 0;
                const lastTurnover = userData.lastRefundTurnover || 0;
                const pendingTurnover = Math.max(0, currentTurnover - lastTurnover);
                const refundAmt = pendingTurnover * 0.015;

                if (refundAmt < 1.0) return showToast("Số dư hoàn trả chưa đủ $1", "error");

                await updateDoc(doc(db, "users", currentUser.uid), {
                    balance: (userData.balance || 0) + refundAmt,
                    lastRefundTurnover: currentTurnover
                });
                await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
                    type: 'refund', amount: refundAmt, note: 'Hoàn trả 0.15%', status: 'success', timestamp: Date.now()
                });
                showToast(`Đã nhận hoàn trả $${refundAmt.toFixed(2)}`, "success");
            } catch (e) { console.error(e); }
        };

        // --- 3. ĐIỂM DANH (LOGIC MỚI: RESET NẾU NGẮT QUÃNG) ---
        const REWARDS_7_DAYS = [1, 2, 3, 5, 8, 12, 25]; // Cấu hình phần thưởng hấp dẫn hơn

        function renderAttendance(data) {
            const todayStr = getTodayString();
            
            const lastDepDate = data.lastDepositDate ? new Date(data.lastDepositDate).toDateString() : "";
            const lastBetDate = data.lastBetDate ? new Date(data.lastBetDate).toDateString() : "";

            const depToday = (lastDepDate === todayStr) ? (data.depositToday || 0) : 0;
            const betToday = (lastBetDate === todayStr) ? (data.betToday || 0) : 0;

            document.getElementById('progressDep').innerText = depToday;
            document.getElementById('progressDep').className = depToday >= 20 ? "text-[#0ECB81]" : "text-white";
            document.getElementById('progressBet').innerText = betToday;
            document.getElementById('progressBet').className = betToday >= 200 ? "text-[#0ECB81]" : "text-white";

            // LOGIC KIỂM TRA NGẮT QUÃNG
            const { claimedToday, isConsecutive } = checkDayDiff(data.lastAttendance);
            
            // Nếu không liên tiếp và chưa nhận hôm nay -> Reset visually về 0
            // Nếu liên tiếp -> Giữ nguyên streak
            // Nếu đã nhận hôm nay -> Giữ nguyên streak
            let displayStreak = data.attendanceStreak || 0;
            if (!isConsecutive && !claimedToday) {
                displayStreak = 0; 
            }
            if (displayStreak >= 7) displayStreak = 0; // Cycle reset

            let html = '<div class="step-line"></div>';
            for(let i=0; i<7; i++) {
                let statusClass = '';
                // Nếu đã nhận hôm nay: hiển thị active đến mốc hiện tại
                if (claimedToday) {
                    if (i < displayStreak) statusClass = 'checked';
                } else {
                    // Chưa nhận: hiển thị checked các mốc cũ, mốc tiếp theo là active
                    if (i < displayStreak) statusClass = 'checked';
                    else if (i === displayStreak) statusClass = 'active';
                }

                html += `
                    <div class="step-item ${statusClass}">
                        <div class="step-circle">${i+1}</div>
                        <span class="reward-text">$${REWARDS_7_DAYS[i]}</span>
                    </div>
                `;
            }
            document.getElementById('attendanceSteps').innerHTML = html;

            const btnAtt = document.getElementById('btnAttendance');

            if (claimedToday) {
                btnAtt.disabled = true;
                btnAtt.innerText = "ĐÃ ĐIỂM DANH HÔM NAY";
                btnAtt.classList.add('opacity-50');
            } else {
                btnAtt.classList.remove('opacity-50');
                if (depToday >= 20 && betToday >= 200) {
                    btnAtt.disabled = false;
                    btnAtt.innerText = `NHẬN NGAY $${REWARDS_7_DAYS[displayStreak]}`;
                } else {
                    btnAtt.disabled = true;
                    btnAtt.innerText = "CHƯA ĐỦ ĐIỀU KIỆN";
                }
            }
        }

        window.claimAttendance = async () => {
            if (!currentUser) return;
            const btn = document.getElementById('btnAttendance');
            
            try {
                btn.disabled = true;
                
                // Kiểm tra lại logic ngày khi bấm nút (Server-side simulation)
                const { isConsecutive } = checkDayDiff(userData.lastAttendance);
                
                let streak = userData.attendanceStreak || 0;
                
                // NẾU KHÔNG LIÊN TIẾP -> RESET VỀ 0
                if (!isConsecutive) {
                    streak = 0;
                }

                // Nếu đã full chuỗi 7 ngày -> Reset về 0
                if (streak >= 7) streak = 0;

                let reward = REWARDS_7_DAYS[streak];
                let nextStreak = streak + 1; // Tăng streak cho ngày mai

                await updateDoc(doc(db, "users", currentUser.uid), {
                    balance: (userData.balance || 0) + reward,
                    attendanceStreak: nextStreak,
                    lastAttendance: Date.now()
                });

                await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
                    type: 'attendance', 
                    amount: reward, 
                    note: `Điểm danh ngày ${nextStreak} (Chuỗi ${isConsecutive ? 'liên tiếp' : 'mới'})`, 
                    status: 'success', 
                    timestamp: Date.now()
                });

                showToast(`Điểm danh thành công! Nhận $${reward}`, "success");
            } catch (e) { 
                console.error(e);
                showToast("Lỗi xử lý điểm danh", "error"); 
                btn.disabled = false;
            }
        };

        // --- 4. CORE FIX: KHUYẾN MÃI STATUS LOGIC & COLLECTION NAME ---

        function getStatusPriority(status) {
            if (status === 'success') return 3;
            if (status === 'pending') return 2;
            return 1; 
        }

        async function checkPromoRequests(uid) {
            // FIX: ĐỔI TÊN COLLECTION THÀNH 'promo_requests' CHO KHỚP RULES
            const q = query(collection(db, "promo_requests"), where("userId", "==", uid));
            
            onSnapshot(q, (snap) => {
                let requestsByType = {};
                
                snap.forEach(doc => {
                    const r = doc.data();
                    if (!requestsByType[r.type]) requestsByType[r.type] = [];
                    requestsByType[r.type].push(r);
                });

                Object.keys(BTN_MAP).forEach(type => {
                    const btnId = BTN_MAP[type];
                    const requests = requestsByType[type] || [];

                    requests.sort((a, b) => {
                        const priA = getStatusPriority(a.status);
                        const priB = getStatusPriority(b.status);
                        if (priA !== priB) return priB - priA; 
                        return b.timestamp - a.timestamp;      
                    });

                    const topReq = requests.length > 0 ? requests[0] : null;
                    const finalStatus = topReq ? topReq.status : null;

                    updatePromoBtn(btnId, finalStatus);
                });
            });
        }

        function updatePromoBtn(btnId, status) {
            const btn = document.getElementById(btnId);
            if (!btn) return;

            // Logic Weekend Button
            if (btnId === 'btnWeekend' && (status !== 'pending' && status !== 'success')) {
                const today = new Date().getDay();
                if (today !== 0 && today !== 6) { // 0=Sunday, 6=Saturday
                    btn.className = "btn-claim mt-1 opacity-50";
                    btn.innerText = "CHỈ MỞ T7 - CN";
                    btn.disabled = true;
                    return; 
                }
            }

            btn.className = "btn-claim mt-1"; 

            if (status === 'pending') {
                btn.innerText = "ĐANG XÉT DUYỆT";
                btn.disabled = true;
                btn.classList.add('pending');
            } 
            else if (status === 'success') {
                btn.innerText = "ĐÃ NHẬN";
                btn.disabled = true;
                btn.classList.add('received');
            } 
            else {
                btn.innerText = "ĐĂNG KÝ";
                btn.disabled = false;
            }
        }

        window.requestPromo = async (type) => {
            if (!currentUser) return;
            const btnId = BTN_MAP[type];
            const btn = document.getElementById(btnId);

            if(btn) { btn.disabled = true; btn.innerText = "ĐANG GỬI..."; }

            try {
                // FIX: ĐỔI TÊN COLLECTION THÀNH 'promo_requests'
                const q = query(
                    collection(db, "promo_requests"), 
                    where("userId", "==", currentUser.uid),
                    where("type", "==", type)
                );
                
                const querySnap = await getDocs(q);
                let isDuplicate = false;
                
                querySnap.forEach((doc) => {
                    const s = doc.data().status;
                    if (s === 'pending' || s === 'success') isDuplicate = true;
                });

                if (isDuplicate) {
                    showToast("Bạn đang có yêu cầu chờ duyệt hoặc đã nhận!", "error");
                    checkPromoRequests(currentUser.uid); // Refresh UI
                    return;
                }

                // FIX: GHI VÀO 'promo_requests'
                await addDoc(collection(db, "promo_requests"), {
                    userId: currentUser.uid,
                    username: userData?.username || 'Unknown',
                    type: type,
                    status: 'pending',
                    timestamp: Date.now()
                });
                
                showToast("Đã gửi yêu cầu! Vui lòng chờ Admin duyệt.", "success");
                
            } catch (e) {
                console.error(e);
                showToast("Lỗi: " + e.message, "error");
                if(btn) { btn.disabled = false; btn.innerText = "ĐĂNG KÝ"; }
            }
        };

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            const i = t.querySelector('i');
            if(type === 'error') { i.className = 'fa-solid fa-circle-exclamation text-lg text-[#F6465D]'; t.style.borderColor = '#F6465D'; }
            else { i.className = 'fa-solid fa-circle-check text-lg text-[#0ECB81]'; t.style.borderColor = '#0ECB81'; }
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>

