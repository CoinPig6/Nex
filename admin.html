<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CROWNEX ADMIN V9 - FINAL FIXED</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { 
                        gold: '#FCD535', 
                        dark: '#0B0E14', 
                        panel: '#151A25', 
                        border: '#2A303C',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0B0E14; color: #94a3b8; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .fade-out { animation: fadeOut 0.3s forwards; }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.95); pointer-events: none; } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #0B0E14; }
        ::-webkit-scrollbar-thumb { background: #2A303C; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #FCD535; }
        
        /* Layout */
        .sidebar { 
            width: 280px; height: 100vh; position: fixed; top: 0; left: 0; z-index: 60; 
            background: rgba(21, 26, 37, 0.95); backdrop-filter: blur(12px);
            border-right: 1px solid #2A303C; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; 
        }
        
        .main-content { margin-left: 280px; padding: 30px; padding-top: 100px; min-height: 100vh; transition: margin-left 0.3s; }
        
        /* Navigation */
        .nav-item { 
            display: flex; items-center; gap: 14px; padding: 14px 24px; margin: 4px 12px; border-radius: 8px;
            color: #64748b; font-weight: 500; font-size: 14px; transition: all 0.2s ease; cursor: pointer; position: relative;
        }
        .nav-item:hover { color: #fff; background: rgba(255,255,255,0.03); }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(252, 213, 53, 0.15), rgba(252, 213, 53, 0.05)); 
            color: #FCD535; font-weight: 700; 
        }
        .nav-item.active::before {
            content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 4px; height: 20px; background: #FCD535; border-radius: 0 4px 4px 0;
        }
        
        /* Components */
        .glass-card { background: #151A25; border: 1px solid #2A303C; box-shadow: 0 8px 24px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .glass-card:hover { border-color: #3f4857; }
        
        .input-box { 
            width: 100%; background: #0f131a; border: 1px solid #2A303C; 
            color: white; padding: 12px 16px; border-radius: 10px; font-size: 13px; outline: none; transition: 0.2s;
        }
        .input-box:focus { border-color: #FCD535; box-shadow: 0 0 0 3px rgba(252, 213, 53, 0.1); }
        
        .btn { 
            padding: 10px 24px; border-radius: 10px; font-weight: 600; font-size: 13px; 
            transition: all 0.2s; display: inline-flex; items-center; justify-content: center; gap: 8px; cursor: pointer; 
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, #FCD535 0%, #F59E0B 100%); color: #000; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); border: none; }
        .btn-primary:hover { box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); filter: brightness(1.1); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-danger:hover { background: #ef4444; color: white; }
        .btn-success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; }

        /* Tables */
        .table-container { border-radius: 16px; overflow: hidden; border: 1px solid #2A303C; background: #11151D; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #1A202C; color: #94a3b8; font-size: 11px; font-weight: 800; text-transform: uppercase; padding: 18px; border-bottom: 1px solid #2A303C; }
        td { padding: 16px 18px; color: #e2e8f0; font-size: 13px; border-bottom: 1px solid #2A303C; }
        tr:hover { background: #181d29; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px; padding-top: 90px; }
            .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 50; display: none; }
            .sidebar.active ~ .sidebar-overlay { display: block; }
        }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: #151A25; width: 90%; max-width: 450px; border-radius: 20px; border: 1px solid #333; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; background: #151A25; border: 1px solid #2A303C; border-left: 4px solid #FCD535; color: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translateY(100px); transition: 0.3s; z-index: 9999; font-weight: 600; font-size: 13px; }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- 1. MÀN HÌNH LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-[#0B0E14] z-[999] flex flex-col items-center justify-center">
        <div class="relative w-24 h-24 mb-6 flex items-center justify-center">
            <div class="absolute inset-0 bg-[#FCD535] rounded-full opacity-20 animate-ping"></div>
            <div class="relative w-20 h-20 bg-[#151A25] rounded-2xl flex items-center justify-center border border-[#FCD535] shadow-[0_0_30px_rgba(252,213,53,0.2)]">
                <span class="text-4xl font-black text-[#FCD535]">C</span>
            </div>
        </div>
        <h1 class="text-2xl font-bold text-white mb-2 tracking-tight">CROWNEX ADMIN</h1>
        <p class="text-xs text-slate-500 mb-8 font-mono border border-[#2A303C] px-3 py-1 rounded-full">SYSTEM V9.3 - SECURE</p>
        
        <div class="flex flex-col gap-4 w-full max-w-xs">
            <input type="password" id="adminPin" class="w-full text-center bg-[#151A25] border border-[#2A303C] text-[#FCD535] text-2xl tracking-[1em] py-4 rounded-xl focus:border-[#FCD535] outline-none transition-all placeholder-transparent" placeholder="••••" maxlength="4">
            <button onclick="window.checkPin()" id="btnLogin" class="btn btn-primary w-full py-3.5 shadow-lg">TRUY CẬP</button>
        </div>
        <div id="pinError" class="mt-4 text-red-500 text-xs font-bold hidden bg-red-500/10 px-4 py-2 rounded border border-red-500/20"></div>
        <div id="uid-display" class="hidden mt-6 text-center animate-fade-in-up">
            <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Admin UID (Copy vào Rules nếu báo lỗi)</p>
            <div class="flex items-center gap-2 bg-[#1C2230] p-2 rounded border border-[#2A303C]">
                <code id="uid-text" class="text-[10px] text-green-400 font-mono select-all">...</code>
                <button onclick="window.copyUid()" class="text-xs text-slate-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
            </div>
        </div>
    </div>

    <!-- 2. GIAO DIỆN CHÍNH -->
    <div id="app" class="hidden min-h-screen bg-[#0B0E14]">
        
        <!-- HEADER -->
        <header class="fixed top-0 right-0 lg:left-[280px] left-0 h-[70px] z-40 bg-[#0B0E14]/80 backdrop-blur border-b border-[#2A303C] flex items-center justify-between px-6 transition-all duration-300">
            <button onclick="window.toggleSidebar()" class="lg:hidden text-white text-xl"><i class="fa-solid fa-bars-staggered"></i></button>
            <div class="flex flex-col">
                <h2 id="page-title" class="text-lg font-bold text-white">Dashboard</h2>
                <span class="text-[10px] text-green-500 font-mono flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> SYSTEM ONLINE</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="window.initDefaults()" class="hidden md:flex bg-[#1C2230] hover:bg-[#2A303C] text-xs text-slate-400 px-3 py-1.5 rounded border border-[#2A303C] transition items-center gap-2">
                    <i class="fa-solid fa-database"></i> Check DB
                </button>
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-[#FCD535] to-[#f59e0b] flex items-center justify-center text-black font-bold shadow-lg">A</div>
            </div>
        </header>

        <!-- SIDEBAR -->
        <div id="sidebar" class="sidebar">
            <div class="h-[70px] flex items-center px-6 border-b border-[#2A303C] bg-[#11151D]">
                <div class="w-8 h-8 bg-[#FCD535] rounded-lg flex items-center justify-center text-black font-black mr-3">C</div>
                <div><div class="font-bold text-white text-sm">CROWNEX</div><div class="text-[10px] text-slate-500 font-bold">MANAGER</div></div>
            </div>

            <div class="flex-1 overflow-y-auto py-6 px-2 space-y-1">
                <div class="px-4 mb-2 text-[10px] font-bold text-slate-600 uppercase">Main</div>
                <div class="nav-item active" onclick="window.switchTab('dashboard', this, 'Tổng Quan')"><i class="fa-solid fa-chart-pie w-5"></i> Dashboard</div>
                
                <div class="px-4 mb-2 mt-6 text-[10px] font-bold text-slate-600 uppercase">Finance</div>
                <div class="nav-item" onclick="window.switchTab('requests', this, 'Duyệt Nạp Rút')">
                    <i class="fa-solid fa-money-bill-transfer w-5"></i> Nạp / Rút
                    <span id="badge-req" class="ml-auto bg-red-500 text-white text-[9px] font-bold px-1.5 rounded hidden">0</span>
                </div>
                <div class="nav-item" onclick="window.switchTab('promo', this, 'Khuyến Mãi')">
                    <i class="fa-solid fa-gift w-5"></i> Khuyến Mãi
                    <span id="badge-promo" class="ml-auto bg-purple-500 text-white text-[9px] font-bold px-1.5 rounded hidden">0</span>
                </div>

                <div class="px-4 mb-2 mt-6 text-[10px] font-bold text-slate-600 uppercase">System</div>
                <div class="nav-item" onclick="window.switchTab('users', this, 'Người Chơi')"><i class="fa-solid fa-users w-5"></i> Người Chơi</div>
                <div class="nav-item" onclick="window.switchTab('giftcode', this, 'Giftcode')"><i class="fa-solid fa-ticket w-5"></i> Giftcodes</div>
                <div class="nav-item" onclick="window.switchTab('settings', this, 'Cấu Hình')"><i class="fa-solid fa-sliders w-5"></i> Cấu Hình</div>
            </div>
            
            <div class="p-4 border-t border-[#2A303C]">
                <button onclick="location.reload()" class="w-full bg-[#1C2230] text-slate-400 py-3 rounded-lg hover:text-white hover:bg-red-500/20 transition font-bold text-xs"><i class="fa-solid fa-power-off mr-2"></i> ĐĂNG XUẤT</button>
            </div>
        </div>
        <div class="sidebar-overlay" onclick="window.toggleSidebar()"></div>

        <!-- CONTENT -->
        <div class="main-content">
            
            <!-- 1. DASHBOARD -->
            <div id="view-dashboard" class="fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="glass-card p-5 rounded-2xl relative overflow-hidden">
                        <i class="fa-solid fa-users absolute right-4 top-4 text-4xl opacity-10"></i>
                        <div class="text-[11px] font-bold text-slate-400 uppercase">Thành Viên</div>
                        <div class="text-3xl font-bold text-white mt-2" id="stat-users">0</div>
                    </div>
                    <div class="glass-card p-5 rounded-2xl relative overflow-hidden">
                        <i class="fa-solid fa-wallet absolute right-4 top-4 text-4xl opacity-10 text-green-500"></i>
                        <div class="text-[11px] font-bold text-slate-400 uppercase">Tổng Số Dư</div>
                        <div class="text-3xl font-bold text-green-400 mt-2 font-mono" id="stat-balance">$0</div>
                    </div>
                    <div class="glass-card p-5 rounded-2xl relative overflow-hidden">
                        <i class="fa-solid fa-arrow-down absolute right-4 top-4 text-4xl opacity-10 text-green-500"></i>
                        <div class="text-[11px] font-bold text-slate-400 uppercase">Nạp Hôm Nay</div>
                        <div class="text-3xl font-bold text-white mt-2 font-mono" id="stat-dep-today">$0</div>
                    </div>
                    <div class="glass-card p-5 rounded-2xl relative overflow-hidden">
                         <i class="fa-solid fa-arrow-up absolute right-4 top-4 text-4xl opacity-10 text-red-500"></i>
                        <div class="text-[11px] font-bold text-slate-400 uppercase">Rút Hôm Nay</div>
                        <div class="text-3xl font-bold text-white mt-2 font-mono" id="stat-wit-today">$0</div>
                    </div>
                </div>

                <!-- Live Monitor -->
                <div class="glass-card p-6 rounded-2xl border-red-500/30 bg-gradient-to-br from-[#151A25] to-red-900/10">
                    <div class="flex justify-between items-center mb-6">
                        <div class="text-xs font-black text-red-500 uppercase tracking-widest flex items-center gap-2">
                            <span class="animate-pulse w-2 h-2 rounded-full bg-red-500"></span> Live Monitor
                        </div>
                        <div class="font-mono font-bold text-[#FCD535] text-xl" id="realTimeClock">00:00</div>
                    </div>
                    <div class="flex gap-8 items-center justify-center py-4">
                        <div class="text-center"><div class="text-xs text-slate-500 font-bold mb-1">DOWN (ĐỎ)</div><div class="text-3xl font-bold text-red-500 font-mono" id="live-down">$0</div></div>
                        <div class="h-12 w-px bg-[#2A303C]"></div>
                        <div class="text-center"><div class="text-xs text-slate-500 font-bold mb-1">UP (XANH)</div><div class="text-3xl font-bold text-green-500 font-mono" id="live-up">$0</div></div>
                    </div>
                    <div class="mt-4 flex justify-center gap-4">
                         <button onclick="window.manualReset()" class="bg-[#2A303C] hover:bg-white hover:text-black text-white px-4 py-2 rounded text-xs font-bold transition"><i class="fa-solid fa-rotate-right mr-1"></i> Reset Phiên</button>
                         <label class="flex items-center gap-2 cursor-pointer bg-[#0B0E14] px-3 py-2 rounded border border-[#2A303C]">
                             <input type="checkbox" id="autoResetToggle" class="accent-[#FCD535]" checked>
                             <span class="text-[10px] text-slate-400 font-bold uppercase">Auto Reset (00s)</span>
                         </label>
                    </div>
                </div>
            </div>

            <!-- 2. NẠP RÚT -->
            <div id="view-requests" class="hidden fade-in">
                <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                    <button onclick="window.filterReq('all', this)" class="sub-tab active px-4 py-2 rounded-full text-xs font-bold bg-[#FCD535] text-black">Tất cả</button>
                    <button onclick="window.filterReq('deposit', this)" class="sub-tab px-4 py-2 rounded-full text-xs font-bold bg-[#151A25] border border-[#2A303C] text-white">Nạp tiền</button>
                    <button onclick="window.filterReq('withdraw', this)" class="sub-tab px-4 py-2 rounded-full text-xs font-bold bg-[#151A25] border border-[#2A303C] text-white">Rút tiền</button>
                    <button onclick="window.filterReq('pending', this)" class="sub-tab px-4 py-2 rounded-full text-xs font-bold bg-[#151A25] border border-[#2A303C] text-white">Chờ xử lý</button>
                </div>
                <div class="table-container">
                    <div class="overflow-x-auto">
                        <table>
                            <thead><tr><th>Thời gian</th><th>User</th><th>Loại</th><th>Số tiền</th><th>Ngân hàng</th><th>Trạng thái</th><th class="text-right">Hành động</th></tr></thead>
                            <tbody id="table-requests"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. KHUYẾN MÃI -->
            <div id="view-promo" class="hidden fade-in">
                <div id="promo-mobile" class="space-y-4 md:hidden"></div>
                <div class="hidden md:block table-container">
                    <div class="overflow-x-auto">
                        <table>
                            <thead><tr><th>Thời gian</th><th>User</th><th>Loại KM</th><th>Thưởng</th><th>Cược thêm</th><th>Trạng thái</th><th class="text-right">Hành động</th></tr></thead>
                            <tbody id="table-promo-desktop"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. NGƯỜI CHƠI -->
            <div id="view-users" class="hidden fade-in">
                <div class="flex justify-between mb-4">
                    <div class="relative w-full max-w-xs">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                        <input type="text" id="searchUser" oninput="window.filterUsers()" placeholder="Tìm User (Tên, SĐT)..." class="input-box pl-9">
                    </div>
                </div>
                <div class="table-container max-h-[70vh] overflow-y-auto">
                    <table>
                        <thead class="sticky top-0 z-10"><tr><th>User</th><th>Số dư</th><th>Cược / Yêu cầu</th><th>Bank</th><th class="text-right">Sửa</th></tr></thead>
                        <tbody id="table-users"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. GIFTCODE -->
            <div id="view-giftcode" class="hidden fade-in">
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="text-sm font-bold text-white mb-4">Tạo Code Mới</h3>
                        <div class="space-y-4">
                            <input type="number" id="gcAmount" class="input-box font-bold text-[#FCD535]" placeholder="Giá trị ($) - VD: 10">
                            <input type="number" id="gcLimit" class="input-box" placeholder="Số lượng giới hạn - VD: 50">
                            <input type="number" id="gcTurnover" class="input-box" placeholder="Yêu cầu cược ($) - VD: 50">
                            <button onclick="window.createGiftcode()" class="btn btn-primary w-full shadow-lg">TẠO CODE</button>
                        </div>
                    </div>
                    <div class="md:col-span-2 table-container h-[500px] overflow-y-auto">
                        <table>
                            <thead class="sticky top-0 z-10"><tr><th>Mã</th><th>Giá trị</th><th>Đã dùng</th><th class="text-right">Xóa</th></tr></thead>
                            <tbody id="table-giftcode"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. CẤU HÌNH -->
            <div id="view-settings" class="hidden fade-in">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Kill Whale Config -->
                    <div class="glass-card p-6 rounded-2xl border-red-500/30">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-white flex items-center gap-2">
                                    <i class="fa-solid fa-skull-crossbones text-red-500"></i> KILL WHALE MODE
                                </h3>
                                <p class="text-xs text-red-400 mt-1">Chế độ "bẻ cầu" giết cá voi</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="killWhaleToggle" onchange="window.saveKillWhaleConfig()" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                            </label>
                        </div>
                        
                        <div class="bg-[#0B0E14] p-4 rounded-xl border border-[#2A303C]">
                            <div class="flex justify-between text-xs text-slate-400 mb-2">
                                <span>Thời điểm đảo chiều (Giây cuối)</span>
                                <span id="flipTimeDisplay" class="text-[#FCD535] font-bold">6s</span>
                            </div>
                            <input type="range" id="flipTime" min="1" max="15" value="6" oninput="document.getElementById('flipTimeDisplay').innerText = this.value + 's'" onchange="window.saveKillWhaleConfig()" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-red-500">
                            <p class="text-[10px] text-slate-500 italic mt-2">Ví dụ: Chọn 6s -> Biểu đồ chạy bình thường, đến giây thứ 54 sẽ bẻ lái kết quả.</p>
                        </div>
                    </div>

                    <!-- Market Offset -->
                    <div class="glass-card p-6 rounded-2xl">
                        <h3 class="font-bold text-blue-400 mb-4">Điều Chỉnh Kết Quả Thủ Công</h3>
                        <p class="text-xs text-slate-400 mb-4">Can thiệp trực tiếp vào kết quả giá (Cộng/Trừ điểm)</p>
                        <input type="range" id="priceOffset" min="-50" max="50" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        <div class="flex justify-between text-xs font-bold text-slate-400 mt-2">
                            <span>ĐỎ (-50)</span>
                            <span id="offsetDisplay" class="text-white text-lg">0</span>
                            <span>XANH (+50)</span>
                        </div>
                        <button onclick="window.saveConfig()" class="btn bg-[#2A303C] text-white w-full mt-6 hover:bg-blue-600 border border-[#2A303C]">Lưu Cấu Hình</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">Action Successful!</div>

    <!-- MODAL DUYỆT NẠP/RÚT -->
    <div id="modal-approve" class="modal-overlay">
        <div class="modal-content animate-fade-in-up">
            <div class="bg-[#1C2230] px-6 py-4 border-b border-[#2A303C] flex justify-between items-center">
                <h3 class="text-sm font-bold text-white uppercase">Xử Lý Giao Dịch</h3>
                <button onclick="window.closeModal('modal-approve')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-[#0B0E14] rounded-xl p-4 border border-[#2A303C] mb-4">
                    <div class="flex justify-between mb-2"><span class="text-xs text-slate-500">Loại GD</span><span class="text-sm font-bold uppercase" id="modal-type">...</span></div>
                    <div class="flex justify-between mb-2"><span class="text-xs text-slate-500">Số tiền</span><span class="text-xl font-bold text-green-400 font-mono" id="modal-amount">$0</span></div>
                    <div class="flex justify-between border-t border-[#2A303C] pt-2"><span class="text-xs text-slate-500">User ID</span><span class="text-xs font-mono text-white" id="modal-uid">...</span></div>
                </div>
                <div class="mb-4 space-y-2 text-xs">
                    <div class="flex justify-between"><span class="text-slate-500">Ngân hàng:</span><span class="font-bold text-white" id="modal-bank-name">...</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Số TK:</span><span class="font-bold text-[#FCD535] font-mono select-all" id="modal-bank-num">...</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Chủ TK:</span><span class="font-bold text-white uppercase" id="modal-bank-owner">...</span></div>
                </div>
                <div id="div-turnover" class="mb-4">
                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Yêu cầu cược thêm ($)</label>
                    <input type="number" id="modal-turnover" class="input-box bg-[#0B0E14]" value="0">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="window.rejectTransaction()" class="btn btn-danger w-full">Từ Chối</button>
                    <button onclick="window.confirmTransaction()" class="btn btn-success w-full bg-green-600 hover:bg-green-500 text-white shadow-lg">DUYỆT NGAY</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT USER -->
    <div id="modal-user-edit" class="modal-overlay">
        <div class="modal-content animate-fade-in-up">
            <div class="bg-[#1C2230] px-6 py-4 border-b border-[#2A303C] flex justify-between items-center">
                <h3 class="text-sm font-bold text-white uppercase">Sửa Thông Tin</h3>
                <button onclick="window.closeModal('modal-user-edit')" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-user-id">
                <div><label class="text-[10px] text-slate-500 uppercase block mb-1">Tên hiển thị</label><input type="text" id="edit-fullname" class="input-box"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] text-slate-500 uppercase block mb-1">SĐT</label><input type="text" id="edit-phone" class="input-box"></div>
                    <div><label class="text-[10px] text-slate-500 uppercase block mb-1">Ngân hàng</label><input type="text" id="edit-bank" class="input-box"></div>
                </div>
                <div class="bg-[#0B0E14] p-4 rounded-xl border border-[#2A303C]">
                    <div class="flex justify-between mb-2"><span class="text-xs text-slate-400">Số dư hiện tại</span><span class="font-mono font-bold text-white" id="edit-current-bal">$0</span></div>
                    <input type="number" id="edit-adjust-bal" class="input-box bg-[#151A25]" placeholder="Nhập số để cộng/trừ tiền (vd: -50)">
                </div>
                <button onclick="window.saveUserEdit()" class="btn btn-primary w-full">LƯU THAY ĐỔI</button>
            </div>
        </div>
    </div>

    <!-- LOGIC SYSTEM -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc, addDoc, deleteDoc, serverTimestamp, getDocs, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // FIREBASE CONFIG - COPY FROM CONSOLE
        const firebaseConfig = { 
            apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU", 
            authDomain: "btccoinbig.firebaseapp.com", 
            projectId: "btccoinbig", 
            storageBucket: "btccoinbig.firebasestorage.app", 
            messagingSenderId: "116892525933", 
            appId: "1:116892525933:web:04b0da25f3f933ce162664" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const ADMIN_PIN = "9999"; // Mã PIN đăng nhập
        let allUsers = [], allReqs = [], allPromos = [], activeReq = null;

        // --- GLOBAL FUNCTIONS ---
        
        window.checkPin = async () => {
            const pin = document.getElementById('adminPin').value;
            const btn = document.getElementById('btnLogin');
            const err = document.getElementById('pinError');
            
            if(pin === ADMIN_PIN) {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Connecting...';
                btn.disabled = true;
                
                // FIX LOGIC: Nếu đã đăng nhập rồi thì vào luôn, không chờ signin nữa
                if(auth.currentUser) {
                    window.loginSuccess(auth.currentUser);
                } else {
                    try {
                        await signInAnonymously(auth);
                        // onAuthStateChanged sẽ tự xử lý tiếp phần còn lại
                    } catch(e) { 
                        btn.innerHTML = 'TRUY CẬP'; btn.disabled = false;
                        err.innerText = "Lỗi kết nối: " + e.message; err.classList.remove('hidden');
                    }
                }
            } else {
                err.innerText = "MÃ PIN KHÔNG CHÍNH XÁC"; err.classList.remove('hidden');
                document.getElementById('adminPin').value = '';
            }
        };

        // Hàm xử lý khi đăng nhập thành công
        window.loginSuccess = (user) => {
            const btn = document.getElementById('btnLogin');
            const pin = document.getElementById('adminPin').value;
            
            // Chỉ chạy nếu người dùng đã nhập đúng PIN
            if(pin === ADMIN_PIN) {
                document.getElementById('uid-text').innerText = user.uid;
                document.getElementById('uid-display').classList.remove('hidden');
                
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Success';
                setTimeout(() => {
                    document.getElementById('login-screen').classList.add('fade-out');
                    document.getElementById('app').classList.remove('hidden');
                    initAdmin();
                }, 1500);
            }
        };

        // Listen for auth state
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                window.loginSuccess(user);
            }
        });

        window.copyUid = () => {
            const uid = document.getElementById('uid-text').innerText;
            navigator.clipboard.writeText(uid);
            window.showToast("Đã copy UID!");
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        async function initAdmin() {
            window.initDefaults(); // Auto fix DB
            syncRealtimeTimer();
            loadDashboardStats();
            loadRequests();
            loadPromotions();
            loadUsers();
            loadGiftcodes();
            loadSettings();
        }

        // --- FIX 2 & 3: INIT AN TOÀN + TRY CATCH ---
        window.initDefaults = async () => {
            try {
                // Thêm merge: true để an toàn
                await setDoc(doc(db, "games", "current"), { totalUp: 0, totalDown: 0 }, { merge: true });
                await setDoc(doc(db, "settings", "global"), { minBet: 100, status: "on", killWhaleMode: false }, { merge: true });
                console.log("DB Checked/Initialized");
            } catch(e) { 
                console.error("Init Error (Check Rules Permission):", e); 
                // Không chặn app chạy tiếp nếu lỗi init
            }
        };

        // --- NAVIGATION ---
        window.switchTab = (tabName, el, title) => {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(el) el.classList.add('active'); // Fix crash if el is null
            if(title) document.getElementById('page-title').innerText = title;
            
            ['dashboard','requests','promo','users','giftcode','settings'].forEach(id => {
                document.getElementById('view-'+id).classList.add('hidden');
            });
            document.getElementById('view-'+tabName).classList.remove('hidden');
            if(window.innerWidth < 1024) document.getElementById('sidebar').classList.remove('active');
        };

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        // --- DASHBOARD LOGIC ---
        let lastResetMin = -1;
        function syncRealtimeTimer() {
            setInterval(() => {
                const now = new Date();
                const sec = now.getSeconds();
                document.getElementById('realTimeClock').innerText = `00:${(60-sec).toString().padStart(2,'0')}`;
                if(sec === 0 && now.getMinutes() !== lastResetMin) {
                    lastResetMin = now.getMinutes();
                    if(document.getElementById('autoResetToggle')?.checked) window.manualReset(true);
                }
            }, 1000);
        }

        window.manualReset = async (silent) => {
            try {
                await updateDoc(doc(db, "games", "current"), { totalUp: 0, totalDown: 0 });
                if(!silent) window.showToast("Đã reset phiên cược!");
            } catch(e) { console.error(e); }
        };

        function loadDashboardStats() {
            onSnapshot(doc(db, "games", "current"), s => {
                if(s.exists()) {
                    const d = s.data();
                    document.getElementById('live-up').innerText = "$"+(d.totalUp||0).toLocaleString();
                    document.getElementById('live-down').innerText = "$"+(d.totalDown||0).toLocaleString();
                }
            });
        }

        // --- REQUESTS LOGIC ---
        function loadRequests() {
            onSnapshot(query(collection(db, "admin_requests"), orderBy("timestamp", "desc")), snap => {
                allReqs = [];
                snap.forEach(d => allReqs.push({id: d.id, ...d.data()}));
                
                // Keep current filter active
                const activeBtn = document.querySelector('.sub-tab.active') || document.querySelector('.sub-tab');
                const currentFilter = activeBtn.innerText === 'Tất cả' ? 'all' : 
                                     (activeBtn.innerText.includes('Nạp') ? 'deposit' : 
                                     (activeBtn.innerText.includes('Rút') ? 'withdraw' : 'pending'));
                
                window.filterReq(currentFilter, activeBtn);
                
                const pending = allReqs.filter(x => x.status === 'pending').length;
                const badge = document.getElementById('badge-req');
                badge.innerText = pending;
                badge.style.display = pending > 0 ? 'inline' : 'none';
            });
        }

        window.filterReq = (filter, el) => {
            if(el) {
                document.querySelectorAll('.sub-tab').forEach(x => {
                    x.classList.remove('bg-[#FCD535]', 'text-black');
                    x.classList.add('bg-[#151A25]', 'text-white');
                });
                el.classList.remove('bg-[#151A25]', 'text-white');
                el.classList.add('bg-[#FCD535]', 'text-black');
            }

            let html = '';
            let depToday = 0, witToday = 0;

            allReqs.forEach(d => {
                // Calc stats
                if(d.status === 'success') {
                    const amt = parseFloat(d.amount)||0;
                    if(d.type === 'deposit') depToday += amt;
                    else witToday += amt;
                }

                if(filter !== 'all') {
                    if(filter === 'pending' && d.status !== 'pending') return;
                    if((filter === 'deposit' || filter === 'withdraw') && d.type !== filter) return;
                }
                const isDep = d.type === 'deposit';
                let sttClass = d.status==='pending' ? 'text-yellow-500' : (d.status==='success'?'text-green-500':'text-red-500');
                const timeStr = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString('vi-VN') : '-';
                
                html += `<tr class="group border-b border-[#2A303C]">
                    <td class="font-mono text-[10px] text-slate-500">${timeStr}</td>
                    <td class="font-bold text-white text-xs">${d.username||d.userId.slice(0,6)}...</td>
                    <td><span class="text-[10px] font-bold px-2 py-1 rounded ${isDep?'bg-green-500/10 text-green-500':'bg-red-500/10 text-red-500'}">${isDep?'NẠP':'RÚT'}</span></td>
                    <td class="font-bold text-white font-mono">$${parseFloat(d.amount).toLocaleString()}</td>
                    <td class="text-xs text-slate-400 font-bold">${d.bankInfo?.split('-')[0] || '-'}</td>
                    <td><span class="text-[10px] font-bold ${sttClass}">${d.status.toUpperCase()}</span></td>
                    <td class="text-right">
                        ${d.status==='pending' ? `<button onclick="window.openApproveModal('${d.id}')" class="btn btn-primary px-3 py-1 text-[10px] h-8">Xử Lý</button>` : ''}
                    </td>
                </tr>`;
            });
            document.getElementById('table-requests').innerHTML = html || '<tr><td colspan="7" class="text-center p-4 text-slate-500">Không có dữ liệu</td></tr>';
            
            document.getElementById('stat-dep-today').innerText = "$"+depToday.toLocaleString();
            document.getElementById('stat-wit-today').innerText = "$"+witToday.toLocaleString();
        };

        window.openApproveModal = (rid) => {
            activeReq = allReqs.find(x => x.id === rid);
            if(!activeReq) return;
            
            const b = activeReq.bankInfo ? activeReq.bankInfo.split(' - ') : ['-','-','-'];
            document.getElementById('modal-type').innerText = activeReq.type;
            document.getElementById('modal-amount').innerText = "$"+activeReq.amount.toLocaleString();
            document.getElementById('modal-uid').innerText = activeReq.userId;
            document.getElementById('modal-bank-name').innerText = b[0] || '-';
            document.getElementById('modal-bank-num').innerText = b[1] || '-';
            document.getElementById('modal-bank-owner').innerText = b[2] || '-';
            
            document.getElementById('div-turnover').style.display = activeReq.type === 'deposit' ? 'block' : 'none';
            document.getElementById('modal-turnover').value = activeReq.type === 'deposit' ? activeReq.amount : 0;
            document.getElementById('modal-approve').classList.add('active');
        };

        window.confirmTransaction = async () => {
            if(!activeReq) return;
            const turn = parseFloat(document.getElementById('modal-turnover').value) || 0;
            const btn = document.querySelector('#modal-approve .btn-success');
            const originalText = btn.innerText;
            btn.innerText = "Processing..."; btn.disabled = true;

            try {
                if(activeReq.type === 'deposit') {
                    const uRef = doc(db, "users", activeReq.userId);
                    const uSnap = await getDoc(uRef);
                    if(uSnap.exists()) {
                        const u = uSnap.data();
                        await updateDoc(uRef, { 
                            balance: (u.balance||0) + activeReq.amount, 
                            requiredTurnover: (u.requiredTurnover||0) + turn,
                            depositToday: (u.depositToday||0) + activeReq.amount
                        });
                    }
                }
                
                await updateDoc(doc(db, "admin_requests", activeReq.id), { status: 'success' });
                
                // Sync to user transactions
                const qTx = query(collection(db, "users", activeReq.userId, "transactions"), 
                    where("status", "==", "pending"), where("amount", "==", activeReq.amount), limit(1));
                const sTx = await getDocs(qTx);
                if(!sTx.empty) await updateDoc(sTx.docs[0].ref, { status: 'success' });
                else await addDoc(collection(db, "users", activeReq.userId, "transactions"), {
                    type: activeReq.type, amount: activeReq.amount, status: 'success', timestamp: serverTimestamp()
                });

                window.closeModal('modal-approve');
                window.showToast("Đã duyệt thành công!");
            } catch(e) { alert("Lỗi: "+e.message); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        };

        window.rejectTransaction = async () => {
            if(!activeReq || !confirm("Xác nhận TỪ CHỐI? Tiền sẽ hoàn về ví User nếu là Rút.")) return;
            try {
                if(activeReq.type === 'withdraw') {
                    const uRef = doc(db, "users", activeReq.userId);
                    const u = await getDoc(uRef);
                    if(u.exists()) await updateDoc(uRef, { balance: (u.data().balance||0) + activeReq.amount });
                }
                await updateDoc(doc(db, "admin_requests", activeReq.id), { status: 'rejected' });
                
                const qTx = query(collection(db, "users", activeReq.userId, "transactions"), 
                    where("status", "==", "pending"), where("amount", "==", activeReq.amount), limit(1));
                const sTx = await getDocs(qTx);
                if(!sTx.empty) await updateDoc(sTx.docs[0].ref, { status: 'rejected' });

                window.closeModal('modal-approve');
            } catch(e) { alert("Lỗi: "+e.message); }
        };

        // --- FIX 1: DÙNG ĐÚNG COLLECTION "promo_requests" ---
        function loadPromotions() {
            // FIX: promotion_requests -> promo_requests
            onSnapshot(query(collection(db, "promo_requests"), orderBy("timestamp", "desc")), snap => {
                allPromos = [];
                let pending = 0;
                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    allPromos.push(p);
                    if(p.status === 'pending') pending++;
                });
                
                const badge = document.getElementById('badge-promo');
                badge.innerText = pending;
                badge.style.display = pending > 0 ? 'inline' : 'none';
                
                renderPromoList();
            });
        }

        function renderPromoList() {
            let mHtml = '', dHtml = '';
            allPromos.forEach(p => {
                const bonus = p.bonusAmount || (p.type.includes('10') ? 10 : 0);
                const turn = p.turnoverRequire || bonus*5;
                const statusColor = p.status==='pending' ? 'text-yellow-400' : (p.status==='success'?'text-green-400':'text-red-400');
                const timeStr = p.timestamp?.toDate ? p.timestamp.toDate().toLocaleString('vi-VN') : '-';

                // Mobile
                mHtml += `<div class="glass-card p-4 rounded-xl border border-[#2A303C] mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-white text-xs">${p.username}</span>
                        <span class="text-[10px] font-bold ${statusColor}">${p.status.toUpperCase()}</span>
                    </div>
                    <div class="text-xs text-slate-400 space-y-1">
                        <div class="flex justify-between"><span>Loại:</span><span class="text-purple-400 font-bold">${p.type}</span></div>
                        <div class="flex justify-between"><span>Thưởng:</span><span class="text-green-400 font-bold">+$${bonus}</span></div>
                    </div>
                    ${p.status==='pending' ? `<div class="grid grid-cols-2 gap-2 mt-3">
                        <button onclick="window.rejectPromo('${p.id}')" class="btn btn-danger py-2 text-[10px]">Từ chối</button>
                        <button onclick="window.approvePromo('${p.id}', this)" class="btn btn-primary py-2 text-[10px]">Duyệt</button>
                    </div>` : ''}
                </div>`;

                // Desktop
                dHtml += `<tr>
                    <td class="text-slate-500 text-[10px] font-mono">${timeStr}</td>
                    <td class="text-white text-xs font-bold">${p.username}</td>
                    <td><span class="text-purple-400 text-[10px] font-bold border border-purple-500/30 px-2 py-1 rounded">${p.type}</span></td>
                    <td class="text-green-400 font-bold text-xs">+$${bonus}</td>
                    <td class="text-[#FCD535] font-bold text-xs">+${turn}</td>
                    <td><span class="text-[10px] font-bold ${statusColor}">${p.status.toUpperCase()}</span></td>
                    <td class="text-right">
                        ${p.status==='pending' ? `<div class="flex justify-end gap-2">
                            <button onclick="window.rejectPromo('${p.id}')" class="w-7 h-7 bg-red-500/10 text-red-500 rounded hover:bg-red-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                            <button onclick="window.approvePromo('${p.id}', this)" class="btn btn-primary px-3 py-1 text-[10px] h-7">Duyệt</button>
                        </div>` : ''}
                    </td>
                </tr>`;
            });
            document.getElementById('promo-mobile').innerHTML = mHtml || '<div class="text-center text-xs text-slate-500 italic">Trống</div>';
            document.getElementById('table-promo-desktop').innerHTML = dHtml || '<tr><td colspan="7" class="text-center p-4 text-slate-500">Trống</td></tr>';
        }

        window.approvePromo = async (pid, btn) => {
            if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; }
            try {
                // FIX: promotion_requests -> promo_requests
                const pRef = doc(db, "promo_requests", pid);
                const pSnap = await getDoc(pRef);
                if(!pSnap.exists() || pSnap.data().status !== 'pending') return;
                const pData = pSnap.data();

                const bonus = pData.bonusAmount || (pData.type.includes('10') ? 10 : 0);
                const turn = pData.turnoverRequire || bonus*5;

                const uRef = doc(db, "users", pData.userId);
                const uSnap = await getDoc(uRef);
                if(uSnap.exists()) {
                    await updateDoc(uRef, {
                        balance: (uSnap.data().balance||0) + bonus,
                        requiredTurnover: (uSnap.data().requiredTurnover||0) + turn
                    });
                    await addDoc(collection(db, "users", pData.userId, "transactions"), {
                        type: 'promo_bonus', amount: bonus, status: 'success', note: `Bonus: ${pData.type}`, timestamp: serverTimestamp()
                    });
                }

                await updateDoc(pRef, { status: 'success', approvedAt: serverTimestamp() });
                window.showToast("Duyệt khuyến mãi thành công");
            } catch(e) { alert("Lỗi: "+e.message); if(btn) btn.disabled = false; }
        };

        window.rejectPromo = async (pid) => {
            // FIX: promotion_requests -> promo_requests
            if(confirm("Từ chối KM này?")) await updateDoc(doc(db, "promo_requests", pid), { status: 'rejected', rejectedAt: serverTimestamp() });
        };

        // --- USERS LOGIC ---
        function loadUsers() {
            onSnapshot(collection(db, "users"), snap => {
                allUsers = [];
                let totalBal = 0;
                let html = '';
                snap.forEach(d => {
                    const u = {id: d.id, ...d.data()};
                    allUsers.push(u);
                    totalBal += (u.balance||0);
                    html += `<tr>
                        <td><div class="font-bold text-white text-xs">${u.fullName||'User'}</div><div class="text-[10px] text-slate-500 font-mono">${u.username||u.phone}</div></td>
                        <td class="font-mono text-green-400 font-bold">$${(u.balance||0).toLocaleString()}</td>
                        <td class="text-xs text-slate-400">${(u.betTurnover||0).toLocaleString()} / ${(u.requiredTurnover||0).toLocaleString()}</td>
                        <td class="text-xs text-slate-400">${u.bankName||'-'}</td>
                        <td class="text-right"><button onclick="window.openUserEdit('${u.id}')" class="text-slate-400 hover:text-[#FCD535]"><i class="fa-solid fa-pen-to-square"></i></button></td>
                    </tr>`;
                });
                
                document.getElementById('table-users').innerHTML = html || '<tr><td colspan="5" class="text-center p-4 text-slate-500">Chưa có user</td></tr>';
                document.getElementById('stat-users').innerText = allUsers.length;
                document.getElementById('stat-balance').innerText = "$" + totalBal.toLocaleString();
            });
        }

        window.filterUsers = () => {
            const k = document.getElementById('searchUser').value.toLowerCase();
            document.querySelectorAll('#table-users tr').forEach(r => {
                r.style.display = r.innerText.toLowerCase().includes(k) ? '' : 'none';
            });
        };

        window.openUserEdit = (uid) => {
            const u = allUsers.find(x => x.id === uid);
            if(!u) return;

            document.getElementById('edit-user-id').value = uid;
            document.getElementById('edit-fullname').value = u.fullName || '';
            document.getElementById('edit-phone').value = u.phone || '';
            document.getElementById('edit-bank').value = u.bankName || '';
            document.getElementById('edit-current-bal').innerText = "$" + (u.balance || 0).toLocaleString();

            document.getElementById('edit-adjust-bal').value = '';
            document.getElementById('modal-user-edit').classList.add('active');
        };

        window.saveUserEdit = async () => {
            const uid = document.getElementById('edit-user-id').value;
            const balAdj = parseFloat(document.getElementById('edit-adjust-bal').value) || 0;
            const u = allUsers.find(x => x.id === uid);
            if(!u) return;
            
            if(confirm(`Cập nhật User ${u.username}?`)) {
                try {
                    await updateDoc(doc(db, "users", uid), {
                        fullName: document.getElementById('edit-fullname').value,
                        phone: document.getElementById('edit-phone').value,
                        bankName: document.getElementById('edit-bank').value,
                        balance: (u.balance||0) + balAdj
                    });
                    if(balAdj !== 0) {
                        await addDoc(collection(db, "users", uid, "transactions"), {
                            type: balAdj > 0 ? 'admin_add' : 'admin_sub', amount: Math.abs(balAdj), status: 'success', note: 'Admin Adjust', timestamp: serverTimestamp()
                        });
                    }
                    window.closeModal('modal-user-edit');
                    window.showToast("Cập nhật thành công!");
                } catch(e) { alert("Lỗi: "+e.message); }
            }
        };

        // --- GIFTCODE & SETTINGS ---
        window.createGiftcode = async () => {
            const a = parseFloat(document.getElementById('gcAmount').value);
            const l = parseInt(document.getElementById('gcLimit').value);
            if(!a || !l) return alert("Nhập đủ thông tin!");
            const code = 'CR' + Math.random().toString(36).substring(2,8).toUpperCase();
            await setDoc(doc(db, "giftcodes", code), { 
                amount: a, limit: l, turnoverReq: parseFloat(document.getElementById('gcTurnover').value)||0, usedCount: 0, usersClaimed: [], createdAt: Date.now() 
            });
            window.showToast("Tạo code thành công: " + code);
        };
        
        function loadGiftcodes() {
            onSnapshot(collection(db, "giftcodes"), snap => {
                let html = '';
                snap.forEach(d => {
                    const k = d.data();
                    html += `<tr>
                        <td class="font-bold text-[#FCD535] font-mono select-all text-xs">${d.id}</td>
                        <td class="text-green-400 font-bold text-xs">$${k.amount}</td>
                        <td class="text-xs text-slate-400">${k.usedCount}/${k.limit}</td>
                        <td class="text-right"><i onclick="window.deleteGiftcode('${d.id}')" class="fa-solid fa-trash text-slate-600 hover:text-red-500 cursor-pointer"></i></td>
                    </tr>`;
                });
                document.getElementById('table-giftcode').innerHTML = html;
            });
        }
        window.deleteGiftcode = async (id) => { if(confirm("Xóa code này?")) await deleteDoc(doc(db, "giftcodes", id)); };

        const setRef = doc(db, "settings", "global");
        function loadSettings() {
            onSnapshot(setRef, s => {
                if(s.exists()) {
                    const data = s.data();
                    document.getElementById('killWhaleToggle').checked = data.killWhaleMode;
                    document.getElementById('priceOffset').value = data.marketOffset || 0;
                    document.getElementById('offsetDisplay').innerText = data.marketOffset || 0;
                    
                    // Kill Whale Flip Time
                    const ft = data.flipTime || 6;
                    document.getElementById('flipTime').value = ft;
                    document.getElementById('flipTimeDisplay').innerText = ft + 's';
                }
            });
        }
        
        window.saveKillWhaleConfig = async () => {
            const mode = document.getElementById('killWhaleToggle').checked;
            const time = parseInt(document.getElementById('flipTime').value);
            await setDoc(setRef, {
                killWhaleMode: mode,
                flipTime: time
            }, {merge:true});
            window.showToast(mode ? `Đã BẬT Kill Whale (Bẻ cầu ${time}s cuối)` : "Đã TẮT Kill Whale");
        };

        window.saveConfig = async () => { 
            await setDoc(setRef, {marketOffset: parseInt(document.getElementById('priceOffset').value)}, {merge:true});
            window.showToast("Đã lưu Offset giá!");
        };
        
        document.getElementById('priceOffset').addEventListener('input', (e) => document.getElementById('offsetDisplay').innerText = e.target.value);

    </script>
</body>
</html>

