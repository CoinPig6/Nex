<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CROWNEX ADMIN V9 - MOBILE PRO</title>
    <!-- Thư viện Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icon FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Font chữ Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { 
                        gold: '#FCD535', 
                        goldHover: '#EAB308',
                        dark: '#0B0E14', 
                        panel: '#151A25', 
                        border: '#2A303C',
                        success: '#10b981',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS CƠ BẢN */
        body { background-color: #0B0E14; color: #94a3b8; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* HIỆU ỨNG */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* THANH CUỘN */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #0B0E14; }
        ::-webkit-scrollbar-thumb { background: #2A303C; border-radius: 4px; }
        
        /* SIDEBAR */
        .sidebar { 
            width: 280px; height: 100vh; position: fixed; top: 0; left: 0; z-index: 60; 
            background: rgba(21, 26, 37, 0.95); backdrop-filter: blur(12px);
            border-right: 1px solid #2A303C; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; 
            box-shadow: 4px 0 24px rgba(0,0,0,0.3);
        }
        
        /* HEADER & CONTENT */
        .top-header {
            position: fixed; top: 0; right: 0; left: 280px; height: 70px; z-index: 40;
            background: rgba(11, 14, 20, 0.8); backdrop-filter: blur(12px);
            border-bottom: 1px solid #2A303C;
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
            transition: left 0.3s;
        }
        .main-content { margin-left: 280px; padding: 30px; padding-top: 100px; min-height: 100vh; transition: margin-left 0.3s; }
        
        /* MENU ITEMS */
        .nav-item { 
            display: flex; items-center; gap: 14px; padding: 14px 24px; margin: 4px 12px; border-radius: 8px;
            color: #64748b; font-weight: 500; font-size: 14px; transition: all 0.2s ease; cursor: pointer; position: relative;
        }
        .nav-item:hover { color: #fff; background: rgba(255,255,255,0.03); }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(252, 213, 53, 0.15), rgba(252, 213, 53, 0.05)); 
            color: #FCD535; font-weight: 700; 
        }
        .nav-item.active::before {
            content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 4px; height: 20px; background: #FCD535; border-radius: 0 4px 4px 0;
        }
        
        /* UI COMPONENTS */
        .glass-card { background: #151A25; border: 1px solid #2A303C; box-shadow: 0 8px 24px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .input-box { width: 100%; background: #0f131a; border: 1px solid #2A303C; color: white; padding: 12px 16px; border-radius: 10px; font-size: 13px; outline: none; }
        .input-box:focus { border-color: #FCD535; }
        
        .btn { padding: 10px 24px; border-radius: 10px; font-weight: 600; font-size: 13px; transition: all 0.2s; display: inline-flex; items-center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, #FCD535 0%, #F59E0B 100%); color: #000; border: none; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }

        /* TABLE & RESPONSIVE LIST */
        .table-container { border-radius: 16px; overflow: hidden; border: 1px solid #2A303C; background: #11151D; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #1A202C; color: #94a3b8; font-size: 11px; font-weight: 800; text-transform: uppercase; padding: 18px; border-bottom: 1px solid #2A303C; }
        td { padding: 16px 18px; color: #e2e8f0; font-size: 13px; border-bottom: 1px solid #2A303C; }
        tr:last-child td { border-bottom: none; }

        /* MOBILE CARD VIEW FOR TABLES */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tr { display: flex; flex-direction: column; background: #151A25; margin-bottom: 12px; border-radius: 12px; border: 1px solid #2A303C; padding: 12px; }
            .mobile-table td { padding: 8px 0; border: none; display: flex; justify-content: space-between; align-items: center; width: 100%; }
            /* Label cho mobile */
            .mobile-table td:before { content: attr(data-label); font-weight: bold; font-size: 11px; color: #64748b; text-transform: uppercase; margin-right: 10px; }
            .mobile-table td:last-child { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #2A303C; justify-content: flex-end; }
            .mobile-table td:last-child:before { content: ""; display: none; }
        }

        /* RESPONSIVE LAYOUT */
        .hamburger-btn { display: none; background: #2A303C; border: none; color: white; width: 40px; height: 40px; border-radius: 10px; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
        
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 16px; padding-top: 80px; }
            .top-header { left: 0; padding: 0 16px; height: 60px; }
            .hamburger-btn { display: flex; }
            .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 50; display: none; opacity: 0; transition: opacity 0.3s; }
            .sidebar.active ~ .sidebar-overlay { display: block; opacity: 1; }
        }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: #151A25; width: 100%; max-width: 450px; border-radius: 20px; border: 1px solid #333; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-[#0B0E14] z-[999] flex flex-col items-center justify-center bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
        <div class="relative w-20 h-20 bg-[#151A25] rounded-2xl flex items-center justify-center border border-yellow-500/30 mb-8 shadow-2xl">
            <span class="text-4xl font-black text-[#FCD535]">A</span>
        </div>
        <h1 class="text-2xl font-bold text-white mb-8">ADMIN CROWNEX V9</h1>
        <div class="w-full max-w-xs space-y-4">
            <input type="password" id="adminPin" class="w-full text-center bg-[#151A25] border border-[#2A303C] text-[#FCD535] text-2xl tracking-[1em] py-4 rounded-xl outline-none" placeholder="••••" maxlength="4">
            <button onclick="checkPin()" id="btnLogin" class="btn btn-primary w-full py-4 text-sm font-bold">TRUY CẬP</button>
            <div id="pinError" class="text-red-500 text-center text-xs hidden">Mã PIN sai!</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden min-h-screen bg-[#0B0E14]">
        
        <!-- HEADER -->
        <header class="top-header">
            <button onclick="toggleSidebar()" class="hamburger-btn"><i class="fa-solid fa-bars-staggered"></i></button>
            <div class="flex flex-col">
                <h2 id="page-title" class="text-lg font-bold text-white leading-tight">Dashboard</h2>
                <span class="text-[10px] text-green-500 font-mono hidden md:block">● SYSTEM ONLINE</span>
            </div>
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#FCD535] to-[#f59e0b] flex items-center justify-center text-black font-bold text-xs shadow-lg">AD</div>
        </header>

        <!-- SIDEBAR -->
        <div id="sidebar" class="sidebar">
            <div class="h-[70px] flex items-center px-6 border-b border-[#2A303C] bg-[#11151D]">
                <div class="w-8 h-8 bg-[#FCD535] rounded-lg flex items-center justify-center text-black font-black mr-3">C</div>
                <div class="font-bold text-white text-sm">CROWNEX <span class="text-[#FCD535] text-[10px]">V9</span></div>
            </div>
            <div class="flex-1 overflow-y-auto py-6 px-2 space-y-1">
                <div class="nav-item active" onclick="switchTab('dashboard', this, 'Tổng Quan')"><i class="fa-solid fa-chart-pie w-5"></i> Dashboard</div>
                <div class="nav-item" onclick="switchTab('requests', this, 'Nạp / Rút Tiền')">
                    <i class="fa-solid fa-money-bill-transfer w-5"></i> Nạp Rút
                    <span id="badge-req" class="ml-auto bg-red-500 text-white text-[9px] font-bold px-1.5 rounded hidden">0</span>
                </div>
                <div class="nav-item" onclick="switchTab('promo', this, 'Duyệt Khuyến Mãi')">
                    <i class="fa-solid fa-gift w-5"></i> Khuyến Mãi
                    <span id="badge-promo" class="ml-auto bg-purple-500 text-white text-[9px] font-bold px-1.5 rounded hidden">0</span>
                </div>
                <div class="nav-item" onclick="switchTab('users', this, 'Người Chơi')"><i class="fa-solid fa-users w-5"></i> Người Chơi</div>
                <div class="nav-item" onclick="switchTab('settings', this, 'Cấu Hình')"><i class="fa-solid fa-sliders w-5"></i> Cấu Hình</div>
            </div>
            <div class="p-4 border-t border-[#2A303C]"><button onclick="location.reload()" class="w-full btn bg-[#1C2230] text-slate-400">Đăng Xuất</button></div>
        </div>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- CONTENT -->
        <div class="main-content">
            
            <!-- 1. DASHBOARD -->
            <div id="view-dashboard" class="fade-in">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Thành viên</div>
                        <div class="text-2xl font-bold text-white mt-1" id="stat-users">0</div>
                    </div>
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Tổng Số Dư</div>
                        <div class="text-2xl font-bold text-green-400 mt-1" id="stat-balance">$0</div>
                    </div>
                </div>
                
                <!-- Live Game Monitor -->
                <div class="glass-card p-1 rounded-2xl border-red-500/30 border mb-6">
                    <div class="bg-red-500/5 p-4 rounded-xl flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="w-full flex justify-around">
                            <div class="text-center"><div class="text-[10px] text-slate-500 font-bold">DOWN</div><div class="text-xl font-bold text-red-400" id="live-down">$0</div></div>
                            <div class="w-px bg-slate-700/50"></div>
                            <div class="text-center"><div class="text-[10px] text-slate-500 font-bold">UP</div><div class="text-xl font-bold text-green-400" id="live-up">$0</div></div>
                        </div>
                        <button onclick="manualReset()" class="btn bg-[#2A303C] text-white text-xs w-full md:w-auto"><i class="fa-solid fa-rotate-right"></i> Reset Phiên</button>
                    </div>
                </div>
            </div>

            <!-- 2. NẠP RÚT (MOBILE CARD) -->
            <div id="view-requests" class="hidden fade-in">
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button class="btn bg-[#2A303C] text-white text-xs whitespace-nowrap" onclick="filterReq('all')">Tất cả</button>
                    <button class="btn bg-[#2A303C] text-white text-xs whitespace-nowrap" onclick="filterReq('deposit')">Nạp tiền</button>
                    <button class="btn bg-[#2A303C] text-white text-xs whitespace-nowrap" onclick="filterReq('withdraw')">Rút tiền</button>
                </div>
                <div class="table-container bg-transparent border-0 md:bg-[#11151D] md:border md:border-[#2A303C]">
                    <table class="mobile-table w-full">
                        <thead>
                            <tr><th>Thời gian</th><th>User</th><th>Loại</th><th>Số tiền</th><th>NH</th><th>Trạng thái</th><th class="text-right">Hành động</th></tr>
                        </thead>
                        <tbody id="table-requests"></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. KHUYẾN MÃI (LOGIC MỚI + MOBILE CARD) -->
            <div id="view-promo" class="hidden fade-in">
                <div class="glass-card p-4 rounded-xl mb-4 bg-gradient-to-r from-purple-900/20 to-transparent border-purple-500/30 border">
                    <h3 class="text-purple-400 font-bold text-xs uppercase mb-1">Cơ chế tự động</h3>
                    <p class="text-[10px] text-slate-400">Hệ thống sẽ tự động tính thưởng dựa trên <b>NẠP HÔM NAY</b> của khách.</p>
                </div>
                <div class="table-container bg-transparent border-0 md:bg-[#11151D] md:border md:border-[#2A303C]">
                    <table class="mobile-table w-full">
                        <thead>
                            <tr><th>Thời gian</th><th>User</th><th>Loại KM</th><th>Nội dung</th><th class="text-right">Duyệt nhanh</th></tr>
                        </thead>
                        <tbody id="table-promo"></tbody>
                    </table>
                </div>
            </div>

            <!-- 4. USERS -->
            <div id="view-users" class="hidden fade-in">
                <div class="mb-4 relative">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-500 text-xs"></i>
                    <input type="text" id="searchUser" oninput="filterUsers()" placeholder="Tìm User..." class="input-box pl-9">
                </div>
                <div class="table-container bg-transparent border-0 md:bg-[#11151D] md:border md:border-[#2A303C]">
                    <table class="mobile-table w-full">
                        <thead><tr><th>User</th><th>Số dư</th><th>Cược</th><th>NH</th><th class="text-right">Edit</th></tr></thead>
                        <tbody id="table-users"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. SETTINGS -->
            <div id="view-settings" class="hidden fade-in">
                <div class="glass-card p-6 rounded-2xl border-red-500/30 border">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-white">KILL WHALE MODE</div>
                            <div class="text-xs text-slate-500">Chế độ "Giết Cá Voi"</div>
                        </div>
                        <input type="checkbox" id="killWhaleToggle" onchange="toggleKillWhale()" class="w-6 h-6 accent-red-500">
                    </div>
                </div>
                <div class="glass-card p-6 rounded-2xl mt-4">
                    <div class="text-xs font-bold text-slate-400 mb-2">ĐIỀU CHỈNH GIÁ (OFFSET)</div>
                    <input type="range" id="priceOffset" min="-50" max="50" value="0" class="w-full accent-blue-500">
                    <div class="text-center text-white font-bold mt-2" id="offsetDisplay">0</div>
                    <button onclick="saveConfig()" class="btn bg-white text-black w-full mt-4">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DUYỆT NẠP RÚT -->
    <div id="modal-approve" class="modal-overlay">
        <div class="modal-content animate-fade-in-up">
            <div class="bg-[#1C2230] p-4 flex justify-between items-center border-b border-[#2A303C]">
                <h3 class="text-sm font-bold text-white uppercase">Xử Lý Giao Dịch</h3>
                <button onclick="closeModal('modal-approve')" class="text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="text-3xl font-bold text-white font-mono" id="modal-amount">$0</div>
                    <div class="text-xs font-bold uppercase mt-1" id="modal-type-text">...</div>
                    <div class="text-xs text-slate-500 mt-2 font-mono" id="modal-uid">UID: ...</div>
                </div>
                <div id="div-turnover" class="mb-4">
                    <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Yêu cầu cược thêm</label>
                    <input type="number" id="modal-turnover" class="input-box bg-[#0B0E14]" value="0">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="rejectTransaction()" class="btn btn-danger w-full bg-red-500/10 border border-red-500/20">Từ Chối</button>
                    <button onclick="confirmTransaction()" class="btn btn-success w-full font-bold">DUYỆT NGAY</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, setDoc, getDoc, addDoc, serverTimestamp, getDocs, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU", authDomain: "btccoinbig.firebaseapp.com", projectId: "btccoinbig", storageBucket: "btccoinbig.firebasestorage.app", messagingSenderId: "116892525933", appId: "1:116892525933:web:04b0da25f3f933ce162664" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let allReqs = [];
        let activeReq = null;
        let allUsers = [];

        // AUTH
        window.checkPin = async () => {
            const btn = document.getElementById('btnLogin');
            if(document.getElementById('adminPin').value === "9999") {
                btn.innerText = "ĐANG TẢI...";
                try {
                    await signInAnonymously(auth);
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                    initAdmin();
                } catch(e) { alert(e.message); btn.innerText = "TRUY CẬP"; }
            } else { document.getElementById('pinError').classList.remove('hidden'); }
        };

        function initAdmin() {
            loadRequests();
            loadPromotions();
            loadUsers();
            loadDashboard();
        }

        // UI HELPERS
        window.switchTab = (id, el, title) => {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('page-title').innerText = title || 'Dashboard';
            ['dashboard','requests','promo','users','settings'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            if(window.innerWidth < 1024) document.getElementById('sidebar').classList.remove('active');
        };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');

        // DASHBOARD
        function loadDashboard() {
            onSnapshot(doc(db, "games", "current"), (s) => {
                if(s.exists()) {
                    document.getElementById('live-up').innerText = "$"+(s.data().totalUp||0).toLocaleString();
                    document.getElementById('live-down').innerText = "$"+(s.data().totalDown||0).toLocaleString();
                }
            });
            onSnapshot(doc(db, "settings", "global"), (s) => {
                if(s.exists()) {
                    document.getElementById('killWhaleToggle').checked = s.data().killWhaleMode;
                    document.getElementById('priceOffset').value = s.data().marketOffset || 0;
                    document.getElementById('offsetDisplay').innerText = s.data().marketOffset || 0;
                }
            });
        }
        window.manualReset = async () => { if(confirm("Reset phiên?")) await updateDoc(doc(db, "games", "current"), {totalUp:0, totalDown:0}); };
        window.saveConfig = async () => { await updateDoc(doc(db, "settings", "global"), {marketOffset: parseInt(document.getElementById('priceOffset').value)}); alert("Đã lưu!"); };
        window.toggleKillWhale = async () => await updateDoc(doc(db, "settings", "global"), {killWhaleMode: document.getElementById('killWhaleToggle').checked});
        document.getElementById('priceOffset').addEventListener('input', (e) => document.getElementById('offsetDisplay').innerText = e.target.value);

        // --- 1. NẠP RÚT (MOBILE READY) ---
        function loadRequests() {
            onSnapshot(query(collection(db, "admin_requests"), orderBy("timestamp", "desc")), (snap) => {
                allReqs = []; snap.forEach(d => allReqs.push({id: d.id, ...d.data()}));
                renderReqs('all');
                const p = allReqs.filter(x=>x.status==='pending').length;
                document.getElementById('badge-req').innerText = p;
                document.getElementById('badge-req').style.display = p>0?'inline':'none';
            });
        }
        window.filterReq = (t) => renderReqs(t);
        function renderReqs(filter) {
            let html = '';
            allReqs.forEach(d => {
                if(filter!=='all' && d.type!==filter && !(filter==='withdraw' && d.type==='withdraw')) return;
                const isDep = d.type === 'deposit';
                const statusColor = d.status==='pending'?'text-yellow-500':(d.status==='success'?'text-green-500':'text-red-500');
                
                // Mobile Card & Desktop Row Hybrid
                html += `<tr class="border-b border-[#2A303C] hover:bg-[#1A202C]">
                    <td data-label="Thời gian" class="text-slate-500 font-mono text-xs">${d.timestamp?new Date(d.timestamp.toDate()).toLocaleTimeString():'--:--'}</td>
                    <td data-label="User" class="font-bold text-white text-xs">${d.username||'User'}</td>
                    <td data-label="Loại" class="font-bold uppercase text-xs ${isDep?'text-green-400':'text-red-400'}">${isDep?'Nạp':'Rút'}</td>
                    <td data-label="Số tiền" class="font-black text-[#FCD535] font-mono">$${parseFloat(d.amount).toLocaleString()}</td>
                    <td data-label="Ngân hàng" class="text-slate-400 text-xs truncate max-w-[100px]">${d.bankInfo?.split('-')[0]||'-'}</td>
                    <td data-label="Trạng thái" class="font-bold text-xs uppercase ${statusColor}">${d.status}</td>
                    <td data-label="Hành động" class="text-right">
                        ${d.status==='pending' ? `<button onclick="openApprove('${d.id}')" class="btn btn-primary px-3 py-1 text-[10px]">Xử Lý</button>` : ''}
                    </td>
                </tr>`;
            });
            document.getElementById('table-requests').innerHTML = html;
        }

        window.openApprove = (id) => {
            activeReq = allReqs.find(x => x.id === id);
            if(!activeReq) return;
            document.getElementById('modal-amount').innerText = "$"+parseFloat(activeReq.amount).toLocaleString();
            document.getElementById('modal-type-text').innerText = activeReq.type==='deposit'?'YÊU CẦU NẠP':'YÊU CẦU RÚT';
            document.getElementById('modal-type-text').className = `text-xs font-bold uppercase mt-1 ${activeReq.type==='deposit'?'text-green-500':'text-red-500'}`;
            document.getElementById('modal-uid').innerText = "UID: "+activeReq.userId;
            
            if(activeReq.type === 'deposit') {
                document.getElementById('div-turnover').style.display = 'block';
                document.getElementById('modal-turnover').value = activeReq.amount;
            } else {
                document.getElementById('div-turnover').style.display = 'none';
            }
            document.getElementById('modal-approve').classList.add('active');
        };

        window.confirmTransaction = async () => {
            if(!activeReq) return;
            const btn = document.querySelector('#modal-approve .btn-success');
            btn.innerText = "..."; btn.disabled = true;
            try {
                // 1. Nếu là nạp: Cộng tiền + Cộng depositToday (quan trọng cho KM)
                if(activeReq.type === 'deposit') {
                    const uRef = doc(db, "users", activeReq.userId);
                    const uSnap = await getDoc(uRef);
                    const turn = parseFloat(document.getElementById('modal-turnover').value) || 0;
                    if(uSnap.exists()) {
                        await updateDoc(uRef, {
                            balance: (uSnap.data().balance||0) + activeReq.amount,
                            requiredTurnover: (uSnap.data().requiredTurnover||0) + turn,
                            depositToday: (uSnap.data().depositToday||0) + activeReq.amount, // CẬP NHẬT ĐỂ TÍNH KM
                            lastDepositDate: new Date().toDateString() // Reset ngày nạp
                        });
                    }
                }
                // 2. Cập nhật Admin Request
                await updateDoc(doc(db, "admin_requests", activeReq.id), {status:'success'});
                
                // 3. Cập nhật User Transaction (Tìm pending update lên success)
                const qTx = query(collection(db, "users", activeReq.userId, "transactions"), where("status","==","pending"), where("type","==",activeReq.type), where("amount","==",activeReq.amount), limit(1));
                const txSnap = await getDocs(qTx);
                if(!txSnap.empty) await updateDoc(txSnap.docs[0].ref, {status:'success'});
                else await addDoc(collection(db, "users", activeReq.userId, "transactions"), {type: activeReq.type, amount: activeReq.amount, status: 'success', timestamp: serverTimestamp()});

                closeModal('modal-approve');
            } catch(e) { alert(e.message); } finally { btn.innerText = "DUYỆT NGAY"; btn.disabled = false; }
        };

        window.rejectTransaction = async () => {
            if(!activeReq) return;
            if(!confirm("Từ chối giao dịch?")) return;
            // Nếu rút -> Hoàn tiền
            if(activeReq.type === 'withdraw') {
                const uRef = doc(db, "users", activeReq.userId);
                const s = await getDoc(uRef);
                if(s.exists()) await updateDoc(uRef, {balance: (s.data().balance||0) + activeReq.amount});
            }
            await updateDoc(doc(db, "admin_requests", activeReq.id), {status:'rejected'});
            // Sync user tx
            const qTx = query(collection(db, "users", activeReq.userId, "transactions"), where("status","==","pending"), where("type","==",activeReq.type), where("amount","==",activeReq.amount), limit(1));
            const txSnap = await getDocs(qTx);
            if(!txSnap.empty) await updateDoc(txSnap.docs[0].ref, {status:'rejected'});
            
            closeModal('modal-approve');
        };

        // --- 2. KHUYẾN MÃI (LOGIC TÍNH TOÁN CAO CẤP) ---
        function loadPromotions() {
            onSnapshot(query(collection(db, "promotion_requests"), orderBy("timestamp", "desc")), (snap) => {
                let html = '', count = 0;
                snap.forEach(d => {
                    const v = d.data();
                    if(v.status === 'pending') {
                        count++;
                        let typeLabel = v.type;
                        if(v.type === 'deposit_1') typeLabel = 'Nạp Đầu 100%';
                        else if(v.type === 'deposit_2') typeLabel = 'Nạp Lần 2 (50%)';
                        else if(v.type === 'weekend_50') typeLabel = 'Cuối Tuần (50%)';
                        else if(v.type === 'daily_10') typeLabel = 'Mỗi Ngày 10%';
                        else if(v.type === 'newbie') typeLabel = 'Tân Thủ';

                        html += `<tr class="border-b border-[#2A303C]">
                            <td data-label="Thời gian" class="text-slate-500 text-xs font-mono">${v.timestamp?new Date(v.timestamp).toLocaleTimeString():'--:--'}</td>
                            <td data-label="User" class="text-white text-xs font-bold">${v.username||'User'}</td>
                            <td data-label="Loại KM" class="text-purple-400 text-xs font-black uppercase">${typeLabel}</td>
                            <td data-label="Chi tiết" class="text-slate-400 text-[10px] italic">UID: ${v.userId.slice(0,5)}...</td>
                            <td data-label="Hành động" class="text-right">
                                <button onclick="quickApprovePromo('${d.id}','${v.userId}','${v.type}')" class="btn btn-primary px-3 py-1 text-[10px]">Duyệt</button>
                            </td>
                        </tr>`;
                    }
                });
                document.getElementById('table-promo').innerHTML = html || '<tr><td colspan="5" class="p-4 text-center text-slate-500 text-xs">Không có yêu cầu nào</td></tr>';
                document.getElementById('badge-promo').innerText = count;
                document.getElementById('badge-promo').style.display = count>0?'inline':'none';
            });
        }

        // LOGIC TÍNH TOÁN KHUYẾN MÃI THÔNG MINH
        window.quickApprovePromo = async (rid, uid, type) => {
            const btn = event.target;
            btn.innerText = "..."; btn.disabled = true;

            try {
                // 1. Lấy dữ liệu User để biết depositToday
                const uRef = doc(db, "users", uid);
                const uSnap = await getDoc(uRef);
                if(!uSnap.exists()) throw new Error("User không tồn tại");
                
                const u = uSnap.data();
                const depositToday = u.depositToday || 0; // Số tiền nạp hôm nay làm gốc
                
                // 2. Tính toán Bonus & Vòng cược
                let bonus = 0;
                let reqTurnover = 0;
                let note = "";

                if(type === 'newbie') {
                    bonus = 5; // Tặng cứng $5
                    reqTurnover = 5 * 3; // x3
                    note = "Quà tân thủ";
                } 
                else if (type === 'deposit_1') { // 100%
                    if(depositToday < 200) throw new Error(`Khách mới nạp $${depositToday}. Yêu cầu tối thiểu $200!`);
                    bonus = Math.min(depositToday, 1000); // Max 1000
                    reqTurnover = (depositToday + bonus) * 3;
                    note = `Nạp đầu 100% (Gốc: ${depositToday})`;
                }
                else if (type === 'deposit_2') { // 50%
                    bonus = Math.min(depositToday * 0.5, 1000);
                    reqTurnover = (depositToday + bonus) * 5;
                    note = `Nạp lần 2 50% (Gốc: ${depositToday})`;
                }
                else if (type === 'weekend_50') { // 50%
                    bonus = Math.min(depositToday * 0.5, 1000);
                    reqTurnover = (depositToday + bonus) * 5;
                    note = `KM Cuối Tuần 50% (Gốc: ${depositToday})`;
                }
                else if (type === 'daily_10') { // 10%
                    bonus = depositToday * 0.1;
                    reqTurnover = (depositToday + bonus) * 2;
                    note = `Nạp mỗi ngày 10% (Gốc: ${depositToday})`;
                }

                if(bonus <= 0) throw new Error("Không tính được tiền thưởng (Khách chưa nạp hôm nay?)");

                if(!confirm(`DUYỆT KM: ${type}\n- Nạp hôm nay: $${depositToday}\n- Thưởng thêm: $${bonus}\n- Cược thêm: $${reqTurnover}\n\nXác nhận?`)) return;

                // 3. Update User
                await updateDoc(uRef, {
                    balance: (u.balance || 0) + bonus,
                    requiredTurnover: (u.requiredTurnover || 0) + reqTurnover
                });

                // 4. Update Promo Request
                await updateDoc(doc(db, "promotion_requests", rid), { status: 'success' });

                // 5. Log Transaction
                await addDoc(collection(db, "users", uid, "transactions"), {
                    type: 'promotion',
                    amount: bonus,
                    note: note,
                    status: 'success',
                    timestamp: serverTimestamp() // Dùng serverTimestamp cho admin log
                });

                alert("Duyệt thành công! Đã cộng $" + bonus);

            } catch (e) {
                alert("Lỗi: " + e.message);
            } finally {
                btn.innerText = "Duyệt"; btn.disabled = false;
            }
        };

        // 3. USERS
        function loadUsers() {
            onSnapshot(collection(db, "users"), (snap) => {
                allUsers = [];
                let totalBal = 0;
                let html = '';
                snap.forEach(d => {
                    const u = d.data();
                    allUsers.push({id: d.id, ...u});
                    totalBal += (u.balance||0);
                    html += `<tr class="border-b border-[#2A303C]">
                        <td data-label="User" class="text-white text-xs font-bold flex flex-col"><span>${u.fullName||'No Name'}</span><span class="text-[10px] text-slate-500 font-mono">${u.username}</span></td>
                        <td data-label="Số dư" class="text-green-400 font-mono font-bold">$${(u.balance||0).toLocaleString()}</td>
                        <td data-label="Cược" class="text-slate-400 text-xs">${(u.betTurnover||0).toLocaleString()} / ${(u.requiredTurnover||0).toLocaleString()}</td>
                        <td data-label="NH" class="text-slate-500 text-xs">${u.bankName||'-'}</td>
                        <td data-label="Edit" class="text-right"><button class="text-[#FCD535]"><i class="fa-solid fa-pen"></i></button></td>
                    </tr>`;
                });
                document.getElementById('table-users').innerHTML = html;
                document.getElementById('stat-users').innerText = allUsers.length;
                document.getElementById('stat-balance').innerText = "$"+totalBal.toLocaleString();
            });
        }
        window.filterUsers = () => {
            const k = document.getElementById('searchUser').value.toLowerCase();
            document.querySelectorAll('#table-users tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(k)?'':'none');
        };

    </script>
</body>
</html>

