<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crownex Pro - Professional Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* CORE SETUP */
        :root { --up: #0ECB81; --down: #F6465D; --primary: #FCD535; --bg: #0b0f19; --panel: #13161f; --border: #232836; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #EAECEF; overflow: hidden; height: 100vh; touch-action: none; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'IBM Plex Mono', monospace; }
        
        /* UTILITIES */
        .text-up { color: var(--up) !important; } .bg-up { background-color: var(--up) !important; }
        .text-down { color: var(--down) !important; } .bg-down { background-color: var(--down) !important; }
        .text-primary { color: var(--primary) !important; } .bg-primary { background-color: var(--primary) !important; }
        
        /* COMPONENTS */
        .btn-trade { position: relative; overflow: hidden; transition: transform 0.1s, opacity 0.2s; border-bottom: 3px solid rgba(0,0,0,0.2); }
        .btn-trade:active { transform: translateY(2px); border-bottom-width: 1px; }
        .btn-trade.disabled { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        
        .quick-btn { background: #1e232e; border: 1px solid #2d3442; color: #9ca3af; font-size: 11px; font-weight: 600; border-radius: 6px; transition: all 0.2s; }
        .quick-btn:active { background: #FCD535; color: #000; border-color: #FCD535; }

        /* CANVAS & CHART UI */
        #chart-container { position: relative; width: 100%; flex: 1; overflow: hidden; cursor: crosshair; }
        .price-line { position: absolute; right: 0; width: 60px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; font-family: 'IBM Plex Mono'; border-radius: 2px 0 0 2px; z-index: 5; pointer-events: none; transition: top 0.1s linear; }
        .current-price-line { background: var(--up); color: white; }
        .lock-price-line { background: var(--primary); color: black; z-index: 4; }
        .dashed-line { position: absolute; left: 0; right: 60px; height: 1px; pointer-events: none; z-index: 4; }
        
        /* BOTTOM SHEET */
        #confirmSheet { position: fixed; bottom: 0; left: 0; right: 0; background: #1e232e; border-radius: 20px 20px 0 0; z-index: 100; transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); border-top: 1px solid #2d3442; padding-bottom: env(safe-area-inset-bottom); }
        #confirmSheet.active { transform: translateY(0); }
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .sheet-overlay.active { opacity: 1; pointer-events: auto; }

        /* HISTORY DOTS */
        .history-grid { display: grid; grid-template-rows: repeat(5, 1fr); grid-auto-flow: column; gap: 3px; height: 100%; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #232836; transition: transform 0.3s; }
        .dot.win-up { background: var(--up); } .dot.win-down { background: var(--down); }
        .dot.new { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* TOAST */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #1e232e; border: 1px solid #374151; padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200; opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* POPUP RESULT */
        #resultPopup { pointer-events: none; opacity: 0; transform: scale(0.8); transition: all 0.3s; }
        #resultPopup.active { opacity: 1; transform: scale(1); }
    </style>
</head>
<body class="flex flex-col">

    <!-- OVERLAYS -->
    <div id="pageLoader" class="fixed inset-0 bg-[#0b0f19] z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 bg-yellow-400 rounded flex items-center justify-center font-black text-2xl text-black animate-spin">C</div>
        <div class="mt-4 text-gray-500 text-xs font-mono font-bold tracking-widest">LOADING MARKET...</div>
    </div>
    <div id="toast"><i class="fa-solid fa-circle-check"></i><span id="toastMsg" class="text-sm font-bold text-white">Message</span></div>
    <div class="sheet-overlay" onclick="closeSheet()"></div>

    <!-- HEADER -->
    <header class="h-14 bg-[#13161f] border-b border-[#232836] flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-yellow-400 rounded flex items-center justify-center font-black text-lg text-black">C</div>
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-sm">BTC/USDT</span>
                    <span class="bg-green-500/10 text-green-500 text-[9px] px-1.5 py-0.5 rounded border border-green-500/20 font-bold">LIVE</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3 bg-[#1e232e] py-1 pl-4 pr-1 rounded-full border border-[#2d3442]">
            <div class="text-right">
                <div class="text-[9px] text-gray-400 font-bold">LIVE ACCOUNT</div>
                <div id="balanceDisplay" class="text-sm font-mono font-bold text-white">---</div>
            </div>
            <div class="w-7 h-7 bg-yellow-400 rounded-full flex items-center justify-center text-black font-bold text-xs"><i class="fa-solid fa-wallet"></i></div>
        </div>
    </header>

    <!-- CHART AREA -->
    <div id="chart-container">
        <!-- Canvas -->
        <canvas id="mainChart"></canvas>
        
        <!-- Overlay Elements -->
        <div id="timerBadge" class="absolute top-4 left-1/2 -translate-x-1/2 bg-[#1e232e]/80 backdrop-blur border border-[#374151] px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg">
            <div id="timerIcon" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
            <span id="timerText" class="font-mono font-bold text-xl text-yellow-400">00</span>
            <span id="phaseLabel" class="text-[9px] font-bold text-gray-400 uppercase tracking-wider ml-1">ORDER</span>
        </div>

        <!-- Price Labels (Dynamic) -->
        <div id="currentPriceLabel" class="price-line current-price-line" style="top: 0px;">0.00</div>
        <div id="currentPriceLine" class="dashed-line border-t border-dashed border-[#0ECB81]" style="top: 0px;"></div>

        <div id="lockPriceLabel" class="price-line lock-price-line hidden" style="top: 0px;">0.00</div>
        <div id="lockPriceLine" class="dashed-line border-t border-dashed border-yellow-400 hidden" style="top: 0px;"></div>

        <!-- Result Popup -->
        <div id="resultPopup" class="absolute inset-0 flex items-center justify-center z-50">
            <div id="popupCard" class="bg-[#1e232e] border border-[#2d3442] p-6 rounded-2xl shadow-2xl text-center min-w-[200px]">
                <div id="popupIcon" class="text-4xl mb-2">üèÜ</div>
                <div id="popupTitle" class="text-lg font-black uppercase mb-1 text-green-500">WIN</div>
                <div id="popupAmount" class="text-3xl font-mono font-bold text-white">+$0.00</div>
            </div>
        </div>
    </div>

    <!-- HISTORY BAR -->
    <div class="h-14 bg-[#13161f] border-t border-[#232836] shrink-0 flex items-center px-4 justify-between">
        <div class="flex flex-col gap-0.5">
            <span class="text-[9px] text-gray-500 font-bold uppercase">K·∫øt qu·∫£ phi√™n</span>
            <div class="flex gap-2 text-[10px] font-mono font-bold">
                <span class="text-up">UP: <span id="countUp">0</span></span>
                <span class="text-down">DOWN: <span id="countDown">0</span></span>
            </div>
        </div>
        <div class="h-8 flex gap-1 items-center overflow-hidden w-2/3 justify-end" id="historyContainer">
            <!-- Dynamic Dots -->
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="bg-[#13161f] border-t border-[#232836] p-4 pb-safe shrink-0 z-30">
        <!-- Input & Quick Select -->
        <div class="mb-4">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-[10px] text-gray-400 font-bold">S·ªê TI·ªÄN C∆Ø·ª¢C ($)</span>
                <span class="text-[10px] text-green-500 font-bold">L√£i su·∫•t: 95%</span>
            </div>
            <div class="flex gap-2 h-12">
                <div class="relative flex-1">
                    <input type="number" id="betInput" value="10" class="w-full h-full bg-[#0b0f19] border border-[#2d3442] rounded-lg pl-4 pr-4 font-mono font-bold text-xl text-white focus:border-yellow-400 focus:outline-none transition-colors text-center" oninput="updateProfitUI()">
                </div>
                <button onclick="changeAmount(-5)" class="w-12 bg-[#1e232e] border border-[#2d3442] rounded-lg text-gray-400 hover:text-white hover:border-gray-500"><i class="fa-solid fa-minus"></i></button>
                <button onclick="changeAmount(5)" class="w-12 bg-[#1e232e] border border-[#2d3442] rounded-lg text-gray-400 hover:text-white hover:border-gray-500"><i class="fa-solid fa-plus"></i></button>
            </div>
            <!-- Quick Select Buttons -->
            <div class="grid grid-cols-5 gap-2 mt-2">
                <button class="quick-btn py-1.5" onclick="quickSet(5)">$5</button>
                <button class="quick-btn py-1.5" onclick="quickSet(10)">$10</button>
                <button class="quick-btn py-1.5" onclick="quickSet(20)">$20</button>
                <button class="quick-btn py-1.5" onclick="quickSet(50)">$50</button>
                <button class="quick-btn py-1.5 text-yellow-500" onclick="quickSet('all')">ALL</button>
            </div>
        </div>

        <!-- Buy/Sell Buttons -->
        <div class="flex gap-3 h-14 relative">
            <!-- Progress Bar Overlay (for 30s wait) -->
            <div id="lockedOverlay" class="absolute inset-0 bg-[#0b0f19]/80 backdrop-blur-[1px] z-20 rounded-xl hidden flex items-center justify-center border border-[#2d3442]">
                <div class="flex flex-col items-center">
                    <i class="fa-solid fa-lock text-gray-500 text-xl mb-1"></i>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">ƒê√≥ng l·ªánh</span>
                </div>
            </div>

            <button id="btnSell" onclick="openSheet('down')" class="flex-1 btn-trade bg-[#F6465D] rounded-xl flex items-center justify-between px-4 shadow-[0_4px_0_#b9283a] group">
                <div class="flex flex-col items-start">
                    <span class="font-black text-lg text-white">B√ÅN</span>
                    <span class="text-[9px] text-white/70 font-mono font-bold opacity-0 group-hover:opacity-100 transition-opacity">Price < Lock</span>
                </div>
                <i class="fa-solid fa-arrow-trend-down text-2xl text-white/40"></i>
            </button>
            
            <button id="btnBuy" onclick="openSheet('up')" class="flex-1 btn-trade bg-[#0ECB81] rounded-xl flex items-center justify-between px-4 shadow-[0_4px_0_#0aa869] group">
                <div class="flex flex-col items-start">
                    <span class="font-black text-lg text-white">MUA</span>
                    <span class="text-[9px] text-white/70 font-mono font-bold opacity-0 group-hover:opacity-100 transition-opacity">Price > Lock</span>
                </div>
                <i class="fa-solid fa-arrow-trend-up text-2xl text-white/40"></i>
            </button>
        </div>
    </div>

    <!-- BOTTOM SHEET CONFIRMATION -->
    <div id="confirmSheet">
        <div class="p-4">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-6 opacity-30"></div>
            
            <div class="flex justify-between items-center mb-6">
                <div class="text-gray-400 text-xs font-bold uppercase">X√°c nh·∫≠n l·ªánh</div>
                <div class="text-white text-lg font-black uppercase flex items-center gap-2">
                    <span id="sheetType" class="text-up">MUA (UP)</span>
                </div>
            </div>

            <div class="bg-[#0b0f19] rounded-xl p-4 border border-[#2d3442] mb-6 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-500 text-xs font-bold">S·ªë ti·ªÅn c∆∞·ª£c</span>
                    <span class="text-white font-mono font-bold" id="sheetAmount">$10.00</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500 text-xs font-bold">L·ª£i nhu·∫≠n d·ª± ki·∫øn (+95%)</span>
                    <span class="text-green-500 font-mono font-bold" id="sheetProfit">+$9.50</span>
                </div>
                <div class="w-full h-[1px] bg-[#2d3442]"></div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500 text-xs font-bold">S·ªë d∆∞ sau c∆∞·ª£c</span>
                    <span class="text-gray-300 font-mono font-bold" id="sheetBalance">$9,990.00</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeSheet()" class="w-1/3 h-12 rounded-xl bg-[#2d3442] text-white font-bold text-sm">H·ªßy</button>
                <button onclick="confirmBet()" id="btnConfirmFinal" class="w-2/3 h-12 rounded-xl bg-yellow-400 text-black font-black text-sm shadow-lg shadow-yellow-400/20 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> ƒê·∫∂T L·ªÜNH NGAY
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, updateDoc, getDoc, onSnapshot, addDoc, collection, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU",
            authDomain: "btccoinbig.firebaseapp.com",
            projectId: "btccoinbig",
            storageBucket: "btccoinbig.firebasestorage.app",
            messagingSenderId: "116892525933",
            appId: "1:116892525933:web:04b0da25f3f933ce162664"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- STATE & CONFIG ---
        const CONFIG = {
            basePrice: 42000,
            volatility: 0.2, // ƒê·ªô bi·∫øn ƒë·ªông
            chartPaddingRight: 80,
            candleWidth: 15,
            candleSpacing: 6,
            gridLines: 5
        };

        const state = {
            user: null,
            balance: 0,
            candles: [], // { time, open, high, low, close }
            history: [],
            currentPrice: CONFIG.basePrice,
            lockPrice: 0,
            phase: 'order', // 'order' (0-29s) or 'wait' (30-59s)
            bet: null, // { type: 'up'|'down', amount: 10, locked: false }
            pendingBet: null, // Temp for sheet
            serverTimeOffset: 0
        };

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;
                // Listener for balance updates
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        state.balance = docSnap.data().balance || 0;
                        updateBalanceUI();
                    }
                });
                
                // Check for active bet in LocalStorage to restore state if reload
                const savedBet = localStorage.getItem('activeBet');
                if (savedBet) {
                    const parsed = JSON.parse(savedBet);
                    // Only restore if it belongs to current minute
                    const now = new Date();
                    if (now.getTime() < parsed.expiry) {
                        state.bet = parsed;
                        showToast('info', `ƒê√£ kh√¥i ph·ª•c l·ªánh: $${state.bet.amount} ${state.bet.type.toUpperCase()}`);
                    } else {
                        localStorage.removeItem('activeBet');
                    }
                }

                // Remove Loader
                setTimeout(() => {
                    document.getElementById('pageLoader').style.opacity = '0';
                    setTimeout(() => document.getElementById('pageLoader').style.display = 'none', 500);
                }, 1000);
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- MARKET LOGIC (THE BRAIN) ---
        function initMarket() {
            // Generate initial history candles
            const now = Date.now();
            const roundedNow = now - (now % 60000);
            let price = CONFIG.basePrice;
            
            for (let i = 30; i >= 0; i--) {
                const time = roundedNow - (i * 60000);
                const open = price;
                const close = price + (Math.random() - 0.5) * 50;
                state.candles.push({
                    time: time,
                    open: open,
                    close: close,
                    high: Math.max(open, close) + Math.random() * 10,
                    low: Math.min(open, close) - Math.random() * 10
                });
                price = close;
            }
            state.currentPrice = price;
            
            // Start loops
            requestAnimationFrame(renderLoop);
            setInterval(logicLoop, 1000); // 1s sync
            setInterval(priceLoop, 50);   // Fast price movement
        }

        function priceLoop() {
            // Simulate price movement with noise and trend
            const noise = (Math.random() - 0.5) * 4;
            let trend = 0;
            
            // Tiny trend towards lock price if in wait phase (Visual drama)
            if (state.phase === 'wait' && state.lockPrice > 0) {
                // Not rigging, just visual smoothing
                // logic handled by server/random in reality
            }

            state.currentPrice += noise;
            
            // Update current candle LIVE
            const lastCandle = state.candles[state.candles.length - 1];
            lastCandle.close = state.currentPrice;
            if (state.currentPrice > lastCandle.high) lastCandle.high = state.currentPrice;
            if (state.currentPrice < lastCandle.low) lastCandle.low = state.currentPrice;

            // UI Label Update (Smooth CSS transition handles position)
            updatePriceLines();
        }

        function logicLoop() {
            const now = new Date();
            const seconds = now.getSeconds();
            const ms = now.getMilliseconds();
            
            // 1. PHASE MANAGEMENT
            if (seconds < 30) {
                if (state.phase !== 'order') setPhase('order');
                document.getElementById('timerText').innerText = (30 - seconds).toString().padStart(2, '0');
                document.getElementById('timerBadge').className = "absolute top-4 left-1/2 -translate-x-1/2 bg-[#1e232e]/80 backdrop-blur border border-[#374151] px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg";
                document.getElementById('timerIcon').className = "w-2 h-2 rounded-full bg-yellow-400 animate-pulse";
                document.getElementById('timerText').className = "font-mono font-bold text-xl text-yellow-400";
            } else {
                if (state.phase !== 'wait') setPhase('wait');
                document.getElementById('timerText').innerText = (60 - seconds).toString().padStart(2, '0');
                // Change timer style for waiting
                document.getElementById('timerBadge').className = "absolute top-4 left-1/2 -translate-x-1/2 bg-[#1e232e]/80 backdrop-blur border border-blue-500/50 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg";
                document.getElementById('timerIcon').className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";
                document.getElementById('timerText').className = "font-mono font-bold text-xl text-blue-500";
            }

            // 2. CANDLE MANAGEMENT (SNAP TO GRID)
            const currentMinuteStart = now.getTime() - (now.getTime() % 60000);
            const lastCandle = state.candles[state.candles.length - 1];

            if (lastCandle.time !== currentMinuteStart) {
                // NEW MINUTE -> NEW CANDLE
                processResult(state.candles[state.candles.length - 1]); // Process result of the CLOSED candle
                
                // Create new candle starting at current price
                const newCandle = {
                    time: currentMinuteStart,
                    open: state.currentPrice,
                    close: state.currentPrice,
                    high: state.currentPrice,
                    low: state.currentPrice
                };
                state.candles.push(newCandle);
                
                // Cleanup old candles to save memory
                if (state.candles.length > 50) state.candles.shift();
            }
        }

        function setPhase(newPhase) {
            state.phase = newPhase;
            const lockOverlay = document.getElementById('lockedOverlay');
            const lockLine = document.getElementById('lockPriceLine');
            const lockLabel = document.getElementById('lockPriceLabel');

            if (newPhase === 'wait') {
                // ENTER WAIT PHASE (30s)
                state.lockPrice = state.currentPrice;
                lockOverlay.classList.remove('hidden');
                
                // Show Lock Line
                lockLabel.innerText = state.lockPrice.toFixed(2);
                lockLabel.classList.remove('hidden');
                lockLine.classList.remove('hidden');
                
                document.getElementById('phaseLabel').innerText = "WAITING";
            } else {
                // ENTER ORDER PHASE (00s) -> Reset
                state.lockPrice = 0;
                lockOverlay.classList.add('hidden');
                
                // Hide Lock Line
                lockLabel.classList.add('hidden');
                lockLine.classList.add('hidden');
                
                document.getElementById('phaseLabel').innerText = "ORDER";
            }
        }

        async function processResult(closedCandle) {
            // Determine Win/Lose based on CLOSED price vs LOCK price (snapshot at 30s)
            // Note: In real BO, result compares Close Price vs Lock Price (at 30s)
            // Here we use the stored lockPrice
            
            // Logic: History Dot
            const isUp = closedCandle.close >= closedCandle.open;
            addHistoryDot(isUp ? 'up' : 'down');

            // Logic: Bet Result
            if (state.bet) {
                // If we have a bet, check result
                // Compare Close Price vs The Lock Price we stored in the bet
                const result = state.currentPrice >= state.bet.lockPrice ? 'up' : 'down';
                const userWin = state.bet.type === result;

                if (userWin) {
                    const profit = state.bet.amount * 1.95;
                    showResultPopup(true, profit - state.bet.amount); // Show profit
                    // Update Firebase
                    try {
                        await updateDoc(doc(db, "users", state.user.uid), {
                            balance: increment(profit)
                        });
                    } catch(e) console.error(e);
                } else {
                    showResultPopup(false, state.bet.amount);
                }
                
                // Clear bet
                state.bet = null;
                localStorage.removeItem('activeBet');
                updateBalanceUI();
            }
        }

        // --- DRAWING ENGINE (CANVAS) ---
        const canvas = document.getElementById('mainChart');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            width = canvas.parentElement.offsetWidth;
            height = canvas.parentElement.offsetHeight;
            canvas.width = width * window.devicePixelRatio;
            canvas.height = height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        window.addEventListener('resize', resize);
        resize();

        function renderLoop() {
            ctx.clearRect(0, 0, width, height);

            // 1. Calculate Grid
            const visibleCandles = Math.floor((width - CONFIG.chartPaddingRight) / (CONFIG.candleWidth + CONFIG.candleSpacing));
            
            // Auto Scale Y-Axis based on visible candles
            let min = Infinity, max = -Infinity;
            const startIndex = Math.max(0, state.candles.length - visibleCandles);
            
            for (let i = startIndex; i < state.candles.length; i++) {
                if (state.candles[i].low < min) min = state.candles[i].low;
                if (state.candles[i].high > max) max = state.candles[i].high;
            }
            
            // Padding for Y-axis
            const range = max - min;
            min -= range * 0.2;
            max += range * 0.2;
            const pixelPerUnit = height / (max - min);

            // 2. Draw Grid Lines
            ctx.strokeStyle = '#232836';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<CONFIG.gridLines; i++) {
                const y = height * (i / CONFIG.gridLines);
                ctx.moveTo(0, y); ctx.lineTo(width, y);
            }
            ctx.stroke();

            // 3. Draw Candles (End-Anchored: Draw from right to left)
            const candleFullWidth = CONFIG.candleWidth + CONFIG.candleSpacing;
            
            // Start drawing from the 'current' position (right side)
            // Logic: The last candle (active) is always fixed at `width - padding`
            
            state.candles.forEach((c, index) => {
                if (index < startIndex) return; // Skip off-screen

                // X Calculation: 
                // Index from end: (state.candles.length - 1 - index)
                const offsetFromRight = (state.candles.length - 1 - index) * candleFullWidth;
                const x = width - CONFIG.chartPaddingRight - offsetFromRight - (CONFIG.candleWidth/2);

                const yOpen = height - (c.open - min) * pixelPerUnit;
                const yClose = height - (c.close - min) * pixelPerUnit;
                const yHigh = height - (c.high - min) * pixelPerUnit;
                const yLow = height - (c.low - min) * pixelPerUnit;

                const isUp = c.close >= c.open;
                const color = isUp ? '#0ECB81' : '#F6465D';

                // Wick
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x + CONFIG.candleWidth/2, yHigh);
                ctx.lineTo(x + CONFIG.candleWidth/2, yLow);
                ctx.stroke();

                // Body
                ctx.fillStyle = color;
                // Ensure at least 1px height
                const bodyHeight = Math.max(1, Math.abs(yClose - yOpen));
                ctx.fillRect(x, Math.min(yOpen, yClose), CONFIG.candleWidth, bodyHeight);
            });

            // 4. Update DOM Overlay Positions (Price Lines)
            const yCurrent = height - (state.currentPrice - min) * pixelPerUnit;
            const domLine = document.getElementById('currentPriceLine');
            const domLabel = document.getElementById('currentPriceLabel');
            
            // Constrain to canvas height
            const safeY = Math.max(0, Math.min(height - 20, yCurrent - 10));
            
            domLine.style.top = (safeY + 10) + 'px';
            domLabel.style.top = safeY + 'px';
            domLabel.innerText = state.currentPrice.toFixed(2);

            if (state.lockPrice > 0) {
                const yLock = height - (state.lockPrice - min) * pixelPerUnit;
                const safeLockY = Math.max(0, Math.min(height - 20, yLock - 10));
                
                document.getElementById('lockPriceLine').style.top = (safeLockY + 10) + 'px';
                document.getElementById('lockPriceLabel').style.top = safeLockY + 'px';
            }

            requestAnimationFrame(renderLoop);
        }

        function updatePriceLines() {
            // Handled in RenderLoop for sync
        }

        // --- UI ACTIONS & BETTING ---
        window.changeAmount = (delta) => {
            const el = document.getElementById('betInput');
            let val = parseFloat(el.value) || 0;
            val = Math.max(1, val + delta);
            el.value = val;
            updateProfitUI();
        }

        window.quickSet = (val) => {
            const el = document.getElementById('betInput');
            if (val === 'all') {
                el.value = Math.floor(state.balance);
            } else {
                el.value = val;
            }
            updateProfitUI();
        }

        window.updateProfitUI = () => {
            // Updated in bottom sheet dynamic opening
        }

        window.openSheet = (type) => {
            if (state.phase !== 'order') {
                showToast('error', 'Vui l√≤ng ch·ªù phi√™n ti·∫øp theo');
                return;
            }
            if (state.bet) {
                showToast('error', 'B·∫°n ƒë√£ ƒë·∫∑t c∆∞·ª£c phi√™n n√†y r·ªìi');
                return;
            }
            
            const amount = parseFloat(document.getElementById('betInput').value);
            if (amount > state.balance) {
                showToast('error', 'S·ªë d∆∞ kh√¥ng ƒë·ªß');
                return;
            }
            if (amount < 1) {
                showToast('error', 'C∆∞·ª£c t·ªëi thi·ªÉu $1');
                return;
            }

            // Setup Pending Bet
            state.pendingBet = { type, amount };

            // Update Sheet UI
            document.getElementById('sheetType').innerText = type === 'up' ? 'MUA (UP)' : 'B√ÅN (DOWN)';
            document.getElementById('sheetType').className = type === 'up' ? 'text-up font-black text-xl' : 'text-down font-black text-xl';
            document.getElementById('sheetAmount').innerText = `$${amount.toLocaleString()}`;
            document.getElementById('sheetProfit').innerText = `+$${(amount * 0.95).toLocaleString()}`;
            document.getElementById('sheetBalance').innerText = `$${(state.balance - amount).toLocaleString()}`;
            
            document.querySelector('.sheet-overlay').classList.add('active');
            document.getElementById('confirmSheet').classList.add('active');
        }

        window.closeSheet = () => {
            document.querySelector('.sheet-overlay').classList.remove('active');
            document.getElementById('confirmSheet').classList.remove('active');
            state.pendingBet = null;
        }

        window.confirmBet = async () => {
            if (!state.pendingBet) return;
            const btn = document.getElementById('btnConfirmFinal');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêANG X·ª¨ L√ù...';
            
            try {
                const amount = state.pendingBet.amount;
                
                // Optimistic Update
                state.balance -= amount;
                updateBalanceUI();
                
                // Firebase Update
                await updateDoc(doc(db, "users", state.user.uid), {
                    balance: increment(-amount),
                    betToday: increment(amount)
                });

                // Lock the bet
                state.bet = {
                    type: state.pendingBet.type,
                    amount: amount,
                    // Save lock time details to survive reload
                    expiry: new Date().getTime() + (60000 - (new Date().getTime() % 60000)),
                    lockPrice: 0 // Will be set at 30s mark by logic (in real server app this is handled by backend)
                };
                // NOTE: In this client-sim, we set lockPrice when phase changes. 
                // We'll trust logicLoop to compare correctly.
                
                localStorage.setItem('activeBet', JSON.stringify(state.bet));

                showToast('success', 'ƒê·∫∑t l·ªánh th√†nh c√¥ng');
                closeSheet();
            } catch (error) {
                console.error(error);
                showToast('error', 'L·ªói k·∫øt n·ªëi');
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> ƒê·∫∂T L·ªÜNH NGAY';
            }
        }

        function updateBalanceUI() {
            document.getElementById('balanceDisplay').innerText = `$${state.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        }

        // --- HELPER UI ---
        function showToast(type, msg) {
            const t = document.getElementById('toast');
            const i = t.querySelector('i');
            document.getElementById('toastMsg').innerText = msg;
            
            if (type === 'error') {
                i.className = 'fa-solid fa-circle-exclamation text-[#F6465D] text-lg mr-2';
                t.style.border = '1px solid #F6465D';
            } else if (type === 'success') {
                i.className = 'fa-solid fa-circle-check text-[#0ECB81] text-lg mr-2';
                t.style.border = '1px solid #0ECB81';
            } else {
                i.className = 'fa-solid fa-circle-info text-[#FCD535] text-lg mr-2';
                t.style.border = '1px solid #FCD535';
            }
            
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function addHistoryDot(result) {
            const container = document.getElementById('historyContainer');
            // Check if we need a new column? simple implementation: clear and rebuild or just grid
            // For this UI, we just render random dots for demo plus the new one
            
            // Logic: Create grid layout
            if (container.children.length === 0) {
                 const grid = document.createElement('div');
                 grid.className = 'history-grid';
                 container.appendChild(grid);
                 // Fill dummy
                 for(let i=0; i<60; i++) {
                     const d = document.createElement('div');
                     d.className = 'dot';
                     grid.appendChild(d);
                 }
            }

            const grid = container.querySelector('.history-grid');
            const dots = grid.querySelectorAll('.dot');
            
            // Shift colors left (simplified history visualization)
            for(let i=0; i<dots.length-1; i++) {
                dots[i].className = dots[i+1].className;
            }
            const last = dots[dots.length-1];
            last.className = `dot win-${result} new`;

            // Update Counters
            const upCount = parseInt(document.getElementById('countUp').innerText);
            const downCount = parseInt(document.getElementById('countDown').innerText);
            if (result === 'up') document.getElementById('countUp').innerText = upCount + 1;
            else document.getElementById('countDown').innerText = downCount + 1;
        }

        function showResultPopup(isWin, amount) {
            const p = document.getElementById('resultPopup');
            const card = document.getElementById('popupCard');
            const title = document.getElementById('popupTitle');
            const amt = document.getElementById('popupAmount');
            const icon = document.getElementById('popupIcon');

            if (isWin) {
                card.style.borderColor = '#0ECB81';
                card.style.boxShadow = '0 0 30px rgba(14, 203, 129, 0.2)';
                title.innerText = "WIN";
                title.className = "text-lg font-black uppercase mb-1 text-green-500";
                amt.innerText = `+$${amount.toFixed(2)}`;
                amt.className = "text-3xl font-mono font-bold text-green-500";
                icon.innerText = "üèÜ";
            } else {
                card.style.borderColor = '#F6465D';
                card.style.boxShadow = '0 0 30px rgba(246, 70, 93, 0.2)';
                title.innerText = "LOSS";
                title.className = "text-lg font-black uppercase mb-1 text-red-500";
                amt.innerText = `-$${amount.toFixed(2)}`;
                amt.className = "text-3xl font-mono font-bold text-red-500";
                icon.innerText = "üí∏";
            }

            p.classList.add('active');
            setTimeout(() => {
                p.classList.remove('active');
            }, 3000);
        }

        // Start
        initMarket();
    </script>
</body>
</html>

