<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- CHẶN ZOOM TUYỆT ĐỐI -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crownex ID - Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: '#FCD535',
                        brandHover: '#e5c02b',
                        dark: '#0b0f19',
                    },
                    animation: {
                        'slide-down': 'slideDown 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CẤU HÌNH CỐT LÕI --- */
        html, body {
            height: 100%; overflow: hidden; touch-action: pan-x pan-y;
            -webkit-text-size-adjust: 100%;
            background-color: #050505;
        }
        /* Input 16px để chặn iOS zoom */
        input, select, textarea { font-size: 16px !important; }

        /* NỀN ĐỘNG */
        .bg-animate {
            background: radial-gradient(circle at 50% 0%, #1a1f2e 0%, #000000 85%);
            position: absolute; inset: 0; z-index: -1;
        }
        .orb {
            position: absolute; width: 180px; height: 180px; background: #FCD535;
            filter: blur(90px); opacity: 0.15; top: -40px; left: 50%; transform: translateX(-50%);
        }

        /* CARD STYLE - CỐ ĐỊNH PHẦN TRÊN */
        .glass-panel {
            background: rgba(20, 24, 30, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            border-radius: 20px;
            width: 100%; max-width: 340px;
            position: relative; overflow: hidden;
            /* Không dùng transition height để tránh giật phần header */
            transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* INPUT STYLE - COMPACT */
        .input-box { position: relative; margin-bottom: 12px; }
        .input-control {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 12px 12px 12px 40px; border-radius: 10px;
            transition: all 0.2s;
        }
        .input-control:focus {
            border-color: #FCD535; background: rgba(0,0,0,0.6); outline: none;
        }
        .input-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: #555; font-size: 16px; transition: 0.2s;
        }
        .input-control:focus ~ .input-icon { color: #FCD535; }

        /* SMOOTH TABS */
        .tab-wrapper {
            display: flex; position: relative; background: rgba(255,255,255,0.03);
            border-radius: 10px; padding: 4px; margin-bottom: 20px;
        }
        .tab-item {
            flex: 1; text-align: center; padding: 8px; font-size: 12px; font-weight: 700;
            color: #6b7280; cursor: pointer; z-index: 10; transition: color 0.3s;
        }
        .tab-item.active { color: #000; }
        
        /* Sliding Pill Indicator */
        .tab-indicator {
            position: absolute; top: 4px; left: 4px; bottom: 4px; width: calc(50% - 4px);
            background: #FCD535; border-radius: 8px; transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 2px 10px rgba(252, 213, 53, 0.3); z-index: 1;
        }

        /* BUTTON */
        .btn-action {
            width: 100%; background: linear-gradient(180deg, #FCD535 0%, #e0bc28 100%);
            color: #000; font-weight: 800; padding: 12px; border-radius: 10px;
            font-size: 13px; text-transform: uppercase; margin-top: 8px;
            box-shadow: 0 4px 15px rgba(252, 213, 53, 0.15); transition: transform 0.1s;
        }
        .btn-action:active { transform: scale(0.97); }

        /* FORM SLIDING ANIMATION */
        .forms-container {
            position: relative;
            height: 280px; /* Chiều cao mặc định */
            overflow: hidden;
            transition: height 0.3s ease-in-out;
        }

        .auth-form {
            position: absolute; top: 0; left: 0; width: 100%;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0; transform: translateX(40px); pointer-events: none;
        }

        .auth-form.active {
            opacity: 1; transform: translateX(0); pointer-events: auto; z-index: 20;
        }
        
        .auth-form.slide-left { transform: translateX(-40px); opacity: 0; }
        .auth-form.slide-right { transform: translateX(40px); opacity: 0; }

        /* TOAST & LOADING */
        #toast-box {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 9999; width: 85%; max-width: 300px;
        }
        .toast-msg {
            background: rgba(20, 20, 25, 0.95); backdrop-filter: blur(10px);
            padding: 10px 14px; border-radius: 8px; display: flex; align-items: center; gap: 10px;
            margin-bottom: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-left: 3px solid transparent; animation: slideDown 0.3s forwards;
        }
        @keyframes slideDown { from { opacity:0; transform:translateY(-15px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<!-- QUAN TRỌNG: items-start và pt-[100px] giúp form cố định vị trí phía trên -->
<body class="flex justify-center items-start pt-[12vh]">

    <div class="bg-animate"></div>
    <div class="orb"></div>
    <div id="toast-box"></div>

    <!-- LOADING SCREEN -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#050505]">
        <div class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loadingText" class="text-brand font-bold text-xs tracking-[3px] animate-pulse">ĐANG KẾT NỐI...</p>
        <button onclick="forceLogout()" class="mt-8 px-4 py-1.5 border border-gray-800 rounded-full text-[10px] text-gray-500 hover:bg-gray-900 transition-colors">
            Khởi động lại
        </button>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="p-4 w-full flex justify-center animate-slide-down">
        <div class="glass-panel p-5">
            
            <!-- HEADER -->
            <div class="text-center mb-5">
                <div class="w-10 h-10 bg-brand rounded-lg mx-auto flex items-center justify-center text-xl font-black text-black mb-2 shadow-[0_0_15px_rgba(252,213,53,0.3)]">C</div>
                <h1 class="text-lg font-bold text-white tracking-wide">CROWNEX ID</h1>
            </div>

            <!-- TABS -->
            <div class="tab-wrapper">
                <div class="tab-indicator" id="tabIndicator"></div>
                <div class="tab-item active" id="tabLoginBtn" onclick="switchTab('login')">ĐĂNG NHẬP</div>
                <div class="tab-item" id="tabRegBtn" onclick="switchTab('register')">ĐĂNG KÝ</div>
            </div>

            <!-- FORMS CONTAINER -->
            <div class="forms-container" id="formsWrapper">
                
                <!-- LOGIN FORM -->
                <form id="formLogin" class="auth-form active">
                    <div class="input-box">
                        <input type="text" id="loginUser" class="input-control" placeholder="Tên đăng nhập" required autocomplete="off">
                        <i class="fa-regular fa-user input-icon"></i>
                    </div>
                    <div class="input-box">
                        <input type="password" id="loginPass" class="input-control" placeholder="Mật khẩu" required>
                        <i class="fa-solid fa-lock input-icon"></i>
                        <i class="fa-regular fa-eye absolute right-3.5 top-1/2 -translate-y-1/2 text-gray-500 cursor-pointer p-1 text-sm" onclick="togglePass('loginPass')"></i>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="col-span-2 relative">
                            <input type="text" id="loginCaptcha" class="input-control font-mono uppercase tracking-wider text-center" placeholder="MÃ XÁC NHẬN" required maxlength="4" style="padding-left:10px;">
                        </div>
                        <canvas id="canvasLogin" width="80" height="46" class="w-full h-[46px] rounded-lg border border-gray-700/50 cursor-pointer bg-black/20" onclick="drawCaptcha('login')"></canvas>
                    </div>

                    <button type="submit" id="btnLogin" class="btn-action">
                        TRUY CẬP <i class="fa-solid fa-arrow-right ml-1"></i>
                    </button>
                </form>

                <!-- REGISTER FORM -->
                <form id="formRegister" class="auth-form slide-right">
                    <div class="input-box">
                        <input type="text" id="regUser" class="input-control" placeholder="Tên đăng nhập" required autocomplete="off">
                        <i class="fa-solid fa-user-tag input-icon"></i>
                    </div>
                    <div class="input-box">
                        <input type="tel" id="regPhone" class="input-control" placeholder="Số điện thoại" required pattern="[0-9]*">
                        <i class="fa-solid fa-phone input-icon"></i>
                    </div>
                    <div class="input-box">
                        <input type="password" id="regPass" class="input-control" placeholder="Mật khẩu (6+)" required minlength="6">
                        <i class="fa-solid fa-lock input-icon"></i>
                        <i class="fa-regular fa-eye absolute right-3.5 top-1/2 -translate-y-1/2 text-gray-500 cursor-pointer p-1 text-sm" onclick="togglePass('regPass')"></i>
                    </div>
                    <div class="input-box">
                        <input type="text" id="regName" class="input-control" placeholder="Họ tên hiển thị" required autocomplete="off">
                        <i class="fa-solid fa-id-card input-icon"></i>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="col-span-2 relative">
                            <input type="text" id="regCaptcha" class="input-control font-mono uppercase tracking-wider text-center" placeholder="MÃ XÁC NHẬN" required maxlength="4" style="padding-left:10px;">
                        </div>
                        <canvas id="canvasReg" width="80" height="46" class="w-full h-[46px] rounded-lg border border-gray-700/50 cursor-pointer bg-black/20" onclick="drawCaptcha('reg')"></canvas>
                    </div>

                    <button type="submit" id="btnReg" class="btn-action">
                        ĐĂNG KÝ NGAY
                    </button>
                </form>

            </div>

            <div class="text-center mt-4">
                <p class="text-[9px] text-gray-600 font-mono tracking-wider">BẢO MẬT BỞI FIREBASE &copy; 2024</p>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CHẶN ZOOM
        document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
        document.addEventListener('touchmove', function (event) { if (event.scale !== 1) { event.preventDefault(); } }, { passive: false });
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) { event.preventDefault(); }
            lastTouchEnd = now;
        }, false);

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU",
            authDomain: "btccoinbig.firebaseapp.com",
            projectId: "btccoinbig",
            storageBucket: "btccoinbig.firebasestorage.app",
            messagingSenderId: "116892525933",
            appId: "1:116892525933:web:04b0da25f3f933ce162664",
            measurementId: "G-7Q1GBFNQ37"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const EMAIL_PREFIX = "@crownex.com";

        let captchaCodes = { login: '', reg: '' };
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadingText.innerText = "ĐANG TẢI DỮ LIỆU...";
                try {
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        saveAndGo(docSnap.data(), user.uid);
                    } else {
                        const fixData = {
                            username: user.email.split('@')[0],
                            phone: "0000000000",
                            fullName: user.displayName || "Thành viên",
                            balance: 0,
                            createdAt: new Date().toISOString(),
                            role: 'user',
                            status: 'active'
                        };
                        await setDoc(docRef, fixData);
                        saveAndGo(fixData, user.uid);
                    }
                } catch (e) {
                    toast('error', 'Lỗi kết nối!');
                    loadingText.innerText = "MẤT KẾT NỐI MẠNG";
                }
            } else {
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
            }
        });

        function saveAndGo(data, uid) {
            data.uid = uid;
            localStorage.setItem('crownex_user_info', JSON.stringify(data));
            window.location.href = "game.html";
        }

        // --- SMOOTH TAB LOGIC ---
        window.switchTab = (tab) => {
            const loginForm = document.getElementById('formLogin');
            const regForm = document.getElementById('formRegister');
            const indicator = document.getElementById('tabIndicator');
            const btnLogin = document.getElementById('tabLoginBtn');
            const btnReg = document.getElementById('tabRegBtn');
            const wrapper = document.getElementById('formsWrapper');

            if (tab === 'login') {
                indicator.style.transform = 'translateX(0)';
                btnLogin.classList.add('active'); btnReg.classList.remove('active');
                
                loginForm.classList.remove('slide-left', 'slide-right');
                loginForm.classList.add('active');
                
                regForm.classList.remove('active', 'slide-left');
                regForm.classList.add('slide-right');

                wrapper.style.height = '280px';
                drawCaptcha('login');
            } else {
                indicator.style.transform = 'translateX(calc(100% + 8px))';
                btnLogin.classList.remove('active'); btnReg.classList.add('active');

                regForm.classList.remove('slide-right', 'slide-left');
                regForm.classList.add('active');

                loginForm.classList.remove('active', 'slide-right');
                loginForm.classList.add('slide-left');

                wrapper.style.height = '370px';
                drawCaptcha('reg');
            }
        };
        // Reset height on load
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('formsWrapper').style.height = '280px';
        });

        window.togglePass = (id) => {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        };

        window.forceLogout = () => {
            signOut(auth).then(() => { localStorage.clear(); location.reload(); });
        };

        // --- LOGIN ---
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnLogin');
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value;
            const cap = document.getElementById('loginCaptcha').value.toUpperCase();

            if (cap !== captchaCodes.login) {
                toast('error', 'Mã xác nhận sai!');
                drawCaptcha('login');
                document.getElementById('loginCaptcha').value = '';
                return;
            }

            btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            try {
                await signInWithEmailAndPassword(auth, user + EMAIL_PREFIX, pass);
            } catch (err) {
                toast('error', 'Sai thông tin đăng nhập!');
                btn.disabled = false; btn.innerHTML = `TRUY CẬP <i class="fa-solid fa-arrow-right ml-1"></i>`;
                drawCaptcha('login');
            }
        });

        // --- REGISTER ---
        document.getElementById('formRegister').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnReg');
            const user = document.getElementById('regUser').value.trim().toLowerCase().replace(/\s/g,'');
            const phone = document.getElementById('regPhone').value.trim();
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value.trim();
            const cap = document.getElementById('regCaptcha').value.toUpperCase();

            if (cap !== captchaCodes.reg) {
                toast('error', 'Mã xác nhận sai!');
                drawCaptcha('reg');
                return;
            }

            btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            try {
                const cred = await createUserWithEmailAndPassword(auth, user + EMAIL_PREFIX, pass);
                await updateProfile(cred.user, { displayName: name });
                const newData = {
                    username: user, phone: phone, fullName: name,
                    balance: 0, createdAt: new Date().toISOString(), role: 'user', status: 'active'
                };
                await setDoc(doc(db, "users", cred.user.uid), newData);
            } catch (err) {
                let msg = 'Lỗi đăng ký!';
                if(err.code.includes('email-already-in-use')) msg = 'Tên tài khoản đã tồn tại!';
                if(err.code.includes('weak-password')) msg = 'Mật khẩu quá ngắn!';
                toast('error', msg);
                btn.disabled = false; btn.innerHTML = `ĐĂNG KÝ NGAY`;
                drawCaptcha('reg');
            }
        });

        // --- UTILS ---
        window.drawCaptcha = (type) => {
            const canvas = document.getElementById(type === 'login' ? 'canvasLogin' : 'canvasReg');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = ''; for(let i=0; i<4; i++) code += chars[Math.floor(Math.random()*chars.length)];
            captchaCodes[type] = code;

            ctx.font = 'bold 20px JetBrains Mono';
            ctx.textBaseline = 'middle'; ctx.textAlign = 'center';
            for(let i=0; i<4; i++) {
                ctx.save();
                ctx.translate(15 + i*16, 23);
                ctx.rotate((Math.random()-0.5)*0.5);
                ctx.fillStyle = '#FCD535';
                ctx.fillText(code[i], 0, 0);
                ctx.restore();
            }
        };

        window.toast = (type, msg) => {
            const box = document.getElementById('toast-box');
            const div = document.createElement('div');
            const color = type === 'error' ? '#ef4444' : '#10b981';
            const icon = type === 'error' ? 'fa-circle-xmark' : 'fa-circle-check';
            div.className = 'toast-msg';
            div.style.borderLeftColor = color;
            div.innerHTML = `<i class="fa-solid ${icon}" style="color:${color}"></i><span class="text-white font-bold text-xs">${msg}</span>`;
            box.appendChild(div);
            setTimeout(() => { div.remove(); }, 2500);
        };

        drawCaptcha('login');
    </script>
</body>
</html>


