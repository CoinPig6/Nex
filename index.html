<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- CHẶN ZOOM TUYỆT ĐỐI -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crownex ID - Đăng nhập</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* CSS CHẶN ZOOM & UI */
        html, body { touch-action: pan-x pan-y; overscroll-behavior: none; height: 100%; overflow: hidden; }
        body { 
            background-color: #0b0f19; color: #d1d5db; font-family: 'Roboto', sans-serif;
            display: flex; align-items: center; justify-content: center;
            background-image: radial-gradient(circle at 50% 0%, #171b26 0%, #0b0f19 70%);
        }
        .tech-border {
            background: #13161f; border: 1px solid #2a2e39; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 16px; overflow: hidden;
            width: 100%; max-width: 400px; position: relative; z-index: 10;
        }
        .input-group { position: relative; margin-bottom: 16px; }
        .input-field {
            width: 100%; background: #0b0f19; border: 1px solid #2d3442;
            color: #fff; padding: 12px 12px 12px 40px; border-radius: 8px;
            font-size: 16px !important; transition: all 0.2s;
        }
        .input-field:focus { border-color: #FCD535; outline: none; }
        .input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; }
        .input-field:focus + .input-icon { color: #FCD535; }
        .btn-auth {
            width: 100%; background: #FCD535; color: #111; font-weight: 800;
            padding: 12px; border-radius: 8px; font-size: 14px; text-transform: uppercase;
            transition: all 0.2s; box-shadow: 0 4px 15px rgba(252, 213, 53, 0.2);
        }
        .btn-auth:hover { filter: brightness(1.1); }
        .btn-auth:disabled { background: #4b5563; color: #9ca3af; cursor: not-allowed; }
        .tab-btn { flex: 1; text-align: center; padding: 12px; font-size: 13px; font-weight: bold; color: #6b7280; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: #FCD535; border-bottom-color: #FCD535; background: rgba(252, 213, 53, 0.05); }
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #1e232e; border: 1px solid #2d3442; padding: 10px 20px;
            border-radius: 50px; display: flex; align-items: center; gap: 10px;
            z-index: 100; opacity: 0; transition: all 0.4s;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #captchaCanvasLogin, #captchaCanvasReg {
            background: #1e232e; border-radius: 6px; cursor: pointer; border: 1px solid #2d3442;
        }
        
        /* MÀN HÌNH CHỜ KIỂM TRA ĐĂNG NHẬP */
        #authCheckingOverlay {
            position: fixed; inset: 0; background: #0b0f19; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>
    <!-- LOADING OVERLAY: Hiển thị khi đang kiểm tra đăng nhập cũ -->
    <div id="authCheckingOverlay">
        <div class="w-16 h-16 rounded bg-[#FCD535] flex items-center justify-center text-black font-bold text-3xl mb-4 animate-bounce">C</div>
        <div class="text-[#FCD535] font-bold tracking-widest text-sm"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>ĐANG KIỂM TRA BẢO MẬT...</div>
    </div>

    <div id="toast"><i class="fa-solid fa-circle-exclamation"></i><span id="toastMsg" class="text-sm font-bold text-white"></span></div>

    <div class="tech-border fade-in mx-4">
        <div class="p-6 pb-0 flex flex-col items-center">
            <div class="w-12 h-12 rounded bg-[#FCD535] flex items-center justify-center text-black font-bold text-2xl rounded-bl-none shadow-lg mb-3">C</div>
            <h1 class="text-xl font-black text-white">CROWNEX ID</h1>
            <p class="text-xs text-gray-500 font-bold uppercase mt-1">Hệ thống bảo mật V3.0</p>
        </div>
        <div class="flex border-b border-[#232836] mt-6">
            <div class="tab-btn active" id="tabLoginBtn">ĐĂNG NHẬP</div>
            <div class="tab-btn" id="tabRegBtn">ĐĂNG KÝ</div>
        </div>
        <div class="p-6">
            <!-- LOGIN FORM -->
            <form id="formLogin" class="fade-in">
                <div class="input-group">
                    <input type="text" id="loginUser" class="input-field" placeholder="Tên đăng nhập" required>
                    <i class="fa-solid fa-user input-icon"></i>
                </div>
                <div class="input-group">
                    <input type="password" id="loginPass" class="input-field" placeholder="Mật khẩu" required>
                    <i class="fa-solid fa-lock input-icon"></i>
                    <i class="fa-regular fa-eye absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 cursor-pointer" id="eyeLogin"></i>
                </div>
                <!-- Captcha Login -->
                <div class="input-group grid grid-cols-3 gap-2">
                    <div class="col-span-2 relative">
                        <input type="text" id="loginCaptcha" class="input-field" placeholder="Mã xác nhận" required maxlength="4">
                        <i class="fa-solid fa-shield-halved input-icon"></i>
                    </div>
                    <canvas id="captchaCanvasLogin" width="100" height="48"></canvas>
                </div>

                <button type="submit" class="btn-auth" id="btnLogin">ĐĂNG NHẬP <i class="fa-solid fa-arrow-right ml-2"></i></button>
            </form>

            <!-- REGISTER FORM -->
            <form id="formRegister" class="hidden fade-in">
                <!-- 1. Tên đăng nhập -->
                <div class="input-group">
                    <input type="text" id="regUser" class="input-field" placeholder="Tên đăng nhập" required>
                    <i class="fa-solid fa-user-tag input-icon"></i>
                </div>
                <!-- 2. Số điện thoại -->
                <div class="input-group">
                    <input type="tel" id="regPhone" class="input-field" placeholder="Số điện thoại" required pattern="[0-9]*">
                    <i class="fa-solid fa-phone input-icon"></i>
                </div>
                <!-- 3. Mật khẩu -->
                <div class="input-group">
                    <input type="password" id="regPass" class="input-field" placeholder="Mật khẩu (6+ ký tự)" required minlength="6">
                    <i class="fa-solid fa-lock input-icon"></i>
                </div>
                <!-- 4. Họ và tên -->
                <div class="input-group">
                    <input type="text" id="regName" class="input-field" placeholder="Họ và tên" required>
                    <i class="fa-solid fa-id-card input-icon"></i>
                </div>
                <!-- 5. Mã xác nhận -->
                <div class="input-group grid grid-cols-3 gap-2">
                    <div class="col-span-2 relative">
                        <input type="text" id="regCaptcha" class="input-field" placeholder="Mã xác nhận" required maxlength="4">
                        <i class="fa-solid fa-shield-halved input-icon"></i>
                    </div>
                    <canvas id="captchaCanvasReg" width="100" height="48"></canvas>
                </div>

                <button type="submit" class="btn-auth" id="btnReg">ĐĂNG KÝ NGAY</button>
            </form>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Thêm onAuthStateChanged vào import
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAyYO8ZhxVvOImOZveUJULkK8tdcSxo7pU",
            authDomain: "btccoinbig.firebaseapp.com",
            projectId: "btccoinbig",
            storageBucket: "btccoinbig.firebasestorage.app",
            messagingSenderId: "116892525933",
            appId: "1:116892525933:web:04b0da25f3f933ce162664",
            measurementId: "G-7Q1GBFNQ37"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const EMAIL_PREFIX = "@crownex.com"; 

        const formLogin = document.getElementById('formLogin');
        const formReg = document.getElementById('formRegister');
        const btnLogin = document.getElementById('btnLogin');
        const btnReg = document.getElementById('btnReg');
        const overlay = document.getElementById('authCheckingOverlay');

        // --- 1. TỰ ĐỘNG KIỂM TRA ĐĂNG NHẬP ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ĐÃ ĐĂNG NHẬP -> Chuyển hướng ngay lập tức
                console.log("User đã đăng nhập:", user.email);
                
                // (Tùy chọn) Cập nhật lại localStorage nếu cần thiết
                // const docSnap = await getDoc(doc(db, "users", user.uid));
                // if (docSnap.exists()) localStorage.setItem('crownex_user_info', JSON.stringify(docSnap.data()));

                window.location.href = "game.html";
            } else {
                // CHƯA ĐĂNG NHẬP -> Tắt màn hình chờ để hiện form
                // Thêm timeout nhỏ để hiệu ứng mượt hơn
                setTimeout(() => {
                    overlay.style.opacity = '0';
                    setTimeout(() => { overlay.style.display = 'none'; }, 300); // Ẩn hoàn toàn sau khi mờ dần
                }, 500);
            }
        });

        let captchaLoginCode = "";
        let captchaRegCode = "";

        // --- INIT CAPTCHA ---
        drawCaptcha('login');
        drawCaptcha('reg');
        document.getElementById('captchaCanvasLogin').onclick = () => drawCaptcha('login');
        document.getElementById('captchaCanvasReg').onclick = () => drawCaptcha('reg');

        // TAB SWITCH
        document.getElementById('tabLoginBtn').onclick = () => {
            document.getElementById('tabLoginBtn').classList.add('active');
            document.getElementById('tabRegBtn').classList.remove('active');
            formLogin.classList.remove('hidden'); formReg.classList.add('hidden');
            drawCaptcha('login');
        };
        document.getElementById('tabRegBtn').onclick = () => {
            document.getElementById('tabLoginBtn').classList.remove('active');
            document.getElementById('tabRegBtn').classList.add('active');
            formLogin.classList.add('hidden'); formReg.classList.remove('hidden');
            drawCaptcha('reg');
        };
        document.getElementById('eyeLogin').onclick = function() {
            const el = document.getElementById('loginPass');
            el.type = el.type === 'password' ? 'text' : 'password';
        };

        // --- LOGIN LOGIC ---
        formLogin.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value;
            const captcha = document.getElementById('loginCaptcha').value.toUpperCase();

            // 1. Check Captcha
            if(captcha !== captchaLoginCode) {
                showToast('error', 'Mã xác nhận sai!');
                drawCaptcha('login');
                document.getElementById('loginCaptcha').value = '';
                return;
            }
            
            btnLogin.disabled = true;
            btnLogin.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ĐANG XỬ LÝ...';

            try {
                const email = username + EMAIL_PREFIX;
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                
                // Lấy thông tin
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    userData.uid = user.uid;
                    localStorage.setItem('crownex_user_info', JSON.stringify(userData));
                }

                showToast('success', 'Đăng nhập thành công!');
                setTimeout(() => { window.location.href = "game.html"; }, 1000);

            } catch (error) {
                console.error(error);
                showToast('error', 'Sai tên đăng nhập hoặc mật khẩu!');
                btnLogin.disabled = false;
                btnLogin.innerHTML = 'ĐĂNG NHẬP <i class="fa-solid fa-arrow-right ml-2"></i>';
                drawCaptcha('login');
            }
        });

        // --- REGISTER LOGIC ---
        formReg.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('regUser').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const pass = document.getElementById('regPass').value;
            const fullname = document.getElementById('regName').value.trim();
            const captcha = document.getElementById('regCaptcha').value.toUpperCase();

            // 1. Check Captcha
            if(captcha !== captchaRegCode) {
                showToast('error', 'Mã xác nhận sai!');
                drawCaptcha('reg');
                document.getElementById('regCaptcha').value = '';
                return;
            }

            btnReg.disabled = true;
            btnReg.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ĐANG TẠO...';

            try {
                const email = username + EMAIL_PREFIX;
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;

                await updateProfile(user, { displayName: fullname });
                
                await setDoc(doc(db, "users", user.uid), {
                    username: username,
                    phone: phone,
                    fullName: fullname,
                    balance: 1000, 
                    createdAt: new Date().toISOString()
                });

                showToast('success', 'Đăng ký thành công! Đang chuyển hướng...');
                
                document.getElementById('formRegister').reset(); 
                document.getElementById('loginUser').value = username; 
                
                setTimeout(() => {
                    document.getElementById('tabLoginBtn').click(); 
                }, 1500);

            } catch (error) {
                let msg = "Lỗi đăng ký!";
                if(error.code === 'auth/email-already-in-use') msg = "Tên đăng nhập đã tồn tại!";
                if(error.code === 'auth/weak-password') msg = "Mật khẩu quá yếu (tối thiểu 6 ký tự)!";
                showToast('error', msg);
                drawCaptcha('reg');
            } finally {
                btnReg.disabled = false;
                btnReg.innerHTML = 'ĐĂNG KÝ NGAY';
            }
        });

        // --- UTILS ---
        function showToast(type, msg) {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            document.getElementById('toastMsg').innerText = msg;
            icon.className = type === 'error' ? 'fa-solid fa-circle-exclamation text-[#F6465D]' : 'fa-solid fa-circle-check text-[#0ECB81]';
            toast.style.borderColor = type === 'error' ? '#F6465D' : '#0ECB81';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function drawCaptcha(type) {
            const canvasId = type === 'login' ? 'captchaCanvasLogin' : 'captchaCanvasReg';
            const canvas = document.getElementById(canvasId);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            const chars = '23456789ABCDEFGHJKLMNPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 4; i++) code += chars[Math.floor(Math.random() * chars.length)];

            if(type === 'login') captchaLoginCode = code; else captchaRegCode = code;

            ctx.fillStyle = '#1e232e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Noise
            for(let i=0; i<5; i++) {
                ctx.strokeStyle = `rgba(255, 255, 255, 0.1)`;
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.stroke();
            }

            ctx.font = 'bold 22px "IBM Plex Mono"';
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';
            
            const charWidth = canvas.width / 4;
            for(let i=0; i<4; i++) {
                ctx.save();
                const x = (i * charWidth) + (charWidth/2);
                const y = canvas.height / 2;
                const angle = (Math.random() - 0.5) * 0.4;
                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.fillStyle = '#FCD535';
                ctx.fillText(code[i], 0, 0);
                ctx.restore();
            }
        }
    </script>
</body>
</html>

